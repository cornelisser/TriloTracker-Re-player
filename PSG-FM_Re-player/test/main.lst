Sjasm Z80 Assembler v0.42b8 - www.xl2s.tk             [2020.09.05 - 21:54:42]

main.asm
Errors: 0

       1   00:0000                      	defpage	0,0x4000, 0x8000		; page 0 contains main code + far call routines
       2   00:0000                      
       3   00:0000                      ; -----------------------------
       4   00:0000                      ; TT-replayer example
       5   00:0000                      ; 
       6   00:0000                      ; This example plays compiled PSG+SCC songs
       7   00:0000                      ; ------------------------------
       8   00:0000                      
       9   00:0000                      ;	include	".\code\variables.asm"
      10   00:0000                      
      11   00:0000  (00)                	page 0
      12   00:4000                      	code page 0
      13   00:4000                      	
      14   00:4000                      	org	04000h
      15   00:4000  41 42               	db	041h,042h
      16   00:4002  10 40               	dw	initmain
      17   00:4004                      	dz 	'TTDEMO'
      17   00:4004  54 54 44 45 4D 4F 00 
      18   00:400B  00 (5)              	ds	5
      19   00:4010                      		
      20   00:4010                      initmain:
      21   00:4010                      
      22   00:4010                      ;	ei
      23   00:4010                      ;	halt
      24   00:4010  F3                  	di
      25   00:4011                      		
      26   00:4011                      ;; set pages and subslot
      27   00:4011                      ;;
      28   00:4011  CD 38 01            	call    0x138
      29   00:4014  0F                  	rrca
      30   00:4015  0F                  	rrca
      31   00:4016  E6 03               	and     0x03
      32   00:4018  4F                  	ld      c,a
      33   00:4019  06 00               	ld      b,0
      34   00:401B  21 C1 FC            	ld      hl,0xfcc1
      35   00:401E  09                  	add     hl,bc
      36   00:401F  B6                  	or      (hl)
      37   00:4020  47                  	ld      b,a
      38   00:4021  23                  	inc     hl
      39   00:4022  23                  	inc     hl
      40   00:4023  23                  	inc     hl
      41   00:4024  23                  	inc     hl
      42   00:4025  7E                  	ld      a,(hl)
      43   00:4026  E6 0C               	and     0x0c
      44   00:4028  B0                  	or      b
      45   00:4029                          
      46   00:4029  26 80               	ld      h,0x80
      47   00:402B  CD 24 00            	call    0x24        
      48   00:402E                      	
      49   00:402E                      	;clear RAM (first kb only)
      50   00:402E  01 00 04            	ld	bc,1024
      51   00:4031  21 00 C0            	ld	hl,0xc000
      52   00:4034  11 01 C0            	ld	de,0xc001
      53   00:4037                      
      54   00:4037  36 00               	ld	(hl),0
      55   00:4039  ED B0               	ldir	
      56   00:403B                      
      57   00:403B                      	;--- place replayer on hook
      58   00:403B  3E C3               	ld	a,0xc3
      59   00:403D  21 D2 40            	ld	hl,isr
      60   00:4040  32 9A FD            	ld	(0xFD9A),a
      61   00:4043  22 9B FD            	ld	(0xFD9B),hl	
      62   00:4046                      	
      63   00:4046                      	
      64   00:4046                      	;--- Set speed equalization
      65   00:4046  3A E8 FF            	ld	a,($FFE8)	; get mirror of VDP reg# 9
      66   00:4049  E6 02               	and	2
      67   00:404B  CA 50 40            	jp	z,99f
      68   00:404E  3E FF               	ld	a,-1
      69   00:4050                      99:
      70   00:4050  3C                  	inc	a			; 1 = 60hz
      71   00:4051  32 2F C0            	ld	(equalization_freq),a
      72   00:4054  32 30 C0            	ld	(equalization_cnt),a
      73   00:4057                      	
      74   00:4057                      	;--- Init screen
      75   00:4057  CD A4 42            	call 	init_vdp
      76   00:405A  FB                  	ei
      77   00:405B  76                  	halt
      78   00:405C  F3                  	di
      79   00:405D  CD EA 45            	call	init_font		; set the new font
      80   00:4060                      	
      81   00:4060                      	;--- initialise replayer
      82   00:4060  CD 02 46            	call	replay_init
      83   00:4063                      ;	call	ttsfx_init
      84   00:4063  3E 01               	ld	a,1
      85   00:4065  32 2F C0            	ld	(equalization_freq),a
      86   00:4068  32 30 C0            	ld	(equalization_cnt),a	
      87   00:406B                      	;--- initialise demo song
      88   00:406B  21 0C 56            	ld	hl,demo_song
      89   00:406E  CD 73 46            	call	replay_loadsong
      90   00:4071                      	
      91   00:4071                      	;--- initialise sfx pointers
      92   00:4071                      	
      93   00:4071                      	
      94   00:4071  CD 0C 41            	call	clear_debug
      95   00:4074                      	
      96   00:4074  FB                  	ei
      97   00:4075                      	
      98   00:4075  CD F0 42            	call	clear_screen
      99   00:4078  21 56 01            	ld	hl,80*4+22
     100   00:407B  11 9D 56            	ld	de,TEXT_Title
     101   00:407E  CD 37 43            	call	draw_label
     102   00:4081  21 04 02            	ld	hl,80*6+36
     103   00:4084  11 C2 56            	ld	de,TEXT_Step
     104   00:4087  CD 37 43            	call	draw_label
     105   00:408A  21 84 02            	ld	hl,80*8+4
     106   00:408D  11 C8 56            	ld	de,TEXT_Header_Data
     107   00:4090  CD 37 43            	call	draw_label	
     108   00:4093                      	
     109   00:4093  21 A6 02            	ld	hl,80*8+38
     110   00:4096  11 E0 56            	ld	de,TEXT_Register_Header
     111   00:4099  CD 37 43            	call	draw_label		
     112   00:409C                      
     113   00:409C  21 48 04            	ld 	hl,80*13+56
     114   00:409F  11 03 57            	ld	de,TEXT_Register_Drum
     115   00:40A2  CD 37 43            	call	draw_label	
     116   00:40A5                      
     117   00:40A5  21 A4 05            	ld 	hl,80*18+4
     118   00:40A8  11 14 57            	ld	de,TEXT_Legend_Data
     119   00:40AB  CD 37 43            	call	draw_label	
     120   00:40AE                      
     121   00:40AE                      
     122   00:40AE                      	
     123   00:40AE  AF                  	xor	a
     124   00:40AF  32 FB C4            	ld	(pattern),a
     125   00:40B2                      
     126   00:40B2                      ;	call	replay_pause
     127   00:40B2                      ;	ld	bc,$0001
     128   00:40B2                      ;	call	ttsfx_start
     129   00:40B2                      	
     130   00:40B2                      infinite:
     131   00:40B2  76                  	halt	
     132   00:40B3                      ;	call	register_debug
     133   00:40B3                      
     134   00:40B3                      	
     135   00:40B3                      ;	ld	a,$f0 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     136   00:40B3                      ;	out	(0x99),a
     137   00:40B3                      ;	ld	a,7+128
     138   00:40B3                      ;	out	(0x99),a	
     139   00:40B3                      
     140   00:40B3                      
     141   00:40B3                      	
     142   00:40B3                      ;	ld	a,$f3 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     143   00:40B3                      ;	out	(0x99),a
     144   00:40B3                      ;	ld	a,7+128
     145   00:40B3                      ;	out	(0x99),a
     146   00:40B3                      	
     147   00:40B3                      ;	ld	a,$f0
     148   00:40B3                      ;	out	(0x99),a
     149   00:40B3                      ;	ld	a,7+128
     150   00:40B3                      ;	out	(0x99),a	
     151   00:40B3                      	;--- display debug info
     152   00:40B3  CD 1A 41            	call	debuginfo	
     153   00:40B6  CD 90 41            	call	register_debug
     154   00:40B9  CD 65 41            	call	step_debug
     155   00:40BC                      	
     156   00:40BC                      	
     157   00:40BC                      	
     158   00:40BC                      	
     159   00:40BC                      	;---- Test for space
     160   00:40BC  AF                  	xor	a
     161   00:40BD  CD D8 00            	call	$00D8
     162   00:40C0  A7                  	and	a
     163   00:40C1  CA B2 40            	jp	z,infinite
     164   00:40C4                      
     165   00:40C4                      ;	call	replay_pause
     166   00:40C4  01 01 00            	ld	bc,$0001
     167   00:40C7                      ;	call	ttsfx_start
     168   00:40C7                      ;	ld	a,0
     169   00:40C7                      ;	call	replay_set_SCC_balance
     170   00:40C7                      ;	ld	de,-2
     171   00:40C7                      ;	call	replay_transpose	
     172   00:40C7                      ;	ld	a,32
     173   00:40C7                      ;	call	replay_fade_out
     174   00:40C7                      ;	call	replay_pause
     175   00:40C7                      	; wait_key_release
     176   00:40C7                      99:	
     177   00:40C7  AF                  	xor	a
     178   00:40C8  CD D8 00            	call	$00D8
     179   00:40CB  A7                  	and	a
     180   00:40CC  C2 C7 40            	jp	nz,99b
     181   00:40CF                      	
     182   00:40CF  C3 B2 40            	jp	infinite
     183   00:40D2                      
     184   00:40D2                      	
     185   00:40D2                      	
     186   00:40D2                      isr:
     187   00:40D2  DB 99               	in	a,(0x99)
     188   00:40D4  CD F6 40            	call	write_debug
     189   00:40D7  3E FC               	ld	a,$fc ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     190   00:40D9  D3 99               	out	(0x99),a
     191   00:40DB  3E 87               	ld	a,7+128
     192   00:40DD  D3 99               	out	(0x99),a	
     193   00:40DF  CD 60 50            	call	replay_route		; first outout data
     194   00:40E2  3E F4               	ld	a,$f4 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     195   00:40E4  D3 99               	out	(0x99),a
     196   00:40E6  3E 87               	ld	a,7+128
     197   00:40E8  D3 99               	out	(0x99),a		
     198   00:40EA  CD 21 47            	call	replay_play			; calculate next output
     199   00:40ED  3E F0               	ld	a,$f0 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     200   00:40EF  D3 99               	out	(0x99),a
     201   00:40F1  3E 87               	ld	a,7+128
     202   00:40F3  D3 99               	out	(0x99),a	
     203   00:40F5                      ;	call	ttsfx_play
     204   00:40F5                      
     205   00:40F5                      
     206   00:40F5                      
     207   00:40F5  C9                  	ret
     208   00:40F6                      	
     209   00:40F6                      write_debug:
     210   00:40F6  21 D0 22            	ld 	hl,_PNT+(80*9)
     211   00:40F9  CD B2 45            	call	set_vdpwrite	
     212   00:40FC                      
     213   00:40FC  21 53 C2            	ld 	hl,debug_pnt
     214   00:40FF  3E 08               	ld	a,8
     215   00:4101  0E 98               	ld	c,$98
     216   00:4103                      _wd_loop:
     217   00:4103  06 50               	ld	b,80
     218   00:4105  ED B3               	otir
     219   00:4107                      	
     220   00:4107  3D                  	dec	a
     221   00:4108  C2 03 41            	jp	nz,_wd_loop
     222   00:410B                      
     223   00:410B  C9                  	ret
     224   00:410C                      	
     225   00:410C                      clear_debug:
     226   00:410C  21 53 C2            	ld	hl,debug_pnt
     227   00:410F  11 54 C2            	ld	de,debug_pnt+1
     228   00:4112  36 20               	ld	(hl),32
     229   00:4114  01 7F 02            	ld	bc,(8*80)-1
     230   00:4117  ED B0               	ldir
     231   00:4119  C9                  	ret
     232   00:411A                      
     233   00:411A                      debuginfo:
     234   00:411A                      ;	ld	bc,40
     235   00:411A                      ;	call	clear_TEXT
     236   00:411A                      	
     237   00:411A  06 08               	ld	b,8
     238   00:411C  DD 21 43 C0         	ld	ix,TRACK_Chan1+17
     239   00:4120  11 57 C2            	ld	de,debug_pnt+4
     240   00:4123                      .loop	
     241   00:4123  C5                  	push	bc
     242   00:4124  D5                  	push	de
     243   00:4125                      	
     244   00:4125  3E 09               	ld	a,9
     245   00:4127  90                  	sub	b
     246   00:4128  CD A5 43            	call	draw_decimal
     247   00:412B  13                  	inc	de
     248   00:412C  DD 7E F6            	ld	a,(ix+TRACK_Note)
     249   00:412F  CD 95 43            	call	draw_hex2
     250   00:4132  13                  	inc 	de
     251   00:4133  DD 7E EF            	ld	a,(ix+TRACK_Instrument)
     252   00:4136  CD 95 43            	call	draw_hex2
     253   00:4139  13                  	inc 	de
     254   00:413A  DD 7E F8            	ld	a,(ix+TRACK_Voice)
     255   00:413D  CD 95 43            	call	draw_hex2
     256   00:4140  13                  	inc 	de	
     257   00:4141  DD 7E F7            	ld	a,(ix+TRACK_Volume)
     258   00:4144  CD 95 43            	call	draw_hex2
     259   00:4147  13                  	inc 	de
     260   00:4148  DD 7E F0            	ld	a,(ix+TRACK_Command)
     261   00:414B  CD 95 43            	call	draw_hex2	
     262   00:414E  13                  	inc 	de
     263   00:414F                      
     264   00:414F  EB                  	ex	de,hl
     265   00:4150  DD 46 F9            	ld	b,(ix+TRACK_Flags)
     266   00:4153  CD 39 42            	call 	debug_flags
     267   00:4156                      
     268   00:4156                      
     269   00:4156                      	; next line
     270   00:4156  E1                  	pop	hl
     271   00:4157  11 50 00            	ld	de,80
     272   00:415A  19                  	add	hl,de
     273   00:415B  EB                  	ex	de,hl
     274   00:415C                      	
     275   00:415C                      
     276   00:415C                      	;--- Next track
     277   00:415C  01 27 00            	ld	bc,TRACK_REC_SIZE
     278   00:415F  DD 09               	add	ix,bc
     279   00:4161                      	
     280   00:4161  C1                  	pop	bc
     281   00:4162  10 BF               	djnz	.loop
     282   00:4164  C9                  	ret
     283   00:4165                      
     284   00:4165                      step_debug:
     285   00:4165  01 07 00            	ld	bc,7
     286   00:4168  CD 2D 42            	call	clear_TEXT
     287   00:416B  2A 1D C0            	ld	hl,(replay_orderpointer)
     288   00:416E  11 13 56            	ld	de,demo_song+7
     289   00:4171  AF                  	xor 	a
     290   00:4172  ED 52               	sbc	hl,de
     291   00:4174  29                  	add	hl,hl		;X2
     292   00:4175  29                  	add	hl,hl		;X4	
     293   00:4176  29                  	add	hl,hl		;X8
     294   00:4177  29                  	add	hl,hl		;X16
     295   00:4178  7C                  	ld	a,h
     296   00:4179  3D                  	dec	a
     297   00:417A  21 4F C2            	ld	hl,debug_pointer1
     298   00:417D  77                  	ld	(hl),a
     299   00:417E  11 D3 C4            	ld	de,TEXT_Chan
     300   00:4181  CD BC 43            	call	draw_decimal3
     301   00:4184                      	
     302   00:4184  21 09 02            	ld	hl,80*6+41
     303   00:4187  11 D3 C4            	ld	de,TEXT_Chan
     304   00:418A  06 03               	ld	b,3
     305   00:418C  CD 4B 43            	call	draw_label_fast
     306   00:418F  C9                  	ret
     307   00:4190                      	
     308   00:4190                      
     309   00:4190                      register_debug:
     310   00:4190                      ;	ld	bc,7
     311   00:4190                      ;	call	clear_TEXT
     312   00:4190  21 F1 41            	ld	hl,REG_list
     313   00:4193                      	
     314   00:4193                      	;	DRAW PSG Tone vol	
     315   00:4193  FD 2E 03            	ld	iyl,3
     316   00:4196  11 82 C2            	ld 	de,debug_pnt+47
     317   00:4199                      ;	ld	(debug_pointer1),bc
     318   00:4199  CD CA 41            	call	register_debug_loop
     319   00:419C                      
     320   00:419C                      	;	DRAW PSG Noise and mixer	
     321   00:419C  FD 2E 01            	ld	iyl,1
     322   00:419F  11 8B C2            	ld 	de,debug_pnt+56
     323   00:41A2                      ;	ld	(debug_pointer1),bc
     324   00:41A2  CD CA 41            	call	register_debug_loop	
     325   00:41A5                      	
     326   00:41A5                      	;	DRAW PSG Envelop + shape
     327   00:41A5  FD 2E 01            	ld	iyl,1
     328   00:41A8  11 94 C2            	ld 	de,debug_pnt+65
     329   00:41AB                      ;	ld	(debug_pointer1),bc
     330   00:41AB  CD CA 41            	call	register_debug_loop		
     331   00:41AE                      
     332   00:41AE                      	;	DRAW FM Tone Vol	
     333   00:41AE  FD 2E 06            	ld	iyl,6
     334   00:41B1  11 19 C3            	ld 	de,debug_pnt+(80*2)+38
     335   00:41B4                      ;	ld	(debug_pointer1),bc
     336   00:41B4  CD CA 41            	call	register_debug_loop
     337   00:41B7                      	
     338   00:41B7                      	
     339   00:41B7                      	;	DRAW FM Drum macro + percusion
     340   00:41B7  FD 2E 01            	ld	iyl,1
     341   00:41BA  11 1B C4            	ld 	de,debug_pnt+(80*5)+56
     342   00:41BD                      ;	ld	(debug_pointer1),bc
     343   00:41BD  CD CA 41            	call	register_debug_loop
     344   00:41C0                      
     345   00:41C0                      	;	DRAW FM Drum tone + vol
     346   00:41C0  FD 2E 03            	ld	iyl,3
     347   00:41C3  11 24 C4            	ld 	de,debug_pnt+(80*5)+65
     348   00:41C6                      ;	ld	(debug_pointer1),bc
     349   00:41C6  CD CA 41            	call	register_debug_loop
     350   00:41C9                      	
     351   00:41C9  C9                  	ret
     352   00:41CA                      
     353   00:41CA                      register_debug_loop:
     354   00:41CA  D5                  	push 	de
     355   00:41CB                      ;	ld	de,TEXT_Chan
     356   00:41CB  4E                  	ld	c,(hl)
     357   00:41CC  23                  	inc	hl
     358   00:41CD  46                  	ld	b,(hl)
     359   00:41CE  23                  	inc	hl
     360   00:41CF                      	
     361   00:41CF  03                  	inc	bc
     362   00:41D0  0A                  	ld	a,(bc)
     363   00:41D1  0B                  	dec	bc
     364   00:41D2  CD 95 43            	call	draw_hex2		; tone
     365   00:41D5  0A                  	ld	a,(bc)
     366   00:41D6  CD 95 43            	call	draw_hex2
     367   00:41D9                      	
     368   00:41D9  13                  	inc 	de	
     369   00:41DA                      	
     370   00:41DA  4E                  	ld	c,(hl)
     371   00:41DB  23                  	inc	hl
     372   00:41DC  46                  	ld	b,(hl)
     373   00:41DD  23                  	inc	hl	
     374   00:41DE                      	
     375   00:41DE  0A                  	ld	a,(bc)
     376   00:41DF  CD 95 43            	call	draw_hex2		; vol
     377   00:41E2                      	
     378   00:41E2                      	;-- next line
     379   00:41E2  D1                  	pop 	de
     380   00:41E3  3E 50               	ld	a,80
     381   00:41E5  83                  	add	a,e
     382   00:41E6  5F                  	ld	e,a
     383   00:41E7  D2 EB 41            	jp	nc,99f
     384   00:41EA  14                  	inc	d
     385   00:41EB                      99:	
     386   00:41EB  FD 2D               	dec	iyl
     387   00:41ED  C2 CA 41            	jp	nz,register_debug_loop
     388   00:41F0  C9                  	ret
     389   00:41F1                      
     390   00:41F1                      REG_list:
     391   00:41F1  6A C1 72 C1         	dw	PSG_regToneA,PSG_regVOLA
     392   00:41F5  6C C1 73 C1         	dw	PSG_regToneB,PSG_regVOLB
     393   00:41F9  6E C1 74 C1         	dw	PSG_regToneC,PSG_regVOLC
     394   00:41FD  70 C1 71 C1         	dw	PSG_regNOISE,PSG_regMIXER
     395   00:4201  00 00 00 00         	dw	0,0;PSG_regEnvL,PSG_regEnvShape 	
     396   00:4205  78 C1 7C C1         	dw	FM_regToneA,FM_regVOLA 
     397   00:4209  7E C1 82 C1         	dw	FM_regToneB,FM_regVOLB 
     398   00:420D  84 C1 88 C1         	dw	FM_regToneC,FM_regVOLC 
     399   00:4211  8A C1 8E C1         	dw	FM_regToneD,FM_regVOLD 
     400   00:4215  90 C1 94 C1         	dw	FM_regToneE,FM_regVOLE 
     401   00:4219  96 C1 9A C1         	dw	FM_regToneF,FM_regVOLF 
     402   00:421D  BA C1 AE C1         	dw	FM_DRUM_MACRO,FM_DRUM
     403   00:4221  B0 C1 B2 C1         	dw	FM_freqreg1,FM_volreg1
     404   00:4225  B3 C1 B5 C1         	dw	FM_freqreg2,FM_volreg2	
     405   00:4229  B6 C1 B8 C1         	dw	FM_freqreg3,FM_volreg3	
     406   00:422D                      
     407   00:422D                      
     408   00:422D                      
     409   00:422D                      
     410   00:422D                      ; input BC length to clear
     411   00:422D                      clear_TEXT:
     412   00:422D  0B                  	dec	bc
     413   00:422E  21 D3 C4            	ld	hl,TEXT_Chan
     414   00:4231  11 D4 C4            	ld	de,TEXT_Chan+1
     415   00:4234  36 20               	ld	(hl),' '
     416   00:4236  ED B0               	ldir
     417   00:4238  C9                  	ret
     418   00:4239                      
     419   00:4239                      debug_flags:
     420   00:4239  CB 78               	bit	7,b
     421   00:423B  CA 43 42            	jp	z,1f
     422   00:423E  36 46               	ld	(hl),'F'
     423   00:4240  C3 45 42            	jp	2f
     424   00:4243                      1:
     425   00:4243  36 50               	ld	(hl),'P'
     426   00:4245                      	
     427   00:4245                      2:
     428   00:4245  23                  	inc	hl
     429   00:4246  CB 70               	bit	6,b
     430   00:4248  CA 50 42            	jp	z,1f
     431   00:424B  36 56               	ld	(hl),'V'
     432   00:424D  C3 52 42            	jp	2f
     433   00:4250                      1:
     434   00:4250  36 20               	ld	(hl),' '
     435   00:4252                      	
     436   00:4252                      2:	
     437   00:4252  23                  	inc	hl
     438   00:4253  CB 68               	bit	5,b
     439   00:4255  CA 5D 42            	jp	z,1f
     440   00:4258  36 53               	ld	(hl),'S'
     441   00:425A  C3 5F 42            	jp	2f
     442   00:425D                      1:
     443   00:425D  36 20               	ld	(hl),' '
     444   00:425F                      	
     445   00:425F                      2:	
     446   00:425F  23                  	inc	hl
     447   00:4260  CB 60               	bit	4,b
     448   00:4262  C2 6A 42            	jp	nz,1f
     449   00:4265  36 4B               	ld	(hl),'K'
     450   00:4267  C3 6C 42            	jp	2f
     451   00:426A                      1:
     452   00:426A  36 20               	ld	(hl),' '
     453   00:426C                      	
     454   00:426C                      2:	
     455   00:426C  23                  	inc	hl
     456   00:426D  CB 58               	bit	3,b
     457   00:426F  CA 77 42            	jp	z,1f
     458   00:4272  36 43               	ld	(hl),'C'
     459   00:4274  C3 79 42            	jp	2f
     460   00:4277                      1:
     461   00:4277  36 20               	ld	(hl),' '
     462   00:4279                      	
     463   00:4279                      2:	
     464   00:4279  23                  	inc	hl
     465   00:427A  CB 50               	bit	2,b
     466   00:427C  CA 84 42            	jp	z,1f
     467   00:427F  36 45               	ld	(hl),'E'
     468   00:4281  C3 86 42            	jp	2f
     469   00:4284                      1:
     470   00:4284  36 20               	ld	(hl),' '
     471   00:4286                      	
     472   00:4286                      2:	
     473   00:4286  23                  	inc	hl	
     474   00:4287  CB 48               	bit	1,b
     475   00:4289  CA 91 42            	jp	z,1f
     476   00:428C  36 41               	ld	(hl),'A'
     477   00:428E  C3 93 42            	jp	2f
     478   00:4291                      1:
     479   00:4291  36 20               	ld	(hl),' '
     480   00:4293                      	
     481   00:4293                      2:	
     482   00:4293  23                  	inc	hl	
     483   00:4294  CB 40               	bit	0,b
     484   00:4296  CA 9E 42            	jp	z,1f
     485   00:4299  36 4E               	ld	(hl),'N'
     486   00:429B  C3 A0 42            	jp	2f
     487   00:429E                      1:
     488   00:429E  36 20               	ld	(hl),' '
     489   00:42A0                      	
     490   00:42A0                      2:	
     491   00:42A0  23                  	inc	hl		
     492   00:42A1  EB                  	ex	de,hl
     493   00:42A2                      
     494   00:42A2  13                  	inc 	de
     495   00:42A3  C9                  	ret
     496   00:42A4                      
     497   00:42A4                      
     498   00:42A4                      
     499   00:42A4                      
     500   00:42A4                      	
     501   00:42A4                      	; --- init_vdp
     502   00:42A4                      	; 
     503   00:42A4                      	; Initial init of the vdp
     504   00:42A4                      init_vdp:
     505   00:42A4                      
     506   00:42A4  3E 04               	ld	a,00000100b ; Reg#0 [ 0 ][DG ][IE2][IE1][M5 ][M4 ][M3 ][ 0 ]
     507   00:42A6  D3 99               	out	(0x99),a
     508   00:42A8  3E 80               	ld	a,0+128
     509   00:42AA  D3 99               	out	(0x99),a
     510   00:42AC                      
     511   00:42AC  3E 70               	ld	a,01110000b ; Reg#1 [ 0 ][BL ][IE0][M1 ][M2 ][ 0 ][SIZ][MAG]
     512   00:42AE                      
     513   00:42AE  D3 99               	out	(0x99),a
     514   00:42B0  3E 81               	ld	a,1+128
     515   00:42B2  D3 99               	out	(0x99),a	
     516   00:42B4                      
     517   00:42B4  3E 0B               	ld	a,00001011b ; REG#2[ 0 ][A16][A15][A14][A13][A12][ 1 ][ 1 ]  - Pattern layout table
     518   00:42B6                      
     519   00:42B6  D3 99               	out	(0x99),a
     520   00:42B8  3E 82               	ld	a,2+128
     521   00:42BA  D3 99               	out	(0x99),a	
     522   00:42BC                      
     523   00:42BC  3E AF               	ld	a,10101111b ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     524   00:42BE                      
     525   00:42BE  D3 99               	out	(0x99),a
     526   00:42C0  3E 83               	ld	a,3+128
     527   00:42C2  D3 99               	out	(0x99),a	
     528   00:42C4                      	
     529   00:42C4  3E 12               	ld	a,00010010b ; Reg#4 [ 0 ][ 0 ][A16][A15][A14][A13][A12][A11]  - Pattern generator table
     530   00:42C6                      
     531   00:42C6  D3 99               	out	(0x99),a
     532   00:42C8  3E 84               	ld	a,4+128
     533   00:42CA  D3 99               	out	(0x99),a	
     534   00:42CC                      	
     535   00:42CC  3A E8 FF            	ld	a,($FFE8)
     536   00:42CF  F6 80               	or	10000000b ; Reg#9 [LN ][ 0 ][S1 ][S0 ][IL ][EO ][NT ][DC ]
     537   00:42D1  D3 99               	out	(0x99),a
     538   00:42D3  3E 89               	ld	a,9+128
     539   00:42D5  D3 99               	out	(0x99),a	
     540   00:42D7                      
     541   00:42D7                      
     542   00:42D7  3E F0               	ld	a,$f0
     543   00:42D9  D3 99               	out	(0x99),a
     544   00:42DB  3E 87               	ld	a,7+128
     545   00:42DD  D3 99               	out	(0x99),a
     546   00:42DF  3E E1               	ld	a,$e1
     547   00:42E1  D3 99               	out	(0x99),a
     548   00:42E3  3E 8C               	ld	a,12+128
     549   00:42E5  D3 99               	out	(0x99),a
     550   00:42E7  3E F0               	ld	a,0xF0	;reg#13
     551   00:42E9  D3 99               	out	(0x99),a
     552   00:42EB  3E 8D               	ld	a,13+128
     553   00:42ED  D3 99               	out	(0x99),a		
     554   00:42EF                      	
     555   00:42EF                      	
     556   00:42EF                      
     557   00:42EF  C9                  	ret		
     558   00:42F0                      	include	".\screen.asm"
       1.  00:42F0  (00:0082)           _UPLEFT			equ	130
       2.  00:42F0  (00:0081)           _HORIZONTAL			equ	129
       3.  00:42F0  (00:0083)           _UPRIGHT			equ	131
       4.  00:42F0  (00:0080)           _VERTICAL			equ	128
       5.  00:42F0  (00:0087)           _VERTICAL_SMALL		equ	135
       6.  00:42F0  (00:0086)           _VERTICAL_DOUBLE		equ	134
       7.  00:42F0  (00:008B)           _VERTICAL_STEP		equ	139
       8.  00:42F0  (00:00B0)           _ARROWLEFT			equ	176
       9.  00:42F0  (00:00B1)           _ARROWRIGHT			equ	177
      10.  00:42F0  (00:00AE)           _LOOPSIGN			equ	174
      11.  00:42F0  (00:00F1)           _TONE_OFF_SIGN		equ	241
      12.  00:42F0  (00:00F2)           _TONE_ON_SIGN		equ	242
      13.  00:42F0  (00:00F3)           _NOISE_OFF_SIGN		equ	243
      14.  00:42F0  (00:00F4)           _NOISE_ON_SIGN		equ	244
      15.  00:42F0  (00:00F5)           _ENV_OFF_SIGN		equ	245
      16.  00:42F0  (00:00F6)           _ENV_ON_SIGN		equ	246
      17.  00:42F0  (00:00BF)           _CMD_SIGN			equ	6*32-1
      18.  00:42F0  (00:00FE)           _CURSOR			equ	254
      19.  00:42F0                      
      20.  00:42F0  (00:00FC)           MOUSE_CHR			equ 	252
      21.  00:42F0                      
      22.  00:42F0  (00:2000)           _PNT		equ	0x2000		; pnt
      23.  00:42F0  (00:2A00)           _CNT		equ	0x2a00		; cnt
      24.  00:42F0                      
      25.  00:42F0                      
      26.  00:42F0                      
      27.  00:42F0                      ; ==========================================================	
      28.  00:42F0                      	; --- clear_window
      29.  00:42F0                      	; 
      30.  00:42F0                      	; Clears the current screen (pnt and cnt)
      31.  00:42F0                      	;
      32.  00:42F0                      ; ==========================================================	
      33.  00:42F0                      clear_screen:
      34.  00:42F0  21 00 20            	ld 	hl,_PNT
      35.  00:42F3  CD B2 45            	call	set_vdpwrite	
      36.  00:42F6                      
      37.  00:42F6  1E 1B               	ld	e,27
      38.  00:42F8  3E 20               	ld	a,32
      39.  00:42FA  F3                  	di
      40.  00:42FB                      0:	;-- main loop
      41.  00:42FB  01 98 50            	ld	bc,0x5098
      42.  00:42FE                      1:	;--- sub loop
      43.  00:42FE  ED 79               		out	(c),a
      44.  00:4300  10 FC               		djnz 	1b
      45.  00:4302                      	; -- end sub loop
      46.  00:4302  1D                  	dec	e
      47.  00:4303  20 F6               	jr	nz,0b
      48.  00:4305                      	; -- end main loop	
      49.  00:4305                      
      50.  00:4305                      clear_cnt:
      51.  00:4305  21 00 2A            	ld 	hl,_CNT
      52.  00:4308  CD B2 45            	call	set_vdpwrite	
      53.  00:430B                      	
      54.  00:430B  1E 1B               	ld	e,27
      55.  00:430D  3E 00               	ld	a,0
      56.  00:430F  F3                  	di
      57.  00:4310                      0:	;-- main loop
      58.  00:4310  01 98 0A            	ld	bc,0x0a98
      59.  00:4313                      1:	;--- sub loop
      60.  00:4313  ED 79               		out	(c),a
      61.  00:4315  10 FC               		djnz 	1b
      62.  00:4317                      	; -- end sub loop
      63.  00:4317  1D                  	dec	e
      64.  00:4318  20 F6               	jr	nz,0b
      65.  00:431A                      	; -- end main loop	
      66.  00:431A                      	
      67.  00:431A  FB                  	ei
      68.  00:431B  C9                  	ret
      69.  00:431C                      
      70.  00:431C                      ; ==========================================================	
      71.  00:431C                      	; --- clear_files
      72.  00:431C                      	; 
      73.  00:431C                      	; Clears the files area in the file dialog 
      74.  00:431C                      	;
      75.  00:431C                      ; ==========================================================	
      76.  00:431C                      clear_files:
      77.  00:431C                      
      78.  00:431C  06 14               	ld	b,20
      79.  00:431E  21 E0 21            	ld	hl,_PNT+(80*6)
      80.  00:4321                      
      81.  00:4321  C5                  0:	push	bc
      82.  00:4322  E5                  	push	hl
      83.  00:4323  CD B2 45            	call	set_vdpwrite	
      84.  00:4326                      
      85.  00:4326  06 38               	ld	b,56
      86.  00:4328  3E 20               	ld	a,32
      87.  00:432A                      
      88.  00:432A                      1:	;--- sub loop
      89.  00:432A  D3 98               		out	(0x98),a
      90.  00:432C  10 FC               		djnz 	1b
      91.  00:432E                      	; -- end sub loop
      92.  00:432E  E1                  	pop	hl
      93.  00:432F  01 50 00            	ld	bc,80
      94.  00:4332  09                  	add	hl,bc
      95.  00:4333                      	
      96.  00:4333  C1                  	pop	bc
      97.  00:4334  10 EB               	djnz	0b
      98.  00:4336                      
      99.  00:4336  C9                  	ret	
     100.  00:4337                      
     101.  00:4337                      
     102.  00:4337                      
     103.  00:4337                      
     104.  00:4337                      ; ==========================================================	
     105.  00:4337                      	; --- draw_label
     106.  00:4337                      	; 
     107.  00:4337                      	; Draw box 
     108.  00:4337                      	; HL = position in PNT (relative)
     109.  00:4337                      	; DE = pointer to the label text
     110.  00:4337                      ; ==========================================================
     111.  00:4337                      draw_label:
     112.  00:4337  F3                  	di
     113.  00:4338                      ;	ld	a,$f3 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     114.  00:4338                      ;	out	(0x99),a
     115.  00:4338                      ;	ld	a,7+128
     116.  00:4338                      ;	out	(0x99),a	
     117.  00:4338                      
     118.  00:4338                      	
     119.  00:4338  01 00 20            	ld 	bc,_PNT
     120.  00:433B  09                  	add	hl,bc
     121.  00:433C  CD B2 45            	call	set_vdpwrite			
     122.  00:433F                      	
     123.  00:433F                      draw_label_loop:
     124.  00:433F  1A                  	ld	a,(de)
     125.  00:4340  FE 00               	cp	0
     126.  00:4342  28 05               	jr.	z,draw_label_end	
     127.  00:4344  D3 98               	out	(0x98),a
     128.  00:4346                      	
     129.  00:4346  13                  	inc	de
     130.  00:4347  18 F6               	jr.	draw_label_loop
     131.  00:4349                      	
     132.  00:4349                      draw_label_end:
     133.  00:4349                      ;	ld	a,$f0 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     134.  00:4349                      ;	out	(0x99),a
     135.  00:4349                      ;	ld	a,7+128
     136.  00:4349                      ;	out	(0x99),a	
     137.  00:4349  FB                  	ei
     138.  00:434A  C9                  	ret
     139.  00:434B                      
     140.  00:434B                      ; ==========================================================	
     141.  00:434B                      	; --- draw_label_fast
     142.  00:434B                      	; 
     143.  00:434B                      	; Draw box 
     144.  00:434B                      	; HL = position in PNT (relative)
     145.  00:434B                      	; DE = pointer to the label text
     146.  00:434B                      	; BC = number of bytes to copy to vram
     147.  00:434B                      ; ==========================================================
     148.  00:434B                      draw_label_fast:
     149.  00:434B  F3                  	di
     150.  00:434C                      ;	ld	a,$f5 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     151.  00:434C                      ;	out	(0x99),a
     152.  00:434C                      ;	ld	a,7+128
     153.  00:434C                      ;	out	(0x99),a		
     154.  00:434C                      	
     155.  00:434C  C5                  	push	bc
     156.  00:434D  01 00 20            	ld 	bc,_PNT
     157.  00:4350  09                  	add	hl,bc	
     158.  00:4351  CD B2 45            	call	set_vdpwrite	
     159.  00:4354                      			
     160.  00:4354  EB                  	ex	de,hl
     161.  00:4355  C1                  	pop	bc
     162.  00:4356  0E 98               	ld	c,0x98
     163.  00:4358                      	
     164.  00:4358  ED B3               	otir
     165.  00:435A                      		
     166.  00:435A                      		
     167.  00:435A                      ;	ld	a,$f0 ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     168.  00:435A                      ;	out	(0x99),a
     169.  00:435A                      ;	ld	a,7+128
     170.  00:435A                      ;	out	(0x99),a			
     171.  00:435A  FB                  	ei
     172.  00:435B                      	
     173.  00:435B  C9                  	ret
     174.  00:435C                      
     175.  00:435C                      ; ==========================================================	
     176.  00:435C                      	; --- draw_fake_hex_sp
     177.  00:435C                      	; 
     178.  00:435C                      	; Prints the value at an address as 1 digit decimal value 
     179.  00:435C                      	; But value 0 is printed as '.'
     180.  00:435C                      	; Values can be larger than F
     181.  00:435C                      	; A = the value
     182.  00:435C                      	; DE = position (relative) to put the value in PNT
     183.  00:435C                      	; 
     184.  00:435C                      ; ==========================================================
     185.  00:435C                      draw_fake_hex_sp:
     186.  00:435C  A7                  	and	a
     187.  00:435D  20 05               	jr.	nz,0f
     188.  00:435F  3E 2E               	ld	a,'.'
     189.  00:4361  12                  	ld	(de),a
     190.  00:4362  13                  	inc	de
     191.  00:4363  C9                  	ret
     192.  00:4364                      0:	
     193.  00:4364  FE 0A               	cp	10
     194.  00:4366  30 05               	jr.	nc,1f
     195.  00:4368  C6 30               	add	48
     196.  00:436A  12                  	ld	(de),a
     197.  00:436B  13                  	inc	de
     198.  00:436C  C9                  	ret
     199.  00:436D                      1:
     200.  00:436D  C6 37               	add 	55
     201.  00:436F  12                  	ld	(de),a
     202.  00:4370  13                  	inc	de	
     203.  00:4371  C9                  	ret
     204.  00:4372                      	
     205.  00:4372                      ; ==========================================================	
     206.  00:4372                      	; --- draw_fake_hex_sp_small
     207.  00:4372                      	; 
     208.  00:4372                      	; Prints the value at an address as 1 digit decimal value 
     209.  00:4372                      	; But value 0 is printed as '.'
     210.  00:4372                      	; Values can be larger than F
     211.  00:4372                      	; A = the value
     212.  00:4372                      	; DE = position (relative) to put the value in PNT
     213.  00:4372                      	; 
     214.  00:4372                      ; ==========================================================
     215.  00:4372                      draw_fake_hex_sp_small:
     216.  00:4372  A7                  	and	a
     217.  00:4373  20 05               	jr.	nz,0f
     218.  00:4375  3E 2E               	ld	a,'.'
     219.  00:4377  12                  	ld	(de),a
     220.  00:4378  13                  	inc	de
     221.  00:4379  C9                  	ret
     222.  00:437A                      0:	
     223.  00:437A  12                  	ld	(de),a
     224.  00:437B  13                  	inc	de	
     225.  00:437C  C9                  	ret
     226.  00:437D                      	
     227.  00:437D                      	
     228.  00:437D                      	
     229.  00:437D                      ; ==========================================================	
     230.  00:437D                      	; --- draw_hex_sp
     231.  00:437D                      	; 
     232.  00:437D                      	; Prints the value at an address as 1 digit decimal value 
     233.  00:437D                      	; But value 0 is printed as '.'
     234.  00:437D                      	; A = the value
     235.  00:437D                      	; DE = position (relative) to put the value in PNT
     236.  00:437D                      	; 
     237.  00:437D                      ; ==========================================================
     238.  00:437D                      ;draw_hex_sp:
     239.  00:437D                      ;	and	a
     240.  00:437D                      ;	jr.	nz,draw_hex
     241.  00:437D                      ;	ld	a,"."
     242.  00:437D                      ;	ld	(de),a
     243.  00:437D                      ;	inc	de
     244.  00:437D                      ;	ret
     245.  00:437D                      
     246.  00:437D                      ; ==========================================================	
     247.  00:437D                      	; --- draw_hex_sp_small
     248.  00:437D                      	; 
     249.  00:437D                      	; Prints the value at an address as 1 digit decimal value 
     250.  00:437D                      	; But value 0 is printed as '.'
     251.  00:437D                      	; A = the value
     252.  00:437D                      	; DE = position (relative) to put the value in PNT
     253.  00:437D                      	; 
     254.  00:437D                      ; ==========================================================
     255.  00:437D                      draw_hex_sp_small:
     256.  00:437D  A7                  	and	a
     257.  00:437E  20 10               	jr.	nz,draw_hex_small
     258.  00:4380  3E 2E               	ld	a,"."
     259.  00:4382  12                  	ld	(de),a
     260.  00:4383  13                  	inc	de
     261.  00:4384  C9                  	ret
     262.  00:4385                      
     263.  00:4385                      ; ==========================================================	
     264.  00:4385                      	; --- draw_hex2_cmd
     265.  00:4385                      	; 
     266.  00:4385                      	; Prints the value at an address as 2 digit decimal value 
     267.  00:4385                      	; A =  the value
     268.  00:4385                      	; DE = position (relative) to put the value in PNT
     269.  00:4385                      	; 
     270.  00:4385                      	; Changes: AF
     271.  00:4385                      ; ==========================================================
     272.  00:4385                      ;draw_hex2_cmd:
     273.  00:4385                      ;	push	af
     274.  00:4385                      ;	and	0xf0
     275.  00:4385                      ;	rrca
     276.  00:4385                      ;	rrca
     277.  00:4385                      ;	rrca
     278.  00:4385                      ;	rrca	
     279.  00:4385                      ;	call	draw_hex_small
     280.  00:4385                      ;	pop	af
     281.  00:4385                      ;	call	draw_hex_small
     282.  00:4385                      ;	ret
     283.  00:4385                      
     284.  00:4385                      
     285.  00:4385                      ; ==========================================================	
     286.  00:4385                      	; --- draw_hex
     287.  00:4385                      	; 
     288.  00:4385                      	; Prints the value at an address as 1 digit decimal value 
     289.  00:4385                      	; A = the value
     290.  00:4385                      	; DE = position (relative) to put the value in PNT
     291.  00:4385                      	; 
     292.  00:4385                      ; ==========================================================
     293.  00:4385                      draw_hex:
     294.  00:4385  E6 0F               	and	0x0f
     295.  00:4387                      draw_fakehex:	
     296.  00:4387  C6 90               	add	a,0x90
     297.  00:4389  27                  	daa
     298.  00:438A  CE 40               	adc	a,0x40
     299.  00:438C  27                  	daa
     300.  00:438D  12                  	ld	(de),a
     301.  00:438E  13                  	inc	de
     302.  00:438F  C9                  	ret
     303.  00:4390                      	
     304.  00:4390                      	
     305.  00:4390                      ; ==========================================================	
     306.  00:4390                      	; --- draw_hex_small
     307.  00:4390                      	; 
     308.  00:4390                      	; Prints the value at an address as 1 digit decimal value 
     309.  00:4390                      	; A = the value
     310.  00:4390                      	; DE = position (relative) to put the value in PNT
     311.  00:4390                      	; 
     312.  00:4390                      ; ==========================================================
     313.  00:4390                      draw_hex_small:
     314.  00:4390  E6 0F               	and	0x0f
     315.  00:4392  12                  	ld	(de),a
     316.  00:4393  13                  	inc	de
     317.  00:4394  C9                  	ret	
     318.  00:4395                      	
     319.  00:4395                      	
     320.  00:4395                      ; ==========================================================	
     321.  00:4395                      	; --- draw_hex2
     322.  00:4395                      	; 
     323.  00:4395                      	; Prints the value at an address as 2 digit decimal value 
     324.  00:4395                      	; A =  the value
     325.  00:4395                      	; DE = position (relative) to put the value in PNT
     326.  00:4395                      	; 
     327.  00:4395                      	; Changes: AF
     328.  00:4395                      ; ==========================================================
     329.  00:4395                      draw_hex2:
     330.  00:4395  F5                  	push	af
     331.  00:4396  E6 F0               	and	0xf0
     332.  00:4398  0F                  	rrca
     333.  00:4399  0F                  	rrca
     334.  00:439A  0F                  	rrca
     335.  00:439B  0F                  	rrca	
     336.  00:439C  CD 85 43            	call	draw_hex
     337.  00:439F  F1                  	pop	af
     338.  00:43A0  CD 85 43            	call	draw_hex
     339.  00:43A3  C9                  	ret
     340.  00:43A4                      	
     341.  00:43A4                      	
     342.  00:43A4                      	
     343.  00:43A4                      	
     344.  00:43A4                      
     345.  00:43A4                      ; ==========================================================	
     346.  00:43A4                      ; --- conv_decimal
     347.  00:43A4                      ; 
     348.  00:43A4                      ; converts the value at HL into a 2 digit decimal at DE 
     349.  00:43A4                      ; HL = position of the value
     350.  00:43A4                      ; DE = postion  to put the 2 digit value value 
     351.  00:43A4                      ; 
     352.  00:43A4                      ; ==========================================================	
     353.  00:43A4                      
     354.  00:43A4                      conv_decimal:
     355.  00:43A4                      
     356.  00:43A4  7E                  	ld	a,(hl)
     357.  00:43A5                      draw_decimal:
     358.  00:43A5  EB                  	ex	de,hl
     359.  00:43A6                      ;	ld	hl,_dd_tmpstring
     360.  00:43A6                      	
     361.  00:43A6  06 F6               1:	ld	b,-10
     362.  00:43A8  CD B2 43            	call	_dd_Num1
     363.  00:43AB  06 FF               	ld	b,-1
     364.  00:43AD  CD B2 43            	call	_dd_Num1
     365.  00:43B0                      
     366.  00:43B0  EB                  	ex	de,hl
     367.  00:43B1                      ;	ld	hl,_dd_tmpstring
     368.  00:43B1                      
     369.  00:43B1  C9                  	ret	
     370.  00:43B2                      _dd_Num1:	
     371.  00:43B2  0E 2F               	ld	c,"0"-1
     372.  00:43B4                      _dd_Num2:	
     373.  00:43B4  0C                  	inc	c
     374.  00:43B5  80                  	add	a,b
     375.  00:43B6  38 FC               	jr	c,_dd_Num2
     376.  00:43B8  98                  	sbc	a,b
     377.  00:43B9  71                  	ld	(hl),c
     378.  00:43BA  23                  	inc	hl
     379.  00:43BB  C9                  	ret 
     380.  00:43BC                      
     381.  00:43BC                      draw_decimal3:
     382.  00:43BC  EB                  	ex	de,hl
     383.  00:43BD  06 9C               	ld	b,-100
     384.  00:43BF  CD B2 43            	call	_dd_Num1
     385.  00:43C2  18 E2               	jr.	1b
     386.  00:43C4                      	
     387.  00:43C4                      	
     388.  00:43C4                      ;_dd_tmpstring:		
     389.  00:43C4                      ;	db	"XX",0		; temporary + delimiter
     390.  00:43C4                      
     391.  00:43C4                      ; ==========================================================	
     392.  00:43C4                      	; --- draw_box
     393.  00:43C4                      	; 
     394.  00:43C4                      	; Draw box 
     395.  00:43C4                      	; HL = position in PNT (relative)
     396.  00:43C4                      	; D = width
     397.  00:43C4                      	; E = height
     398.  00:43C4                      ; ==========================================================
     399.  00:43C4                      draw_box:
     400.  00:43C4  F3                  	di
     401.  00:43C5                      
     402.  00:43C5  01 00 20            	ld 	bc,_PNT
     403.  00:43C8  09                  	add	hl,bc
     404.  00:43C9  CD B2 45            	call	set_vdpwrite		
     405.  00:43CC                      	
     406.  00:43CC  3E 82               	ld	a,_UPLEFT		; upperleft corner
     407.  00:43CE                      
     408.  00:43CE                      draw_box_loop1:
     409.  00:43CE  42                  	ld	b,d	
     410.  00:43CF                      draw_box_loop0:
     411.  00:43CF                      
     412.  00:43CF                      	; change on last pos
     413.  00:43CF  05                  	dec	b
     414.  00:43D0  20 10               	jr.	nz,1f
     415.  00:43D2  FE 81               	cp	_HORIZONTAL
     416.  00:43D4  20 04               	jr.	nz,0f
     417.  00:43D6  3E 83               	ld	a,_UPRIGHT
     418.  00:43D8  18 08               	jr.	1f
     419.  00:43DA                      0:
     420.  00:43DA  FE 20               	cp	32
     421.  00:43DC  20 04               	jr.	nz,1f
     422.  00:43DE  3E 80               	ld	a,_VERTICAL
     423.  00:43E0  18 00               	jr.	1f
     424.  00:43E2                      	
     425.  00:43E2                      1:
     426.  00:43E2  04                  	inc	b	
     427.  00:43E3                      
     428.  00:43E3                      
     429.  00:43E3                      
     430.  00:43E3  D3 98               	out	(0x98),a
     431.  00:43E5                      	
     432.  00:43E5                      	; changed on pos > 1
     433.  00:43E5  FE 82               	cp	_UPLEFT		; if is upleftcorner thern	
     434.  00:43E7  20 04               	jr.	nz,0f
     435.  00:43E9  3E 81               	ld	a,_HORIZONTAL
     436.  00:43EB  18 08               	jr.	1f
     437.  00:43ED                      0:	
     438.  00:43ED  FE 80               	cp	_VERTICAL	; if is vertical line then space
     439.  00:43EF  20 04               	jr.	nz,0f
     440.  00:43F1  3E 20               	ld	a,32			; space	
     441.  00:43F3  18 00               	jr.	1f
     442.  00:43F5                      0:
     443.  00:43F5                      1:
     444.  00:43F5                      
     445.  00:43F5  10 D8               	djnz	draw_box_loop0
     446.  00:43F7                      
     447.  00:43F7                      
     448.  00:43F7                      	;loop lines
     449.  00:43F7  1D                  	dec	e
     450.  00:43F8  28 0E               	jr.	z,draw_box_end
     451.  00:43FA                      	
     452.  00:43FA  01 50 00            	ld	bc,80
     453.  00:43FD  09                  	add	hl,bc
     454.  00:43FE  01 00 20            	ld 	bc,_PNT
     455.  00:4401  CD B2 45            	call	set_vdpwrite
     456.  00:4404  3E 80               	ld	a,_VERTICAL			
     457.  00:4406  18 C6               	jr.	draw_box_loop1
     458.  00:4408                      
     459.  00:4408                      
     460.  00:4408                      draw_box_end:
     461.  00:4408  FB                  	ei
     462.  00:4409  C9                  	ret
     463.  00:440A                      
     464.  00:440A                      
     465.  00:440A                      
     466.  00:440A                      
     467.  00:440A                      ; ==========================================================	
     468.  00:440A                      	; --- draw_colorbox
     469.  00:440A                      	; 
     470.  00:440A                      	; Draw box 
     471.  00:440A                      	; H = x pos
     472.  00:440A                      	; L = y pos
     473.  00:440A                      	; D = width
     474.  00:440A                      	; E = height
     475.  00:440A                      ; ==========================================================
     476.  00:440A                      draw_colorbox:
     477.  00:440A                      	; --- get maskleft
     478.  00:440A  7C                  	ld	a,h
     479.  00:440B  E6 07               	and	0x07
     480.  00:440D  A7                  	and	a
     481.  00:440E  20 04               	jr.	nz,0f
     482.  00:4410  3E FF               	ld	a,255
     483.  00:4412  18 07               	jr.	1f
     484.  00:4414                      0:	
     485.  00:4414  47                  	ld	b,a
     486.  00:4415  3E FF               	ld	a,255
     487.  00:4417                      	
     488.  00:4417                      _dc_maskleft_loop:
     489.  00:4417  CB 3F               		srl	a
     490.  00:4419  10 FC               		djnz	_dc_maskleft_loop
     491.  00:441B  32 00 00            1:	ld	(cb_maskleft),a
     492.  00:441E                      
     493.  00:441E                      	; --- get maskright (7-(x+(w-1)) & 0x07)	
     494.  00:441E  7A                  	ld	a,d
     495.  00:441F  3D                  	dec	a
     496.  00:4420  84                  	add	h
     497.  00:4421  E6 07               	and	0x07
     498.  00:4423  FE 07               	cp	7
     499.  00:4425  20 04               	jr.	nz,0f
     500.  00:4427  3E 00               	ld	a,0
     501.  00:4429  18 0B               	jr.	1f
     502.  00:442B  47                  0:	ld	b,a
     503.  00:442C  3E 07               	ld	a,7
     504.  00:442E  90                  	sub	b
     505.  00:442F                      
     506.  00:442F                      
     507.  00:442F  47                  	ld	b,a
     508.  00:4430  3E FF               	ld	a,255	
     509.  00:4432                      	
     510.  00:4432                      _dc_maskright_loop:
     511.  00:4432  CB 27               		sla	a
     512.  00:4434  10 FC               		djnz	_dc_maskright_loop
     513.  00:4436  32 01 00            1:	ld	(cb_maskright),a
     514.  00:4439                      	
     515.  00:4439                      	; --- calculate the full cnt bytes to copy
     516.  00:4439  7C                  	ld	a,h
     517.  00:443A  E6 F8               	and	0xf8
     518.  00:443C  47                  	ld	b,a		; store in b the full bytes
     519.  00:443D  7C                  	ld	a,h
     520.  00:443E  82                  	add	d
     521.  00:443F  E6 F8               	and	0xf8
     522.  00:4441  90                  	sub	b
     523.  00:4442  CB 3F CB 3F CB 3F   [3]	srl	a		; divide by 8
     524.  00:4448  3D                  	dec	a		; 255 is begin and end in same byte
     525.  00:4449                      				; 0 is no full bytes to copy
     526.  00:4449                      				; >0 full bytes to copy inbetween masks
     527.  00:4449  32 02 00            	ld	(cb_fullbytes),a	
     528.  00:444C                      
     529.  00:444C                      	; --- Calculate start address
     530.  00:444C  4C                  	ld	c,h		; x in c
     531.  00:444D  45                  	ld	b,l		; y in b
     532.  00:444E  21 00 2A            	ld	hl,_CNT
     533.  00:4451  78                  	ld	a,b
     534.  00:4452  A7                  	and	a
     535.  00:4453  28 09               	jr.	z,0f
     536.  00:4455                      
     537.  00:4455                      _dc_start_loop:
     538.  00:4455  7D                  	ld	a,l
     539.  00:4456  C6 0A               	add	10		; every line adds 10 bytes to the addres
     540.  00:4458  6F                  	ld	l,a
     541.  00:4459  30 01               	jr.	nc,1f
     542.  00:445B  24                  	inc	h
     543.  00:445C                      1:
     544.  00:445C  10 F7               	djnz	_dc_start_loop	
     545.  00:445E                      0:
     546.  00:445E  79                  	ld	a,c		; add the x pos.
     547.  00:445F  E6 F8               	and	0xf8
     548.  00:4461  CB 3F CB 3F CB 3F   [3]	srl	a	
     549.  00:4467  85                  	add	l
     550.  00:4468  6F                  	ld	l,a
     551.  00:4469  30 01               	jr.	nc,1f
     552.  00:446B  24                  	inc	h
     553.  00:446C                      1:
     554.  00:446C                      	; now we have start addres in the cnt in HL
     555.  00:446C  4B                  	ld	c,e	; # lines to plot
     556.  00:446D                      	
     557.  00:446D                      	; --- get way to copy
     558.  00:446D  3A 02 00            	ld	a,(cb_fullbytes)
     559.  00:4470  FE FF               	cp	255
     560.  00:4472  28 46               	jr.	z,_cp_clip_copy
     561.  00:4474                      	
     562.  00:4474                      	; --- 'normal' copy
     563.  00:4474                      _cb_copyloop_main:	
     564.  00:4474  E5                  	push	hl
     565.  00:4475  CD CF 45            	call	set_vdpread
     566.  00:4478  DB 98               	in	a,(0x98)
     567.  00:447A  47                  	ld	b,a
     568.  00:447B  3A 00 00            	ld	a,(cb_maskleft)
     569.  00:447E  B0                  	or	b
     570.  00:447F  47                  	ld	b,a
     571.  00:4480                      	
     572.  00:4480  E1                  	pop	hl
     573.  00:4481  E5                  	push	hl
     574.  00:4482  CD B2 45            	call	set_vdpwrite
     575.  00:4485                      	
     576.  00:4485  78                  	ld	a,b
     577.  00:4486  D3 98               	out	(0x98),a
     578.  00:4488  3A 02 00            	ld	a,(cb_fullbytes)
     579.  00:448B  A7                  	and	a
     580.  00:448C  47                  	ld	b,a
     581.  00:448D  E1                  	pop	hl
     582.  00:448E  E5                  	push	hl
     583.  00:448F  23                  	inc	hl
     584.  00:4490  28 0B               	jr.	z,0f
     585.  00:4492                      
     586.  00:4492  85                  	add	a,l
     587.  00:4493  6F                  	ld	l,a
     588.  00:4494  30 01               	jr.	nc,9f
     589.  00:4496  24                  	inc	h
     590.  00:4497                      9:
     591.  00:4497  3E FF               	ld	a,255
     592.  00:4499                      _cb_copyloop:
     593.  00:4499  D3 98               	out	(0x98),a
     594.  00:449B  10 FC               	djnz	_cb_copyloop
     595.  00:449D                      0:	
     596.  00:449D  54                  	ld	d,h
     597.  00:449E  5D                  	ld	e,l
     598.  00:449F  CD CF 45            	call	set_vdpread
     599.  00:44A2  DB 98               	in	a,(0x98)
     600.  00:44A4  47                  	ld	b,a
     601.  00:44A5  3A 01 00            	ld	a,(cb_maskright)
     602.  00:44A8  B0                  	or	b
     603.  00:44A9  47                  	ld	b,a
     604.  00:44AA                      	
     605.  00:44AA  EB                  	ex	de,hl	
     606.  00:44AB  CD B2 45            	call	set_vdpwrite
     607.  00:44AE  78                  	ld	a,b	
     608.  00:44AF  D3 98               	out	(0x98),a
     609.  00:44B1                      	
     610.  00:44B1  E1                  	pop 	hl
     611.  00:44B2  11 0A 00            	ld	de,10
     612.  00:44B5  19                  	add	hl,de
     613.  00:44B6                      	
     614.  00:44B6  0D                  	dec	c
     615.  00:44B7  20 BB               	jr.	nz,_cb_copyloop_main
     616.  00:44B9                      	
     617.  00:44B9  C9                  	ret
     618.  00:44BA                      	
     619.  00:44BA                      
     620.  00:44BA                      _cp_clip_copy:
     621.  00:44BA  E5                  	push	hl
     622.  00:44BB                      
     623.  00:44BB  3A 00 00            	ld	a,(cb_maskleft)
     624.  00:44BE  47                  	ld	b,a
     625.  00:44BF  3A 01 00            	ld	a,(cb_maskright)
     626.  00:44C2  A0                  	and	b
     627.  00:44C3  47                  	ld	b,a
     628.  00:44C4                      
     629.  00:44C4  CD CF 45            	call	set_vdpread
     630.  00:44C7  DB 98               	in	a,(0x98)
     631.  00:44C9                      
     632.  00:44C9  B0                  	or	b
     633.  00:44CA  47                  	ld	b,a
     634.  00:44CB                      	
     635.  00:44CB  E1                  	pop	hl
     636.  00:44CC  E5                  	push	hl
     637.  00:44CD  CD B2 45            	call	set_vdpwrite
     638.  00:44D0                      	
     639.  00:44D0  78                  	ld	a,b
     640.  00:44D1  D3 98               	out	(0x98),a	
     641.  00:44D3                      
     642.  00:44D3  E1                  	pop 	hl
     643.  00:44D4  11 0A 00            	ld	de,10
     644.  00:44D7  19                  	add	hl,de
     645.  00:44D8                      	
     646.  00:44D8  0D                  	dec	c
     647.  00:44D9  20 DF               	jr.	nz,_cp_clip_copy	
     648.  00:44DB                      	
     649.  00:44DB  C9                  	ret
     650.  00:44DC                      
     651.  00:44DC                      ; ==========================================================	
     652.  00:44DC                      	; --- erase_colorbox
     653.  00:44DC                      	; 
     654.  00:44DC                      	; Draw box 
     655.  00:44DC                      	; H = x pos
     656.  00:44DC                      	; L = y pos
     657.  00:44DC                      	; D = width
     658.  00:44DC                      	; E = height
     659.  00:44DC                      ; ==========================================================
     660.  00:44DC                      erase_colorbox:
     661.  00:44DC                      	; --- get maskleft
     662.  00:44DC  7C                  	ld	a,h
     663.  00:44DD  E6 07               	and	0x07
     664.  00:44DF  A7                  	and	a
     665.  00:44E0  20 04               	jr.	nz,0f
     666.  00:44E2  3E FF               	ld	a,255
     667.  00:44E4  18 07               	jr.	1f
     668.  00:44E6                      0:	
     669.  00:44E6  47                  	ld	b,a
     670.  00:44E7  3E FF               	ld	a,255
     671.  00:44E9                      	
     672.  00:44E9                      _ecb_maskleft_loop:
     673.  00:44E9  CB 3F               		srl	a
     674.  00:44EB  10 FC               		djnz	_ecb_maskleft_loop
     675.  00:44ED                      1:	
     676.  00:44ED  EE FF               	xor	255
     677.  00:44EF  32 00 00            	ld	(cb_maskleft),a
     678.  00:44F2                      
     679.  00:44F2                      	; --- get maskright (7-(x+(w-1)) & 0x07)	
     680.  00:44F2  7A                  	ld	a,d
     681.  00:44F3  3D                  	dec	a
     682.  00:44F4  84                  	add	h
     683.  00:44F5  E6 07               	and	0x07
     684.  00:44F7  FE 07               	cp	7
     685.  00:44F9  20 04               	jr.	nz,0f
     686.  00:44FB  3E 00               	ld	a,0
     687.  00:44FD  18 0B               	jr.	1f
     688.  00:44FF  47                  0:	ld	b,a
     689.  00:4500  3E 07               	ld	a,7
     690.  00:4502  90                  	sub	b
     691.  00:4503                      
     692.  00:4503                      
     693.  00:4503  47                  	ld	b,a
     694.  00:4504  3E FF               	ld	a,255	
     695.  00:4506                      	
     696.  00:4506                      _ecb_maskright_loop:
     697.  00:4506  CB 27               		sla	a
     698.  00:4508  10 FC               		djnz	_ecb_maskright_loop
     699.  00:450A                      1:	
     700.  00:450A  EE FF               	xor	255
     701.  00:450C  32 01 00            	ld	(cb_maskright),a
     702.  00:450F                      	
     703.  00:450F                      	; --- calculate the full cnt bytes to copy
     704.  00:450F  7C                  	ld	a,h
     705.  00:4510  E6 F8               	and	0xf8
     706.  00:4512  47                  	ld	b,a		; store in b the full bytes
     707.  00:4513  7C                  	ld	a,h
     708.  00:4514  82                  	add	d
     709.  00:4515  E6 F8               	and	0xf8
     710.  00:4517  90                  	sub	b
     711.  00:4518  CB 3F CB 3F CB 3F   [3]	srl	a		; divide by 8
     712.  00:451E  3D                  	dec	a		; 255 is begin and end in same byte
     713.  00:451F                      				; 0 is no full bytes to copy
     714.  00:451F                      				; >0 full bytes to copy inbetween masks
     715.  00:451F  32 02 00            	ld	(cb_fullbytes),a	
     716.  00:4522                      
     717.  00:4522                      	; --- Calculate start address
     718.  00:4522  4C                  	ld	c,h		; x in c
     719.  00:4523  45                  	ld	b,l		; y in b
     720.  00:4524  21 00 2A            	ld	hl,_CNT
     721.  00:4527  78                  	ld	a,b
     722.  00:4528  A7                  	and	a
     723.  00:4529  28 09               	jr.	z,0f
     724.  00:452B                      
     725.  00:452B                      _ecb_start_loop:
     726.  00:452B  7D                  	ld	a,l
     727.  00:452C  C6 0A               	add	10		; every line adds 10 bytes to the addres
     728.  00:452E  6F                  	ld	l,a
     729.  00:452F  30 01               	jr.	nc,1f
     730.  00:4531  24                  	inc	h
     731.  00:4532                      1:
     732.  00:4532  10 F7               	djnz	_ecb_start_loop	
     733.  00:4534                      0:
     734.  00:4534  79                  	ld	a,c		; add the x pos.
     735.  00:4535  E6 F8               	and	0xf8
     736.  00:4537  CB 3F CB 3F CB 3F   [3]	srl	a	
     737.  00:453D  85                  	add	l
     738.  00:453E  6F                  	ld	l,a
     739.  00:453F  30 01               	jr.	nc,1f
     740.  00:4541  24                  	inc	h
     741.  00:4542                      1:
     742.  00:4542                      	; now we have start addres in the cnt in HL
     743.  00:4542  4B                  	ld	c,e	; # lines to plot
     744.  00:4543                      	
     745.  00:4543                      	; --- get way to copy
     746.  00:4543  3A 02 00            	ld	a,(cb_fullbytes)
     747.  00:4546  FE FF               	cp	255
     748.  00:4548  28 46               	jr.	z,_ecb_clip_copy
     749.  00:454A                      	
     750.  00:454A                      	; --- 'normal' copy
     751.  00:454A                      _ecb_copyloop_main:	
     752.  00:454A  E5                  	push	hl
     753.  00:454B  CD CF 45            	call	set_vdpread
     754.  00:454E  DB 98               	in	a,(0x98)
     755.  00:4550  47                  	ld	b,a
     756.  00:4551  3A 00 00            	ld	a,(cb_maskleft)
     757.  00:4554  A0                  	and	b
     758.  00:4555  47                  	ld	b,a
     759.  00:4556                      	
     760.  00:4556  E1                  	pop	hl
     761.  00:4557  E5                  	push	hl
     762.  00:4558  CD B2 45            	call	set_vdpwrite
     763.  00:455B                      	
     764.  00:455B  78                  	ld	a,b
     765.  00:455C  D3 98               	out	(0x98),a
     766.  00:455E  3A 02 00            	ld	a,(cb_fullbytes)
     767.  00:4561  A7                  	and	a
     768.  00:4562  47                  	ld	b,a
     769.  00:4563  E1                  	pop	hl
     770.  00:4564  E5                  	push	hl
     771.  00:4565  23                  	inc	hl
     772.  00:4566  28 0B               	jr.	z,0f
     773.  00:4568                      
     774.  00:4568  85                  	add	a,l
     775.  00:4569  6F                  	ld	l,a
     776.  00:456A  30 01               	jr.	nc,9f
     777.  00:456C  24                  	inc	h
     778.  00:456D                      9:
     779.  00:456D  3E 00               	ld	a,0
     780.  00:456F                      _ecb_copyloop:
     781.  00:456F  D3 98               	out	(0x98),a
     782.  00:4571  10 FC               	djnz	_ecb_copyloop
     783.  00:4573                      0:	
     784.  00:4573  54                  	ld	d,h
     785.  00:4574  5D                  	ld	e,l
     786.  00:4575  CD CF 45            	call	set_vdpread
     787.  00:4578  DB 98               	in	a,(0x98)
     788.  00:457A  47                  	ld	b,a
     789.  00:457B  3A 01 00            	ld	a,(cb_maskright)
     790.  00:457E  A0                  	and	b
     791.  00:457F  47                  	ld	b,a
     792.  00:4580                      	
     793.  00:4580  EB                  	ex	de,hl	
     794.  00:4581  CD B2 45            	call	set_vdpwrite
     795.  00:4584  78                  	ld	a,b	
     796.  00:4585  D3 98               	out	(0x98),a
     797.  00:4587                      	
     798.  00:4587  E1                  	pop 	hl
     799.  00:4588  11 0A 00            	ld	de,10
     800.  00:458B  19                  	add	hl,de
     801.  00:458C                      	
     802.  00:458C  0D                  	dec	c
     803.  00:458D  20 BB               	jr.	nz,_ecb_copyloop_main
     804.  00:458F                      	
     805.  00:458F  C9                  	ret
     806.  00:4590                      	
     807.  00:4590                      
     808.  00:4590                      _ecb_clip_copy:
     809.  00:4590  E5                  	push	hl
     810.  00:4591                      
     811.  00:4591  3A 00 00            	ld	a,(cb_maskleft)
     812.  00:4594  47                  	ld	b,a
     813.  00:4595  3A 01 00            	ld	a,(cb_maskright)
     814.  00:4598  B0                  	or	b
     815.  00:4599  47                  	ld	b,a
     816.  00:459A                      
     817.  00:459A  CD CF 45            	call	set_vdpread
     818.  00:459D  DB 98               	in	a,(0x98)
     819.  00:459F                      
     820.  00:459F  A0                  	and	b
     821.  00:45A0  47                  	ld	b,a
     822.  00:45A1                      	
     823.  00:45A1  E1                  	pop	hl
     824.  00:45A2  E5                  	push	hl
     825.  00:45A3  CD B2 45            	call	set_vdpwrite
     826.  00:45A6                      	
     827.  00:45A6  78                  	ld	a,b
     828.  00:45A7  D3 98               	out	(0x98),a	
     829.  00:45A9                      
     830.  00:45A9  E1                  	pop 	hl
     831.  00:45AA  11 0A 00            	ld	de,10
     832.  00:45AD  19                  	add	hl,de
     833.  00:45AE                      	
     834.  00:45AE  0D                  	dec	c
     835.  00:45AF  20 DF               	jr.	nz,_ecb_clip_copy	
     836.  00:45B1                      	
     837.  00:45B1  C9                  	ret
     838.  00:45B2                      
     839.  00:45B2                      	; --- set_vdpwrite
     840.  00:45B2                      	; sets up the vdp address in HL to write to
     841.  00:45B2                      	; enables ISR and changes a
     842.  00:45B2                      
     843.  00:45B2                      set_vdpwrite:
     844.  00:45B2  AF                  	xor	a
     845.  00:45B3  CB 04               	rlc	h
     846.  00:45B5  17                  	rla
     847.  00:45B6  CB 04               	rlc	h
     848.  00:45B8  17                  	rla
     849.  00:45B9  CB 3C               	srl	h
     850.  00:45BB  CB 3C               	srl	h
     851.  00:45BD  F3                  	di
     852.  00:45BE  D3 99               	out	(#99),a
     853.  00:45C0  3E 8E               	ld	a,14+128
     854.  00:45C2  D3 99               	out	(#99),a
     855.  00:45C4  7D                  	ld	a,l
     856.  00:45C5  00                  	nop
     857.  00:45C6  D3 99               	out	(#99),a
     858.  00:45C8  7C                  	ld	a,h
     859.  00:45C9  F6 40               	or	64
     860.  00:45CB  FB                  	ei
     861.  00:45CC  D3 99               	out	(#99),a
     862.  00:45CE  C9                  	ret
     863.  00:45CF                      
     864.  00:45CF                      
     865.  00:45CF                      	; --- set_vdpwrite
     866.  00:45CF                      	; sets up the vdp address in HL to write to
     867.  00:45CF                      	; enables ISR and changes a
     868.  00:45CF                      
     869.  00:45CF                      set_vdpread:
     870.  00:45CF  AF                  	xor	a
     871.  00:45D0  CB 04               	rlc	h
     872.  00:45D2  17                  	rla
     873.  00:45D3  CB 04               	rlc	h
     874.  00:45D5  17                  	rla
     875.  00:45D6  CB 3C               	srl	h
     876.  00:45D8  CB 3C               	srl	h
     877.  00:45DA  F3                  	di
     878.  00:45DB  D3 99               	out	(#99),a
     879.  00:45DD  3E 8E               	ld	a,14+128
     880.  00:45DF  D3 99               	out	(#99),a
     881.  00:45E1  7D                  	ld	a,l
     882.  00:45E2  00                  	nop
     883.  00:45E3  D3 99               	out	(#99),a
     884.  00:45E5  7C                  	ld	a,h
     885.  00:45E6  D3 99               	out	(#99),a
     886.  00:45E8  FB                  	ei
     887.  00:45E9  C9                  	ret
     888.  00:45EA                      
     889.  00:45EA                      
     890.  00:45EA                      ; --- Colorbox function variables
     891.  00:45EA  (00:0000)           cb_maskleft:	#1
     892.  00:45EA  (00:0001)           cb_maskright:	#1
     893.  00:45EA  (00:0002)           cb_fullbytes:	#1
     894.  00:45EA  (00:0003)           cb_status:		#1
     895.  00:45EA                      
     896.  00:45EA                      
     897.  00:45EA                      	; --- init_font
     898.  00:45EA                      	;
     899.  00:45EA                      	; Init the font in the PGT.
     900.  00:45EA                      
     901.  00:45EA                      init_font:
     902.  00:45EA                      
     903.  00:45EA  F3                  	di
     904.  00:45EB                      	; relocate the PGT (old is at 0x1000)
     905.  00:45EB                      	; new is at 0x9000
     906.  00:45EB                      ;	ld	a,00010010b
     907.  00:45EB                      ;	out	(0x99),a
     908.  00:45EB                      ;	ld	a,128+4	
     909.  00:45EB                      ;	out	(0x99),a
     910.  00:45EB                      
     911.  00:45EB  21 00 90            	ld	hl,0x9000
     912.  00:45EE  CD B2 45            	call	set_vdpwrite
     913.  00:45F1                      	
     914.  00:45F1  F3                  	di
     915.  00:45F2  3E 08               	ld a,8		; loop 8 times
     916.  00:45F4  0E 98               	ld c,0x98
     917.  00:45F6                      
     918.  00:45F6  21 4E 57            	ld hl,font_data
     919.  00:45F9                      
     920.  00:45F9                      _fontloop:
     921.  00:45F9  06 FF               		ld b,255		; subloop 255 times
     922.  00:45FB  ED B3               		otir
     923.  00:45FD  3D                  	dec a
     924.  00:45FE  20 F9               	jr. nz,_fontloop
     925.  00:4600                      	
     926.  00:4600  FB                  	ei
     927.  00:4601  C9                  	ret
     559   00:4602                      	include	"..\code\ttreplaySMS.asm"
       1.  00:4602                      ;=================================
       2.  00:4602                      ; TriloTracker Re-player SMS
       3.  00:4602                      ; 
       4.  00:4602                      ; Functions:
       5.  00:4602                      ; 	replay_init
       6.  00:4602                      ;	replay_pause
       7.  00:4602                      ;	replay_fade_out
       8.  00:4602                      ;================================
       9.  00:4602  (00:007C)           FM_WRITE:	equ	0x7c	; port to set fm reg nr.
      10.  00:4602  (00:007D)           FM_DATA:	equ	0x7d	; port to set fm data for reg	
      11.  00:4602                      ;===============================
      12.  00:4602  (00:0060)           _REL:		equ	96	; = release
      13.  00:4602  (00:0061)           _SUS:		equ	97	; = sustain
      14.  00:4602  (00:0062)           _VOL:		equ	98	; = volume 1
      15.  00:4602  (00:0071)           _INS:		equ	113	; = instrument 1
      16.  00:4602  (00:0090)           _CMD:		equ	144	; = effect 0
      17.  00:4602  (00:00B8)           _SPC:		equ	184	; = special commands
      18.  00:4602  (00:00BF)           _EOT:		equ 191	; = end of track
      19.  00:4602  (00:00C0)           _WAIT:		equ	192	; = wait 1
      20.  00:4602                      
      21.  00:4602                      	
      22.  00:4602                      ;===========================================================
      23.  00:4602                      ; ---	replay_init
      24.  00:4602                      ; Initialize re-player data
      25.  00:4602                      ; Only call this on start-up
      26.  00:4602                      ; Input: none
      27.  00:4602                      ;===========================================================
      28.  00:4602                      replay_init:
      29.  00:4602  3E 07               	ld	a,7
      30.  00:4604  CD 57 46            	call	replay_set_FM_balance
      31.  00:4607  3E 07               	ld	a,7
      32.  00:4609  CD 5E 46            	call	replay_set_PSG_balance
      33.  00:460C                      
      34.  00:460C  AF                  	xor	a
      35.  00:460D  32 22 C0            	ld	(replay_mode),a	
      36.  00:4610  32 30 C0            	ld	(equalization_cnt),a
      37.  00:4613  32 31 C0            	ld	(equalization_flag),a	
      38.  00:4616  32 2F C0            	ld	(equalization_freq),a
      39.  00:4619  3C                  	inc	a
      40.  00:461A  32 23 C0            	ld	(replay_chan_setup),a	
      41.  00:461D                      	
      42.  00:461D  C9                  	ret
      43.  00:461E                      
      44.  00:461E                      ;===========================================================
      45.  00:461E                      ; ---	replay_pause
      46.  00:461E                      ; Stop/Restart music playback
      47.  00:461E                      ; 
      48.  00:461E                      ; Input: none
      49.  00:461E                      ;===========================================================
      50.  00:461E                      replay_pause:
      51.  00:461E  3A 22 C0            	ld	a,(replay_mode)
      52.  00:4621  A7                  	and	a
      53.  00:4622  CA 2B 46            	jp	z,_r_pause_disable
      54.  00:4625                      _r_pause_enable:
      55.  00:4625                      	;-- re-enable music decoding and processing
      56.  00:4625  3E 01               	ld	a,1
      57.  00:4627  32 22 C0            	ld	(replay_mode),a
      58.  00:462A  C9                  	ret
      59.  00:462B                      	
      60.  00:462B                      _r_pause_disable:
      61.  00:462B                      	;-- stop decoding and processing music data
      62.  00:462B  AF                  	xor	a
      63.  00:462C  32 22 C0            	ld	(replay_mode),a	
      64.  00:462F  32 AE C1            	ld	(FM_DRUM),a
      65.  00:4632                      	;--- Silence the SN7 PSG
      66.  00:4632  32 72 C1            	ld	(PSG_regVOLA),a
      67.  00:4635  32 73 C1            	ld	(PSG_regVOLB),a
      68.  00:4638  32 74 C1            	ld	(PSG_regVOLC),a
      69.  00:463B  32 75 C1            	ld	(PSG_regVOLN),a
      70.  00:463E                      	; release key on all FM channels
      71.  00:463E  06 09               	ld	b,9
      72.  00:4640  21 79 C1            	ld	hl,FM_Registers+1
      73.  00:4643  11 06 00            	ld	de,6
      74.  00:4646  AF                  	xor	a
      75.  00:4647                      _r_pause_loop:
      76.  00:4647  77                  	ld	(hl),a
      77.  00:4648  19                  	add	hl,de
      78.  00:4649  10 FC               	djnz	_r_pause_loop
      79.  00:464B  C9                  	ret	
      80.  00:464C                      	
      81.  00:464C                      
      82.  00:464C                      ;===========================================================
      83.  00:464C                      ; ---	replay_fade_out
      84.  00:464C                      ; Fade out the music. 
      85.  00:464C                      ; Once the sound is silence the replayer is paused.
      86.  00:464C                      ;
      87.  00:464C                      ; in: [A] fade speed (1 - 255)
      88.  00:464C                      ;===========================================================	
      89.  00:464C                      replay_fade_out:
      90.  00:464C  32 25 C0            	ld	(replay_fade),a
      91.  00:464F  32 26 C0            	ld	(replay_fade_timer),a
      92.  00:4652  AF                  	xor	a
      93.  00:4653  32 27 C0            	ld	(replay_fade_vol),a
      94.  00:4656  C9                  	ret
      95.  00:4657                      
      96.  00:4657                      
      97.  00:4657                      	
      98.  00:4657                      ;===========================================================
      99.  00:4657                      ; ---	replay_set_FM_balance
     100.  00:4657                      ; Set the main volume for the SCC chip. This enables for
     101.  00:4657                      ; setting the balance between SCC en PSG as some MSX models 
     102.  00:4657                      ; default balance differs. 
     103.  00:4657                      ;
     104.  00:4657                      ; in: [A] master volume (0-7) 0=halve volume, 7=full volume. 
     105.  00:4657                      ;===========================================================	
     106.  00:4657                      replay_set_FM_balance:
     107.  00:4657  CD 65 46            	call	_getnewbalancebase
     108.  00:465A  22 05 C0            	ld	(replay_mainSCCvol),hl	
     109.  00:465D  C9                  	ret
     110.  00:465E                      	
     111.  00:465E                      ;===========================================================
     112.  00:465E                      ; ---	replay_set_PSG_balance
     113.  00:465E                      ; Set the main volume for the PSG chip. This enables for
     114.  00:465E                      ; setting the balance between SCC en PSG as some MSX models 
     115.  00:465E                      ; default balance differs. 
     116.  00:465E                      ;
     117.  00:465E                      ; in: [A] master volume (0-7) 0=halve volume, 7=full volume. 
     118.  00:465E                      ;===========================================================	
     119.  00:465E                      replay_set_PSG_balance:
     120.  00:465E  CD 65 46            	call	_getnewbalancebase
     121.  00:4661  22 03 C0            	ld	(replay_mainPSGvol),hl	
     122.  00:4664  C9                  	ret
     123.  00:4665                      	
     124.  00:4665                      _getnewbalancebase:
     125.  00:4665  07                  	rlca
     126.  00:4666  07                  	rlca
     127.  00:4667  07                  	rlca
     128.  00:4668  07                  	rlca
     129.  00:4669  21 8C 51            	ld	hl,_VOLUME_TABLE-128
     130.  00:466C  E6 F0               	and	$f0
     131.  00:466E  85                  	add	a,l
     132.  00:466F  6F                  	ld	l,a
     133.  00:4670  D0                  	ret 	nc
     134.  00:4671  24                  	inc	h
     135.  00:4672  C9                  	ret
     136.  00:4673                      	
     137.  00:4673                      	
     138.  00:4673                      	
     139.  00:4673                      ;===========================================================
     140.  00:4673                      ; ---	replay_loadsong
     141.  00:4673                      ; Initialize a song for playback
     142.  00:4673                      ; 
     143.  00:4673                      ; Input [HL] points to start song
     144.  00:4673                      ;===========================================================
     145.  00:4673                      replay_loadsong:
     146.  00:4673                      	;--- Get the start speed.
     147.  00:4673  7E                  	ld	a,(hl)	
     148.  00:4674  23                  	inc	hl
     149.  00:4675  32 1F C0            	ld	(replay_speed),a
     150.  00:4678                      
     151.  00:4678                      	;--- Set voice base, drum base, instrument base and track pointers
     152.  00:4678  11 07 C0            	ld 	de,replay_voicebase
     153.  00:467B  01 16 00            	ld	bc,22
     154.  00:467E  ED B0               	ldir
     155.  00:4680  22 1D C0            	ld	(replay_orderpointer),hl		; store pointer for next set
     156.  00:4683                      								; of track pointers
     157.  00:4683                      	;--- Initialize re-player variables.
     158.  00:4683  AF                  	xor	a
     159.  00:4684  32 20 C0            	ld	(replay_speed_subtimer),a
     160.  00:4687                      	
     161.  00:4687                      	;--- Erase channel data	in RAM
     162.  00:4687  01 37 01            	ld	bc,TRACK_REC_SIZE*8-1
     163.  00:468A  21 32 C0            	ld	hl,TRACK_Chan1
     164.  00:468D  11 33 C0            	ld	de,TRACK_Chan1+1
     165.  00:4690  77                  	ld	(hl),a
     166.  00:4691  ED B0               	ldir
     167.  00:4693                      	
     168.  00:4693  32 24 C0            	ld	(replay_arp_speed),a
     169.  00:4696  32 B9 C1            	ld	(FM_DRUM_LEN),a
     170.  00:4699  32 AE C1            	ld	(FM_DRUM),a	
     171.  00:469C                      	
     172.  00:469C  32 72 C1            	ld	(PSG_regVOLA),a
     173.  00:469F  32 73 C1            	ld	(PSG_regVOLB),a	
     174.  00:46A2  32 74 C1            	ld	(PSG_regVOLC),a
     175.  00:46A5  32 70 C1            	ld	(PSG_regNOISE),a
     176.  00:46A8                      
     177.  00:46A8                      ;	;--- Set the tone table base
     178.  00:46A8                      ;	ld	hl,TRACK_ToneTable_PSG
     179.  00:46A8                      ;	ld	(replay_tonetable_PSG),hl
     180.  00:46A8                      ;	ld	hl,TRACK_ToneTable_FM
     181.  00:46A8                      ;	ld	(replay_tonetable_FM),hl
     182.  00:46A8                      
     183.  00:46A8  3E 01               	ld	a,1
     184.  00:46AA  32 21 C0            	ld	(replay_speed_timer),a
     185.  00:46AD  32 56 C0            	ld	(TRACK_Chan1+17+TRACK_Delay),a	
     186.  00:46B0  32 7D C0            	ld	(TRACK_Chan2+17+TRACK_Delay),a		
     187.  00:46B3  32 A4 C0            	ld	(TRACK_Chan3+17+TRACK_Delay),a	
     188.  00:46B6  32 CB C0            	ld	(TRACK_Chan4+17+TRACK_Delay),a	
     189.  00:46B9  32 F2 C0            	ld	(TRACK_Chan5+17+TRACK_Delay),a		
     190.  00:46BC  32 19 C1            	ld	(TRACK_Chan6+17+TRACK_Delay),a		
     191.  00:46BF  32 40 C1            	ld	(TRACK_Chan7+17+TRACK_Delay),a		
     192.  00:46C2  32 67 C1            	ld	(TRACK_Chan8+17+TRACK_Delay),a	
     193.  00:46C5                      	
     194.  00:46C5  3E FE               	ld	a,254
     195.  00:46C7  32 32 C0            	ld	(TRACK_Chan1+17+TRACK_Instrument),a	
     196.  00:46CA  32 59 C0            	ld	(TRACK_Chan2+17+TRACK_Instrument),a		
     197.  00:46CD  32 80 C0            	ld	(TRACK_Chan3+17+TRACK_Instrument),a	
     198.  00:46D0  32 A7 C0            	ld	(TRACK_Chan4+17+TRACK_Instrument),a	
     199.  00:46D3  32 CE C0            	ld	(TRACK_Chan5+17+TRACK_Instrument),a		
     200.  00:46D6  32 F5 C0            	ld	(TRACK_Chan6+17+TRACK_Instrument),a		
     201.  00:46D9  32 1C C1            	ld	(TRACK_Chan7+17+TRACK_Instrument),a		
     202.  00:46DC  32 43 C1            	ld	(TRACK_Chan8+17+TRACK_Instrument),a	
     203.  00:46DF  32 BC C1            	ld	(FM_softvoice_req),a	
     204.  00:46E2  32 BD C1            	ld	(FM_softvoice_set),a
     205.  00:46E5                      
     206.  00:46E5  3E 10               	ld	a,16
     207.  00:46E7  32 89 C0            	ld	(TRACK_Chan3+17+TRACK_Voice),a
     208.  00:46EA  32 B0 C0            	ld	(TRACK_Chan4+17+TRACK_Voice),a
     209.  00:46ED  32 D7 C0            	ld	(TRACK_Chan5+17+TRACK_Voice),a
     210.  00:46F0  32 FE C0            	ld	(TRACK_Chan6+17+TRACK_Voice),a	
     211.  00:46F3  32 25 C1            	ld	(TRACK_Chan7+17+TRACK_Voice),a	
     212.  00:46F6  32 4C C1            	ld	(TRACK_Chan8+17+TRACK_Voice),a
     213.  00:46F9  3E 80               	ld	a,128
     214.  00:46FB  32 8A C0            	ld	(TRACK_Chan3+17+TRACK_Flags),a
     215.  00:46FE  32 B1 C0            	ld	(TRACK_Chan4+17+TRACK_Flags),a
     216.  00:4701  32 D8 C0            	ld	(TRACK_Chan5+17+TRACK_Flags),a
     217.  00:4704  32 FF C0            	ld	(TRACK_Chan6+17+TRACK_Flags),a	
     218.  00:4707  32 26 C1            	ld	(TRACK_Chan7+17+TRACK_Flags),a
     219.  00:470A  32 4D C1            	ld	(TRACK_Chan8+17+TRACK_Flags),a	
     220.  00:470D                      	
     221.  00:470D                      	;--- Check if there are 3 psg chans.
     222.  00:470D  3A 23 C0            	ld	a,(replay_chan_setup)
     223.  00:4710  A7                  	and	a
     224.  00:4711  CA 18 47            	jp	z,99f
     225.  00:4714  AF                  	xor 	a
     226.  00:4715  32 8A C0            	ld	(TRACK_Chan3+17+TRACK_Flags),a	
     227.  00:4718                      99:	
     228.  00:4718                      
     229.  00:4718  CD 60 50            	call	replay_route
     230.  00:471B                      	
     231.  00:471B                      	; end	is here
     232.  00:471B  3E 01               	ld	a,1
     233.  00:471D  32 22 C0            	ld	(replay_mode),a	
     234.  00:4720  C9                  	ret
     235.  00:4721                      
     236.  00:4721                      ;===========================================================
     237.  00:4721                      ; ---	replay_play
     238.  00:4721                      ; Decode music data and process instruments and effects. 
     239.  00:4721                      ; Music chip registers will be prepared for replay_route 
     240.  00:4721                      ;
     241.  00:4721                      ; Input none
     242.  00:4721                      ;===========================================================	
     243.  00:4721                      replay_play:
     244.  00:4721  3A 22 C0            	ld	a,(replay_mode)
     245.  00:4724  A7                  	and	a
     246.  00:4725  C8                  	ret	z		; replay mode = 0	; halted
     247.  00:4726                      				
     248.  00:4726                      				; replay mode = 1	; active
     249.  00:4726                      	
     250.  00:4726                      	;---- SPEED EQUALIZATION 
     251.  00:4726  3A 2F C0            	ld	a,(equalization_freq)		; 0 = 50Hz, otherwise 60Hz
     252.  00:4729  A7                  	and	a
     253.  00:472A  28 14               	jr.	z,.PAL               		; if PAL process at any interrupt;
     254.  00:472C                      
     255.  00:472C                      .NTSC:
     256.  00:472C  21 30 C0            	ld	hl,equalization_cnt  		; if NTSC call 5 times out of 6
     257.  00:472F  35                  	dec	(hl)
     258.  00:4730  20 0E               	jr.	nz,.PAL               		; skip music data processing one tic out of 6
     259.  00:4732                      
     260.  00:4732                      	;--- Reset timer and raise equalization flag
     261.  00:4732  3E 06               	ld	a,6
     262.  00:4734  77                  	ld	(hl),a						
     263.  00:4735  32 31 C0             	ld	(equalization_flag),a		
     264.  00:4738                      
     265.  00:4738  CD 6B 48            	call	process_data	
     266.  00:473B  AF                  	xor	a
     267.  00:473C  32 31 C0            	ld	(equalization_flag),a
     268.  00:473F  C9                  	ret
     269.  00:4740                      .PAL:                             
     270.  00:4740                      	;---- END SPEED EQUALIZATION	
     271.  00:4740                      
     272.  00:4740                      		
     273.  00:4740                      	;--- The speed timer
     274.  00:4740  21 21 C0            	ld	hl,replay_speed_timer
     275.  00:4743  35                  	dec	(hl)
     276.  00:4744                      
     277.  00:4744  C2 E7 49            	jp	nz,_replay_check_patternend	
     278.  00:4747                      		
     279.  00:4747                      	;--- Re-init Timer == 0
     280.  00:4747  AF                  	xor	a
     281.  00:4748  ED 4B 1F C0         	ld	bc,(replay_speed)		; [b]	sub-timer [c] speed
     282.  00:474C  CB 39               	srl	c				; bit	0 is halve speed step
     283.  00:474E  8F                  	adc	a,a
     284.  00:474F  A8                  	xor	b				; alternate	speed	to have halve speed.
     285.  00:4750  32 20 C0            	ld	(replay_speed_subtimer),a
     286.  00:4753  81                  	add	c
     287.  00:4754  32 21 C0            	ld	(replay_speed_timer),a
     288.  00:4757                      		
     289.  00:4757                      ;===========================================================
     290.  00:4757                      ; ---	replay_decodedata
     291.  00:4757                      ; Process the pattern data 
     292.  00:4757                      ;===========================================================
     293.  00:4757                      decode_data:
     294.  00:4757                      	;--- process the channels (tracks)
     295.  00:4757                      	
     296.  00:4757  21 0C 53            	ld	hl,TRACK_ToneTable_PSG			; Set the PSG note table
     297.  00:475A  22 2D C0            	ld	(replay_tonetable),hl	
     298.  00:475D                      	
     299.  00:475D                      .decode1:	
     300.  00:475D  21 56 C0            	ld 	hl,TRACK_Chan1+17+TRACK_Delay
     301.  00:4760  35                  	dec	(hl)
     302.  00:4761  C2 7E 47            	jp	nz,.decode2
     303.  00:4764                      
     304.  00:4764  3A 3C C0            	ld	a,(TRACK_Chan1+17+TRACK_Flags)
     305.  00:4767  57                  	ld	d,a
     306.  00:4768  3A 39 C0            	ld	a,(TRACK_Chan1+17+TRACK_Note)	
     307.  00:476B  DD 21 43 C0         	ld	ix,TRACK_Chan1+17
     308.  00:476F  ED 4B 0D C0         	ld	bc,(TRACK_pointer1)
     309.  00:4773  CD 19 4A            	call	decode_data_chan
     310.  00:4776  ED 43 0D C0         	ld	(TRACK_pointer1),bc
     311.  00:477A  7A                  	ld	a,d
     312.  00:477B  32 3C C0            	ld	(TRACK_Chan1+17+TRACK_Flags),a	
     313.  00:477E                      
     314.  00:477E                      .decode2:	
     315.  00:477E  21 7D C0            	ld 	hl,TRACK_Chan2+17+TRACK_Delay
     316.  00:4781  35                  	dec	(hl)
     317.  00:4782  C2 A5 47            	jp	nz,.decode3
     318.  00:4785                      
     319.  00:4785  3A 63 C0            	ld	a,(TRACK_Chan2+17+TRACK_Flags)
     320.  00:4788  57                  	ld	d,a
     321.  00:4789  3A 60 C0            	ld	a,(TRACK_Chan2+17+TRACK_Note)	
     322.  00:478C  DD 21 6A C0         	ld	ix,TRACK_Chan2+17
     323.  00:4790  ED 4B 0F C0         	ld	bc,(TRACK_pointer2)
     324.  00:4794  CD 19 4A            	call	decode_data_chan
     325.  00:4797  ED 43 0F C0         	ld	(TRACK_pointer2),bc
     326.  00:479B  7A                  	ld	a,d				;'
     327.  00:479C  32 63 C0            	ld	(TRACK_Chan2+17+TRACK_Flags),a	
     328.  00:479F                      
     329.  00:479F                      	;--- Set FM Tone table
     330.  00:479F  21 CC 53            	ld	hl,TRACK_ToneTable_FM
     331.  00:47A2  22 2D C0            	ld	(replay_tonetable),hl
     332.  00:47A5                      
     333.  00:47A5                      
     334.  00:47A5                      .decode3:
     335.  00:47A5  21 A4 C0            	ld 	hl,TRACK_Chan3+17+TRACK_Delay
     336.  00:47A8  35                  	dec	(hl)
     337.  00:47A9  C2 C6 47            	jp	nz,.decode4
     338.  00:47AC                      
     339.  00:47AC  3A 8A C0            	ld	a,(TRACK_Chan3+17+TRACK_Flags)
     340.  00:47AF  57                  	ld	d,a		;'
     341.  00:47B0  3A 87 C0            	ld	a,(TRACK_Chan3+17+TRACK_Note)	
     342.  00:47B3  DD 21 91 C0         	ld	ix,TRACK_Chan3+17
     343.  00:47B7  ED 4B 11 C0         	ld	bc,(TRACK_pointer3)
     344.  00:47BB  CD 19 4A            	call	decode_data_chan
     345.  00:47BE  ED 43 11 C0         	ld	(TRACK_pointer3),bc
     346.  00:47C2  7A                  	ld	a,d				;'
     347.  00:47C3  32 8A C0            	ld	(TRACK_Chan3+17+TRACK_Flags),a	
     348.  00:47C6                      
     349.  00:47C6                      .decode4:
     350.  00:47C6  21 CB C0            	ld 	hl,TRACK_Chan4+17+TRACK_Delay
     351.  00:47C9  35                  	dec	(hl)
     352.  00:47CA  C2 E7 47            	jp	nz,.decode5
     353.  00:47CD                      
     354.  00:47CD  3A B1 C0            	ld	a,(TRACK_Chan4+17+TRACK_Flags)
     355.  00:47D0  57                  	ld 	d,a		;'
     356.  00:47D1  3A AE C0            	ld	a,(TRACK_Chan4+17+TRACK_Note)	
     357.  00:47D4  DD 21 B8 C0         	ld	ix,TRACK_Chan4+17
     358.  00:47D8  ED 4B 13 C0         	ld	bc,(TRACK_pointer4)
     359.  00:47DC  CD 19 4A            	call	decode_data_chan
     360.  00:47DF  ED 43 13 C0         	ld	(TRACK_pointer4),bc
     361.  00:47E3  7A                  	ld	a,d			;'
     362.  00:47E4  32 B1 C0            	ld	(TRACK_Chan4+17+TRACK_Flags),a	
     363.  00:47E7                      
     364.  00:47E7                      .decode5:
     365.  00:47E7  21 F2 C0            	ld 	hl,TRACK_Chan5+17+TRACK_Delay
     366.  00:47EA  35                  	dec	(hl)
     367.  00:47EB  C2 08 48            	jp	nz,.decode6
     368.  00:47EE                      
     369.  00:47EE  3A D8 C0            	ld	a,(TRACK_Chan5+17+TRACK_Flags)
     370.  00:47F1  57                  	ld	d,a		;'
     371.  00:47F2  3A D5 C0            	ld	a,(TRACK_Chan5+17+TRACK_Note)	
     372.  00:47F5  DD 21 DF C0         	ld	ix,TRACK_Chan5+17
     373.  00:47F9  ED 4B 15 C0         	ld	bc,(TRACK_pointer5)
     374.  00:47FD  CD 19 4A            	call	decode_data_chan
     375.  00:4800  ED 43 15 C0         	ld	(TRACK_pointer5),bc
     376.  00:4804  7A                  	ld	a,d			;'
     377.  00:4805  32 D8 C0            	ld	(TRACK_Chan5+17+TRACK_Flags),a	
     378.  00:4808                      
     379.  00:4808                      .decode6:
     380.  00:4808  21 19 C1            	ld 	hl,TRACK_Chan6+17+TRACK_Delay
     381.  00:480B  35                  	dec	(hl)
     382.  00:480C  C2 29 48            	jp	nz,.decode7
     383.  00:480F                      
     384.  00:480F  3A FF C0            	ld	a,(TRACK_Chan6+17+TRACK_Flags)
     385.  00:4812  57                  	ld	d,a		;'
     386.  00:4813  3A FC C0            	ld	a,(TRACK_Chan6+17+TRACK_Note)	
     387.  00:4816  DD 21 06 C1         	ld	ix,TRACK_Chan6+17
     388.  00:481A  ED 4B 17 C0         	ld	bc,(TRACK_pointer6)
     389.  00:481E  CD 19 4A            	call	decode_data_chan
     390.  00:4821  ED 43 17 C0         	ld	(TRACK_pointer6),bc
     391.  00:4825  7A                  	ld	a,d				;'
     392.  00:4826  32 FF C0            	ld	(TRACK_Chan6+17+TRACK_Flags),a	
     393.  00:4829                      
     394.  00:4829                      .decode7:
     395.  00:4829  21 40 C1            	ld 	hl,TRACK_Chan7+17+TRACK_Delay
     396.  00:482C  35                  	dec	(hl)
     397.  00:482D  C2 4A 48            	jp	nz,.decode8
     398.  00:4830                      
     399.  00:4830  3A 26 C1            	ld	a,(TRACK_Chan7+17+TRACK_Flags)
     400.  00:4833  57                  	ld	d,a		;'
     401.  00:4834  3A 23 C1            	ld	a,(TRACK_Chan7+17+TRACK_Note)	
     402.  00:4837  DD 21 2D C1         	ld	ix,TRACK_Chan7+17
     403.  00:483B  ED 4B 19 C0         	ld	bc,(TRACK_pointer7)
     404.  00:483F  CD 19 4A            	call	decode_data_chan
     405.  00:4842  ED 43 19 C0         	ld	(TRACK_pointer7),bc
     406.  00:4846  7A                  	ld	a,d				;'
     407.  00:4847  32 26 C1            	ld	(TRACK_Chan7+17+TRACK_Flags),a	
     408.  00:484A                      
     409.  00:484A                      .decode8:
     410.  00:484A  21 67 C1            	ld 	hl,TRACK_Chan8+17+TRACK_Delay
     411.  00:484D  35                  	dec	(hl)
     412.  00:484E  C2 6B 48            	jp	nz,.decode_end
     413.  00:4851                      
     414.  00:4851  3A 4D C1            	ld	a,(TRACK_Chan8+17+TRACK_Flags)
     415.  00:4854  57                  	ld	d,a		;'
     416.  00:4855  3A 4A C1            	ld	a,(TRACK_Chan8+17+TRACK_Note)	
     417.  00:4858  DD 21 54 C1         	ld	ix,TRACK_Chan8+17
     418.  00:485C  ED 4B 1B C0         	ld	bc,(TRACK_pointer8)
     419.  00:4860  CD 19 4A            	call	decode_data_chan
     420.  00:4863  ED 43 1B C0         	ld	(TRACK_pointer8),bc
     421.  00:4867  7A                  	ld	a,d				;'
     422.  00:4868  32 4D C1            	ld	(TRACK_Chan8+17+TRACK_Flags),a
     423.  00:486B                      		
     424.  00:486B                      .decode_end:
     425.  00:486B                      	; continue to process data
     426.  00:486B                      ;===========================================================
     427.  00:486B                      ; ---	replay_decodedata_NO
     428.  00:486B                      ; Process changes.
     429.  00:486B                      ; 
     430.  00:486B                      ; 
     431.  00:486B                      ;===========================================================
     432.  00:486B                      process_data:
     433.  00:486B  3E FA               	ld	a,$fa ; Reg#3 [A13][A12][A11][A10][A09][ 1 ][ 1 ][ 1 ]  - Color table  [HIGH]
     434.  00:486D  D3 99               	out	(0x99),a
     435.  00:486F  3E 87               	ld	a,7+128
     436.  00:4871  D3 99               	out	(0x99),a	
     437.  00:4873                      
     438.  00:4873                      
     439.  00:4873                      
     440.  00:4873                      	; Set tone table
     441.  00:4873  21 0C 53            	ld	hl,TRACK_ToneTable_PSG
     442.  00:4876  22 2D C0            	ld	(replay_tonetable),hl
     443.  00:4879                      
     444.  00:4879                      	;--- Initialize PSG Mixer and volume
     445.  00:4879  AF                  	xor	a
     446.  00:487A  32 BE C1            	ld	(FM_regMIXER),a
     447.  00:487D  32 75 C1            	ld	(PSG_regVOLN),a
     448.  00:4880  32 72 C1            	ld	(PSG_regVOLA),a
     449.  00:4883  32 73 C1            	ld	(PSG_regVOLB),a
     450.  00:4886  32 74 C1            	ld	(PSG_regVOLC),a
     451.  00:4889                      	
     452.  00:4889                      	;--- PSG balance
     453.  00:4889  2A 03 C0            	ld	hl,(replay_mainPSGvol)
     454.  00:488C  22 29 C0            	ld	(replay_mainvol),hl
     455.  00:488F                      	
     456.  00:488F                      	;--------------------
     457.  00:488F                      	;--- Process track 1
     458.  00:488F                      	;--------------------
     459.  00:488F  DD 21 43 C0         	ld	ix,TRACK_Chan1+17
     460.  00:4893  3A 3C C0            	ld	a,(TRACK_Chan1+17+TRACK_Flags)
     461.  00:4896  57                  	ld	d,a
     462.  00:4897  21 6A C1            	ld	hl,PSG_regToneA
     463.  00:489A  CD E2 4C            	call	process_data_chan
     464.  00:489D                      ;	ld	(PSG_regToneA),hl
     465.  00:489D  3A 9A C1            	ld	a,(FM_regVOLF)
     466.  00:48A0  32 72 C1            	ld	(PSG_regVOLA),a	
     467.  00:48A3                      
     468.  00:48A3                      	;--------------------
     469.  00:48A3                      	;--- Process track 2
     470.  00:48A3                      	;--------------------
     471.  00:48A3  DD 21 6A C0         	ld	ix,TRACK_Chan2+17
     472.  00:48A7  3A 63 C0            	ld	a,(TRACK_Chan2+17+TRACK_Flags)
     473.  00:48AA  57                  	ld	d,a
     474.  00:48AB  21 6C C1            	ld	hl,PSG_regToneB
     475.  00:48AE  CD E2 4C            	call	process_data_chan
     476.  00:48B1                      ;	ld	(PSG_regToneB),hl
     477.  00:48B1  3A 9A C1            	ld	a,(FM_regVOLF)
     478.  00:48B4  32 73 C1            	ld	(PSG_regVOLB),a	
     479.  00:48B7                      
     480.  00:48B7  3A 23 C0            	ld	a,(replay_chan_setup)
     481.  00:48BA  A7                  	and	a
     482.  00:48BB  CA ED 48            	jp	z,_rdd_2psg_6fm
     483.  00:48BE                      
     484.  00:48BE                      _rdd_3psg_5fm:
     485.  00:48BE                      	;--------------------
     486.  00:48BE                      	;--- Process track 3	
     487.  00:48BE                      	;--------------------
     488.  00:48BE  DD 21 91 C0         	ld	ix,TRACK_Chan3+17
     489.  00:48C2  3A 8A C0            	ld	a,(TRACK_Chan3+17+TRACK_Flags)
     490.  00:48C5  57                  	ld	d,a
     491.  00:48C6  21 6E C1            	ld	hl,PSG_regToneC
     492.  00:48C9  CD E2 4C            	call	process_data_chan
     493.  00:48CC                      ;	ld	(PSG_regToneC),hl
     494.  00:48CC  3A 9A C1            	ld	a,(FM_regVOLF)
     495.  00:48CF  32 74 C1            	ld	(PSG_regVOLC),a
     496.  00:48D2                      
     497.  00:48D2                      	;-- Convert mixer to AY
     498.  00:48D2  3A BE C1            	ld	a,(FM_regMIXER)		
     499.  00:48D5  CB 3F               	srl	a
     500.  00:48D7  CB 3F               	srl	a
     501.  00:48D9  EE 3F               	xor	0x3f
     502.  00:48DB  32 71 C1            	ld	(PSG_regMIXER),a
     503.  00:48DE                      
     504.  00:48DE                      	; Set tone table
     505.  00:48DE  21 CC 53            	ld	hl,TRACK_ToneTable_FM
     506.  00:48E1  22 2D C0            	ld	(replay_tonetable),hl
     507.  00:48E4                      	;--- set SCC balance
     508.  00:48E4  2A 05 C0            	ld	hl,(replay_mainSCCvol)
     509.  00:48E7  22 29 C0            	ld	(replay_mainvol),hl
     510.  00:48EA                      	
     511.  00:48EA  C3 22 49            	jp	_rdd_cont
     512.  00:48ED                      	
     513.  00:48ED                      	
     514.  00:48ED                      _rdd_2psg_6fm:
     515.  00:48ED                      	;-- Convert mixer to AY
     516.  00:48ED  3A BE C1            	ld	a,(FM_regMIXER)		
     517.  00:48F0  CB 3F               	srl	a
     518.  00:48F2  CB 3F               	srl	a
     519.  00:48F4  CB 3F               	srl	a
     520.  00:48F6  EE 3F               	xor	0x3f
     521.  00:48F8  32 71 C1            	ld	(PSG_regMIXER),a
     522.  00:48FB                      
     523.  00:48FB                      	; Set tone table
     524.  00:48FB  21 CC 53            	ld	hl,TRACK_ToneTable_FM
     525.  00:48FE  22 2D C0            	ld	(replay_tonetable),hl
     526.  00:4901                      	;--- set SCC balance
     527.  00:4901  2A 05 C0            	ld	hl,(replay_mainSCCvol)
     528.  00:4904  22 29 C0            	ld	(replay_mainvol),hl
     529.  00:4907                      
     530.  00:4907                      	;--------------------
     531.  00:4907                      	;--- Process track 3
     532.  00:4907                      	;--------------------
     533.  00:4907  DD 21 91 C0         	ld	ix,TRACK_Chan3+17
     534.  00:490B  3A 8A C0            	ld	a,(TRACK_Chan3+17+TRACK_Flags)
     535.  00:490E  57                  	ld	d,a
     536.  00:490F  21 78 C1            	ld	hl,FM_regToneA
     537.  00:4912  CD E2 4C            	call	process_data_chan
     538.  00:4915                      ;	ld	(FM_regToneA),hl
     539.  00:4915  3A 9A C1            	ld	a,(FM_regVOLF)
     540.  00:4918  57                  	ld	d,a
     541.  00:4919  3A 89 C0            	ld	a,(TRACK_Chan3+17+TRACK_Voice)
     542.  00:491C  E6 F0               	and	$f0
     543.  00:491E  B2                  	or	d
     544.  00:491F  32 7C C1            	ld	(FM_regVOLA),a	
     545.  00:4922                      
     546.  00:4922                      
     547.  00:4922                      _rdd_cont:
     548.  00:4922                      	;--------------------
     549.  00:4922                      	;--- Process track 4
     550.  00:4922                      	;--------------------
     551.  00:4922  DD 21 B8 C0         	ld	ix,TRACK_Chan4+17
     552.  00:4926  3A B1 C0            	ld	a,(TRACK_Chan4+17+TRACK_Flags)
     553.  00:4929  57                  	ld	d,a
     554.  00:492A  21 7E C1            	ld	hl,FM_regToneB
     555.  00:492D  CD E2 4C            	call	process_data_chan
     556.  00:4930                      ;	ld	(FM_regToneB),hl
     557.  00:4930  3A 9A C1            	ld	a,(FM_regVOLF)
     558.  00:4933  57                  	ld	d,a
     559.  00:4934  3A B0 C0            	ld	a,(TRACK_Chan4+17+TRACK_Voice)
     560.  00:4937  E6 F0               	and	$f0
     561.  00:4939  B2                  	or	d
     562.  00:493A  32 82 C1            	ld	(FM_regVOLB),a	
     563.  00:493D                      
     564.  00:493D                      	;--------------------
     565.  00:493D                      	;--- Process track 5
     566.  00:493D                      	;--------------------	
     567.  00:493D  DD 21 DF C0         	ld	ix,TRACK_Chan5+17
     568.  00:4941  3A D8 C0            	ld	a,(TRACK_Chan5+17+TRACK_Flags)
     569.  00:4944  57                  	ld	d,a
     570.  00:4945  21 84 C1            	ld	hl,FM_regToneC
     571.  00:4948  CD E2 4C            	call	process_data_chan
     572.  00:494B                      ;	ld	(FM_regToneC),hl
     573.  00:494B  3A 9A C1            	ld	a,(FM_regVOLF)
     574.  00:494E  57                  	ld	d,a
     575.  00:494F  3A D7 C0            	ld	a,(TRACK_Chan5+17+TRACK_Voice)
     576.  00:4952  E6 F0               	and	$f0
     577.  00:4954  B2                  	or	d
     578.  00:4955  32 88 C1            	ld	(FM_regVOLC),a	
     579.  00:4958                      
     580.  00:4958                      	;--------------------
     581.  00:4958                      	;--- Process track 6
     582.  00:4958                      	;--------------------
     583.  00:4958                      		
     584.  00:4958  DD 21 06 C1         	ld	ix,TRACK_Chan6+17
     585.  00:495C  3A FF C0            	ld	a,(TRACK_Chan6+17+TRACK_Flags)
     586.  00:495F  57                  	ld	d,a
     587.  00:4960  21 8A C1            	ld	hl,FM_regToneD
     588.  00:4963  CD E2 4C            	call	process_data_chan
     589.  00:4966                      ;	ld	(FM_regToneD),hl
     590.  00:4966  3A 9A C1            	ld	a,(FM_regVOLF)
     591.  00:4969  57                  	ld	d,a
     592.  00:496A  3A FE C0            	ld	a,(TRACK_Chan6+17+TRACK_Voice)
     593.  00:496D  E6 F0               	and	$f0
     594.  00:496F  B2                  	or	d
     595.  00:4970  32 8E C1            	ld	(FM_regVOLD),a	
     596.  00:4973                      
     597.  00:4973                      	;--------------------
     598.  00:4973                      	;--- Process track 7
     599.  00:4973                      	;--------------------
     600.  00:4973  DD 21 2D C1         	ld	ix,TRACK_Chan7+17
     601.  00:4977  3A 26 C1            	ld	a,(TRACK_Chan7+17+TRACK_Flags)
     602.  00:497A  57                  	ld	d,a
     603.  00:497B  21 90 C1            	ld	hl,FM_regToneE
     604.  00:497E  CD E2 4C            	call	process_data_chan
     605.  00:4981                      ;	ld	(FM_regToneE),hl
     606.  00:4981                      ;	ld	a,d
     607.  00:4981                      ;	ld	(TRACK_Chan7+17+TRACK_Flags),a	
     608.  00:4981  3A 9A C1            	ld	a,(FM_regVOLF)
     609.  00:4984  57                  	ld	d,a
     610.  00:4985  3A 25 C1            	ld	a,(TRACK_Chan7+17+TRACK_Voice)
     611.  00:4988  E6 F0               	and	$f0
     612.  00:498A  B2                  	or	d
     613.  00:498B  32 94 C1            	ld	(FM_regVOLE),a		
     614.  00:498E                      
     615.  00:498E                      	;--------------------
     616.  00:498E                      	;--- Process track 8
     617.  00:498E                      	;--------------------		
     618.  00:498E  DD 21 54 C1         	ld	ix,TRACK_Chan8+17
     619.  00:4992  3A 4D C1            	ld	a,(TRACK_Chan8+17+TRACK_Flags)
     620.  00:4995  57                  	ld	d,a
     621.  00:4996  CD E2 4C            	call	process_data_chan
     622.  00:4999  3A 9A C1            	ld	a,(FM_regVOLF)
     623.  00:499C  57                  	ld	d,a
     624.  00:499D  3A 89 C0            	ld	a,(TRACK_Chan3+17+TRACK_Voice)
     625.  00:49A0  E6 F0               	and	$f0
     626.  00:49A2  B2                  	or	d	
     627.  00:49A3  32 94 C1            	ld	(FM_regVOLE),a
     628.  00:49A6                      ;	ld	(FM_regToneF),hl
     629.  00:49A6                      	
     630.  00:49A6                      
     631.  00:49A6                      	;--------------------
     632.  00:49A6                      	; Fade out processing
     633.  00:49A6                      	;--------------------
     634.  00:49A6  3A 25 C0            	ld	a,(replay_fade)
     635.  00:49A9  A7                  	and	a
     636.  00:49AA  C8                  	ret	z	; if replay fade = 0 then no fade active
     637.  00:49AB                      	
     638.  00:49AB                      	; decrease fade timer
     639.  00:49AB  3A 26 C0            	ld	a,(replay_fade_timer)
     640.  00:49AE  3D                  	dec	a
     641.  00:49AF  C2 C8 49            	jp	nz,.no_new_step
     642.  00:49B2                      
     643.  00:49B2  3A 27 C0            	ld	a,(replay_fade_vol)
     644.  00:49B5  3C                  	inc	a
     645.  00:49B6  FE 10               	cp	16
     646.  00:49B8  DA C2 49            	jp	c,.cont_fadeing
     647.  00:49BB  AF                  	xor	a
     648.  00:49BC  32 25 C0            	ld	(replay_fade),a
     649.  00:49BF  C3 1E 46            	jp	replay_pause
     650.  00:49C2                      .cont_fadeing:	
     651.  00:49C2  32 27 C0            	ld	(replay_fade_vol),a
     652.  00:49C5  3A 25 C0            	ld	a,(replay_fade)
     653.  00:49C8                      .no_new_step:
     654.  00:49C8  32 26 C0            	ld	(replay_fade_timer),a
     655.  00:49CB                      
     656.  00:49CB  3A 27 C0            	ld	a,(replay_fade_vol)
     657.  00:49CE  4F                  	ld	c,a
     658.  00:49CF  06 03               	ld	b,3
     659.  00:49D1  21 72 C1            	ld	hl,PSG_regVOLA
     660.  00:49D4  CD DC 49            	call	.calc_vol
     661.  00:49D7  06 06               	ld	b,6
     662.  00:49D9  21 7C C1            	ld	hl,FM_regVOLA
     663.  00:49DC                      
     664.  00:49DC                      .calc_vol:	
     665.  00:49DC  7E                  	ld	a,(hl)
     666.  00:49DD  91                  	sub	c
     667.  00:49DE  D2 E2 49            	jp	nc,.no_carry
     668.  00:49E1  AF                  	xor	a
     669.  00:49E2                      .no_carry:	
     670.  00:49E2  77                  	ld	(hl),a
     671.  00:49E3  23                  	inc	hl
     672.  00:49E4  10 F6               	djnz	.calc_vol
     673.  00:49E6  C9                  	ret
     674.  00:49E7                      
     675.  00:49E7                      
     676.  00:49E7                      
     677.  00:49E7                      ;--------------------
     678.  00:49E7                      	
     679.  00:49E7                      	
     680.  00:49E7                      ;--------------------
     681.  00:49E7                      _replay_check_patternend:
     682.  00:49E7  3A 56 C0            	ld 	a,(TRACK_Chan1+17+TRACK_Delay)
     683.  00:49EA  3D                  	dec	a
     684.  00:49EB  C2 6B 48            	jp	nz,process_data
     685.  00:49EE                      	
     686.  00:49EE  2A 0D C0            	ld	hl,(TRACK_pointer1)
     687.  00:49F1  7E                  	ld	a,(hl)
     688.  00:49F2                      	
     689.  00:49F2                      	;--- check for end of pattern
     690.  00:49F2  FE BF               	cp	191	
     691.  00:49F4  C2 6B 48            	jp	nz,process_data
     692.  00:49F7                      
     693.  00:49F7                      	;--- Set track pointers to start
     694.  00:49F7  2A 1D C0            	ld	hl,(replay_orderpointer)
     695.  00:49FA  AF                  	xor	a
     696.  00:49FB  BE                  	cp	(hl)
     697.  00:49FC  C2 0B 4A            	jp	nz,.no_restart
     698.  00:49FF  23                  	inc	hl
     699.  00:4A00  BE                  	cp	(hl)
     700.  00:4A01  2B                  	dec	hl
     701.  00:4A02  C2 0B 4A            	jp	nz,.no_restart
     702.  00:4A05                      	;--- next is restart order
     703.  00:4A05  23                  	inc	hl
     704.  00:4A06  23                  	inc	hl
     705.  00:4A07  7E                  	ld	a,(hl)
     706.  00:4A08  23                  	inc	hl
     707.  00:4A09  66                  	ld	h,(hl)
     708.  00:4A0A  6F                  	ld	l,a
     709.  00:4A0B                      .no_restart:	
     710.  00:4A0B  11 0D C0            	ld	de,TRACK_pointer1
     711.  00:4A0E  01 10 00            	ld	bc,16
     712.  00:4A11  ED B0               	ldir
     713.  00:4A13  22 1D C0            	ld	(replay_orderpointer),hl		; store pointer for next set
     714.  00:4A16                      								; of strack pointers
     715.  00:4A16  C3 6B 48            	jp	process_data
     716.  00:4A19                      
     717.  00:4A19                      
     718.  00:4A19                      
     719.  00:4A19                      
     720.  00:4A19                      
     721.  00:4A19                      
     722.  00:4A19                      
     723.  00:4A19                      
     724.  00:4A19                      
     725.  00:4A19                      
     726.  00:4A19                      
     727.  00:4A19                      
     728.  00:4A19                      ;===========================================================
     729.  00:4A19                      ; ---	decode_data_chan
     730.  00:4A19                      ; Process the channel data
     731.  00:4A19                      ; 
     732.  00:4A19                      ; in BC is the pointer to the	data
     733.  00:4A19                      ;    D contains flags.
     734.  00:4A19                      ;===========================================================	
     735.  00:4A19                      decode_data_chan:
     736.  00:4A19                      	;--- initialize data
     737.  00:4A19  DD 7E F6            	ld	a,(ix+TRACK_Note)
     738.  00:4A1C  32 28 C0            	ld	(replay_previous_note),a
     739.  00:4A1F                      
     740.  00:4A1F                      	;=============
     741.  00:4A1F                      	; Note 
     742.  00:4A1F                      	;=============
     743.  00:4A1F  0A                  	ld	a,(bc)
     744.  00:4A20  FE 60               	cp	_REL
     745.  00:4A22  DA 8E 4A            	jp	c,_replay_decode_note
     746.  00:4A25  FE 61               	cp	_SUS
     747.  00:4A27  DA 9A 4A            	jp	c,_replay_decode_release
     748.  00:4A2A  CA A5 4A            	jp	z,_replay_decode_sustain
     749.  00:4A2D  FE 71               _rdn2:cp	_INS
     750.  00:4A2F  DA E9 4A            	jp	c,_replay_decode_vol
     751.  00:4A32  FE 90               _rdv2:cp	_CMD
     752.  00:4A34  DA B0 4A            	jp	c,_replay_decode_ins
     753.  00:4A37                      _rdi2:
     754.  00:4A37  FE BF               	cp	_EOT
     755.  00:4A39  DA FE 4A            	jp	c,_replaydecode_cmd
     756.  00:4A3C  C3 6A 4A            	jp	_replay_decode_delay
     757.  00:4A3F                      
     758.  00:4A3F                      _rdn:
     759.  00:4A3F  FE 61               	cp	_SUS
     760.  00:4A41  DA 61 4A            	jp	c,_rd_delay
     761.  00:4A44  C3 2D 4A            	jp	_rdn2
     762.  00:4A47                      
     763.  00:4A47                      _rdi:
     764.  00:4A47  FE 90               	cp	_CMD
     765.  00:4A49  DA 61 4A            	jp	c,_rd_delay
     766.  00:4A4C  C3 37 4A            	jp	_rdi2
     767.  00:4A4F                      
     768.  00:4A4F                      _rdv:
     769.  00:4A4F  FE 71               	cp	_INS
     770.  00:4A51  DA 61 4A            	jp	c,_rd_delay
     771.  00:4A54  C3 32 4A            	jp	_rdv2
     772.  00:4A57                      _rdc:
     773.  00:4A57  03                  	inc	bc
     774.  00:4A58                      _rdc_noinc:	
     775.  00:4A58  0A                  	ld	a,(bc)
     776.  00:4A59  FE BF               	cp	_EOT
     777.  00:4A5B  DA 61 4A            	jp	c,_rd_delay
     778.  00:4A5E  C3 6A 4A            	jp	_replay_decode_delay
     779.  00:4A61                      
     780.  00:4A61                      	;--- re-init previous delay
     781.  00:4A61                      _rd_delay:
     782.  00:4A61  DD 7E 14            	ld	a,(ix+TRACK_prevDelay)
     783.  00:4A64  DD 77 13            	ld	(ix+TRACK_Delay),a
     784.  00:4A67  C3 76 4A            	jp	_replay_decode_trigger_porttone_check
     785.  00:4A6A                      
     786.  00:4A6A                      _replay_decode_delay:
     787.  00:4A6A  D6 BF               	sub	_WAIT-1
     788.  00:4A6C  CA 61 4A            	jp	z,_rd_delay		; EOT found
     789.  00:4A6F  DD 77 13            	ld	(ix+TRACK_Delay),a
     790.  00:4A72  DD 77 14            	ld	(ix+TRACK_prevDelay),a
     791.  00:4A75  03                  	inc	bc
     792.  00:4A76                      	
     793.  00:4A76                      _replay_decode_trigger_porttone_check:	
     794.  00:4A76                      	;--- Check cmd active and note trigger?
     795.  00:4A76  CB 42               	bit 	B_TRGNOT,d
     796.  00:4A78  C8                  	ret	z
     797.  00:4A79  CB 5A               	bit	B_TRGCMD,d
     798.  00:4A7B  C8                  	ret	z
     799.  00:4A7C                      	;--- Check for cmd3 or cmd5 (value 0 or 1) to continue
     800.  00:4A7C  DD 7E F0            	ld	a,(ix+TRACK_Command)
     801.  00:4A7F  FE 02               	cp	2
     802.  00:4A81  D0                  	ret	nc
     803.  00:4A82                      	;-- trigger CMD
     804.  00:4A82  CB 82               	res	B_TRGNOT,d
     805.  00:4A84  3E 12               	ld	a,0010010b		;B_ACTNOT B_KEYON
     806.  00:4A86  B2                  	or	d
     807.  00:4A87  57                  	ld 	d,a
     808.  00:4A88  DD 7E 09            	ld	a,(ix+TRACK_cmd_3)
     809.  00:4A8B  C3 8D 4B            	jp	decode_cmd3_port_tone_new_note	
     810.  00:4A8E                      	;ret
     811.  00:4A8E                      
     812.  00:4A8E                      _replay_decode_note:
     813.  00:4A8E  DD 77 F6            	ld	(ix+TRACK_Note),a
     814.  00:4A91  CB C2               	set 	B_TRGNOT,d
     815.  00:4A93  CB E2               	set 	B_KEYON,d
     816.  00:4A95                      
     817.  00:4A95  03                  	inc	bc
     818.  00:4A96  0A                  	ld	a,(bc)
     819.  00:4A97  C3 3F 4A            	jp	_rdn
     820.  00:4A9A                      	
     821.  00:4A9A                      _replay_decode_release:
     822.  00:4A9A  CB 8A               	res	B_ACTNOT,d				; reset note bit to	0
     823.  00:4A9C  CB AA               	res	B_SUST,d				; rest sustain
     824.  00:4A9E  CB A2               	res	B_KEYON,d				; reset Key on
     825.  00:4AA0                      
     826.  00:4AA0  03                  	inc	bc
     827.  00:4AA1  0A                  	ld	a,(bc)
     828.  00:4AA2  C3 3F 4A            	jp	_rdn	
     829.  00:4AA5                      	
     830.  00:4AA5                      _replay_decode_sustain:
     831.  00:4AA5  CB 8A               	res	B_ACTNOT,d				; reset note bit to	0
     832.  00:4AA7  CB EA               	set	B_SUST,d				; rest sustain
     833.  00:4AA9  CB A2               	res	B_KEYON,d				; reset Key on
     834.  00:4AAB                      
     835.  00:4AAB  03                  	inc	bc
     836.  00:4AAC  0A                  	ld	a,(bc)
     837.  00:4AAD  C3 3F 4A            	jp	_rdn
     838.  00:4AB0                      
     839.  00:4AB0                      _replay_decode_ins:
     840.  00:4AB0  D6 71               	sub	_INS
     841.  00:4AB2  DD BE EF            	cp	(ix+TRACK_Instrument)
     842.  00:4AB5  CA E4 4A            	jp	z,.skip_ins
     843.  00:4AB8                      	
     844.  00:4AB8                      	;--- instrument change found	
     845.  00:4AB8  DD 77 EF            	ld	(ix+TRACK_Instrument),a
     846.  00:4ABB                      
     847.  00:4ABB                      	;--- set instrument pointer
     848.  00:4ABB  87                  	add	a
     849.  00:4ABC  2A 0B C0            	ld	hl,(replay_insbase)
     850.  00:4ABF  85                  	add	a,l
     851.  00:4AC0  6F                  	ld	l,a
     852.  00:4AC1  D2 C5 4A            	jp	nc,.skip
     853.  00:4AC4  24                  	inc	h
     854.  00:4AC5                      .skip:
     855.  00:4AC5  7E                  	ld	a,(hl)
     856.  00:4AC6  23                  	inc	hl
     857.  00:4AC7  66                  	ld	h,(hl)
     858.  00:4AC8  6F                  	ld	l,a
     859.  00:4AC9                      
     860.  00:4AC9                      	;-- get voice
     861.  00:4AC9  7E                  	ld	a,(hl)
     862.  00:4ACA  23                  	inc	hl
     863.  00:4ACB                      		
     864.  00:4ACB                      	;--- Set the software voice (if needed)
     865.  00:4ACB  A7                  	and	a
     866.  00:4ACC  C2 D5 4A            	jp	nz,.skip_soft
     867.  00:4ACF                      	;--- software voice found
     868.  00:4ACF                      	
     869.  00:4ACF  7E                  	ld	a,(hl)
     870.  00:4AD0  23                  	inc	hl
     871.  00:4AD1  32 BC C1            	ld 	(FM_softvoice_req),a
     872.  00:4AD4  AF                  	xor 	a
     873.  00:4AD5                      	
     874.  00:4AD5                      .skip_soft:
     875.  00:4AD5  DD 77 F8            	ld	(ix+TRACK_Voice),a
     876.  00:4AD8                      
     877.  00:4AD8                      	;--- Store the macro start
     878.  00:4AD8  DD 75 F1            	ld	(ix+TRACK_MacroPointer),l
     879.  00:4ADB  DD 74 F2            	ld	(ix+TRACK_MacroPointer+1),h	
     880.  00:4ADE                      	;--- Store the macro re-start
     881.  00:4ADE  DD 75 F3            	ld	(ix+TRACK_MacroStart),l
     882.  00:4AE1  DD 74 F4            	ld	(ix+TRACK_MacroStart+1),h
     883.  00:4AE4                      
     884.  00:4AE4                      	
     885.  00:4AE4                      .skip_ins:	
     886.  00:4AE4  03                  	inc	bc
     887.  00:4AE5  0A                  	ld	a,(bc)
     888.  00:4AE6  C3 47 4A            	jp	_rdi
     889.  00:4AE9                      
     890.  00:4AE9                      
     891.  00:4AE9                      
     892.  00:4AE9                      _replay_decode_vol:
     893.  00:4AE9  D6 61               	sub	_VOL-1
     894.  00:4AEB  87                  	add	a
     895.  00:4AEC  87                  	add	a
     896.  00:4AED  87                  	add	a
     897.  00:4AEE  87                  	add	a
     898.  00:4AEF                      	
     899.  00:4AEF                      	;--- Set new base	volume (high byte) but keep relative offset (low byte)
     900.  00:4AEF  5F                  	ld	e,a
     901.  00:4AF0  DD 7E F7            	ld	a,(ix+TRACK_Volume)
     902.  00:4AF3  E6 0F               	and	0xf
     903.  00:4AF5  B3                  	or	e
     904.  00:4AF6  DD 77 F7            	ld	(ix+TRACK_Volume),a
     905.  00:4AF9                      
     906.  00:4AF9  03                  	inc	bc
     907.  00:4AFA  0A                  	ld	a,(bc)
     908.  00:4AFB  C3 4F 4A            	jp	_rdv
     909.  00:4AFE                      
     910.  00:4AFE                      
     911.  00:4AFE                      
     912.  00:4AFE                      
     913.  00:4AFE                      
     914.  00:4AFE                      
     915.  00:4AFE                      
     916.  00:4AFE                      _replaydecode_cmd:
     917.  00:4AFE  D6 90               	sub	_CMD
     918.  00:4B00                      	
     919.  00:4B00                      	;[Debug]
     920.  00:4B00  FE 17               	cp	23
     921.  00:4B02  DA 07 4B            	jp	c,99f
     922.  00:4B05  F3                  	di
     923.  00:4B06  76                  	halt
     924.  00:4B07                      99:
     925.  00:4B07                      	;[Debug end]
     926.  00:4B07                      	
     927.  00:4B07  5F                  	ld	e,a				; store command for later
     928.  00:4B08  21 19 4B            	ld	hl,DECODE_CMDLIST
     929.  00:4B0B  87                  	add	a,a
     930.  00:4B0C  85                  	add	a,l
     931.  00:4B0D  6F                  	ld	l,a
     932.  00:4B0E  D2 12 4B            	jp	nc,.skip
     933.  00:4B11  24                  	inc	h
     934.  00:4B12                      .skip:
     935.  00:4B12  7E                  	ld	a,(hl)
     936.  00:4B13  23                  	inc	hl
     937.  00:4B14  66                  	ld	h,(hl)
     938.  00:4B15  6F                  	ld	l,a
     939.  00:4B16                      	
     940.  00:4B16  03                  	inc	bc
     941.  00:4B17  0A                  	ld	a,(bc)
     942.  00:4B18  E9                  	jp	(hl)
     943.  00:4B19                      
     944.  00:4B19                      
     945.  00:4B19                      DECODE_CMDLIST:
     946.  00:4B19                      	; Primary
     947.  00:4B19  70 4B               	dw	decode_cmd3_port_tone
     948.  00:4B1B  01 4C               	dw	decode_cmd5_vibrato_port_tone
     949.  00:4B1D  65 4B               	dw	decode_cmd2_port_down
     950.  00:4B1F  47 4B               	dw	decode_cmd0_arpeggio
     951.  00:4B21  D1 4B               	dw	decode_cmd4_vibrato
     952.  00:4B23  5A 4B               	dw	decode_cmd1_port_up
     953.  00:4B25  18 4C               	dw	decode_cmd6_vibrato_vol	
     954.  00:4B27  18 4C               	dw	decode_cmd7_vol_slide
     955.  00:4B29  D1 4B               	dw	decode_cmd8_tremelo
     956.  00:4B2B  28 4C               	dw	decode_cmd9_note_cut
     957.  00:4B2D  33 4C               	dw	decode_cmd10_note_delay
     958.  00:4B2F                      	; Secondary
     959.  00:4B2F  51 4C               	dw	decode_cmd11_command_end
     960.  00:4B31  56 4C               	dw	decode_cmd12_drum
     961.  00:4B33  7C 4C               	dw	decode_cmd13_arp_speed
     962.  00:4B35  82 4C               	dw	decode_cmd14_fine_up
     963.  00:4B37  8C 4C               	dw	decode_cmd15_fine_down
     964.  00:4B39  99 4C               	dw	decode_cmd16_notelink
     965.  00:4B3B  A1 4C               	dw	decode_cmd17_track_detune
     966.  00:4B3D  C0 4C               	dw	decode_cmd18_trigger
     967.  00:4B3F  C6 4C               	dw	decode_cmd19_speed
     968.  00:4B41                      	; SoundChip Specific
     969.  00:4B41  D9 4C               	dw	decode_cmd20_tone_panning
     970.  00:4B43  DC 4C               	dw	decode_cmd21_noise_panning
     971.  00:4B45  DF 4C               	dw	decode_cmd22_chan_setup	
     972.  00:4B47                      	
     973.  00:4B47                      
     974.  00:4B47                      decode_cmd0_arpeggio:
     975.  00:4B47                      	; in:	[A] contains the paramvalue
     976.  00:4B47                      	; 
     977.  00:4B47                      	; ! do not change	[BC] this is the data pointer
     978.  00:4B47                      	;--------------------------------------------------
     979.  00:4B47  DD 77 06            	ld	(ix+TRACK_cmd_0),a
     980.  00:4B4A  DD 73 F0            	ld	(ix+TRACK_Command),e
     981.  00:4B4D  CB DA               	set	B_TRGCMD,d
     982.  00:4B4F  DD 36 11 00         	ld	(ix+TRACK_Timer),0
     983.  00:4B53  DD 36 12 02         	ld	(ix+TRACK_Step),2
     984.  00:4B57  C3 57 4A            	jp	_rdc
     985.  00:4B5A                      
     986.  00:4B5A                      
     987.  00:4B5A                      	
     988.  00:4B5A                      decode_cmd1_port_up:
     989.  00:4B5A                      	; in:	[A] contains the paramvalue
     990.  00:4B5A                      	; 
     991.  00:4B5A                      	; ! do not change	[BC] this is the data pointer
     992.  00:4B5A                      	;--------------------------------------------------
     993.  00:4B5A  DD 73 F0            	ld	(ix+TRACK_Command),e
     994.  00:4B5D  DD 77 07            	ld	(ix+TRACK_cmd_1),a
     995.  00:4B60  CB DA               	set	B_TRGCMD,d
     996.  00:4B62  C3 57 4A            	jp	_rdc
     997.  00:4B65                      	
     998.  00:4B65                      	 
     999.  00:4B65                      	 
    1000.  00:4B65                      decode_cmd2_port_down:
    1001.  00:4B65                      	; in:	[A] contains the paramvalue
    1002.  00:4B65                      	; 
    1003.  00:4B65                      	; ! do1_ not change	[BC] this is the data pointer
    1004.  00:4B65                      	;--------------------------------------------------
    1005.  00:4B65  DD 73 F0            	ld	(ix+TRACK_Command),e
    1006.  00:4B68  DD 77 08            	ld	(ix+TRACK_cmd_2),a
    1007.  00:4B6B  CB DA               	set	B_TRGCMD,d
    1008.  00:4B6D  C3 57 4A            	jp	_rdc
    1009.  00:4B70                      
    1010.  00:4B70                      
    1011.  00:4B70                      decode_cmd3_port_tone:
    1012.  00:4B70                      	; in:	[A] contains the param value
    1013.  00:4B70                      	; 
    1014.  00:4B70                      	; ! do not change	[BC] this is the data pointer
    1015.  00:4B70                      	;--------------------------------------------------
    1016.  00:4B70  DD 73 F0            	ld	(ix+TRACK_Command),e
    1017.  00:4B73  CB DA               	set	B_TRGCMD,d
    1018.  00:4B75  CB CA               	set	B_ACTNOT,d
    1019.  00:4B77                      	
    1020.  00:4B77  DD 77 09            	ld	(ix+TRACK_cmd_3),a
    1021.  00:4B7A  DD 36 11 02         	ld	(ix+TRACK_Timer),2
    1022.  00:4B7E                      
    1023.  00:4B7E                      ;decode_cmd3_port_tone_cont:
    1024.  00:4B7E                      	;--- Check if we have a	note on the	same event
    1025.  00:4B7E  CB 42               	bit	B_TRGNOT,d
    1026.  00:4B80  CA 57 4A            	jp	z,_rdc
    1027.  00:4B83                      
    1028.  00:4B83  CB E2               	set	B_KEYON,d
    1029.  00:4B85  CB 82               	res 	B_TRGNOT,d
    1030.  00:4B87                      	
    1031.  00:4B87  CD 8D 4B            	call	decode_cmd3_port_tone_new_note
    1032.  00:4B8A  C3 57 4A            	jp	_rdc
    1033.  00:4B8D                      	
    1034.  00:4B8D                      decode_cmd3_port_tone_new_note:
    1035.  00:4B8D                      	;-- remove deviation from parameter
    1036.  00:4B8D  E6 7F               	and 	$7f
    1037.  00:4B8F  08                  	ex	af,af'		;'
    1038.  00:4B90  D9                  	exx
    1039.  00:4B91                      
    1040.  00:4B91                      	;-- get the	previous note freq
    1041.  00:4B91  3A 28 C0            	ld	a,(replay_previous_note)
    1042.  00:4B94  87                  	add	a
    1043.  00:4B95  2A 2D C0            	ld	hl,(replay_tonetable)
    1044.  00:4B98  85                  	add	a,l
    1045.  00:4B99  6F                  	ld	l,a
    1046.  00:4B9A  D2 9E 4B            	jp	nc,.skip
    1047.  00:4B9D  24                  	inc	h
    1048.  00:4B9E                      .skip:
    1049.  00:4B9E  5E                  	ld	e,(hl)
    1050.  00:4B9F  23                  	inc	hl
    1051.  00:4BA0  56                  	ld	d,(hl)
    1052.  00:4BA1                      
    1053.  00:4BA1                      	; add	the toneadd
    1054.  00:4BA1  DD 6E 00            	ld	l,(ix+TRACK_cmd_ToneSlideAdd)
    1055.  00:4BA4  DD 66 01            	ld	h,(ix+TRACK_cmd_ToneSlideAdd+1)
    1056.  00:4BA7                      
    1057.  00:4BA7  19                  	add	hl,de	
    1058.  00:4BA8  EB                  	ex	de,hl				; store current freq in	[de]
    1059.  00:4BA9                      	;--- get the current note freq
    1060.  00:4BA9  DD 7E F6            	ld	a,(ix+TRACK_Note)
    1061.  00:4BAC  87                  	add	a
    1062.  00:4BAD  2A 2D C0            	ld	hl,(replay_tonetable)	;TRACK_ToneTable
    1063.  00:4BB0  85                  	add	a,l
    1064.  00:4BB1  6F                  	ld	l,a
    1065.  00:4BB2  D2 B6 4B            	jp	nc,.skip2
    1066.  00:4BB5  24                  	inc	h
    1067.  00:4BB6                      .skip2:
    1068.  00:4BB6  7E                  	ld	a,(hl)
    1069.  00:4BB7  23                  	inc	hl
    1070.  00:4BB8  66                  	ld	h,(hl)
    1071.  00:4BB9  6F                  	ld	l,a				; destination freq in [hl]
    1072.  00:4BBA                      	
    1073.  00:4BBA                      	;--- Calculate the delta
    1074.  00:4BBA  AF                  	xor	a
    1075.  00:4BBB  EB                  	ex	de,hl
    1076.  00:4BBC  ED 52               	sbc	hl,de				; results in pos/neg delta
    1077.  00:4BBE                      	
    1078.  00:4BBE  DD 75 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),l
    1079.  00:4BC1  DD 74 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),h
    1080.  00:4BC4                      	
    1081.  00:4BC4                      	;--- re-apply deviation
    1082.  00:4BC4  08                  	ex	af,af'			;'
    1083.  00:4BC5  CB 7C               	bit	7,h
    1084.  00:4BC7  C2 CC 4B            	jp	nz,99f
    1085.  00:4BCA  F6 80               	or 	128
    1086.  00:4BCC                      99:
    1087.  00:4BCC  DD 77 09            	ld 	(ix+TRACK_cmd_3),a
    1088.  00:4BCF                      	
    1089.  00:4BCF  D9                  	exx					; restore flags in D
    1090.  00:4BD0  C9                  	ret
    1091.  00:4BD1                      	
    1092.  00:4BD1                      	
    1093.  00:4BD1                      decode_cmd8_tremelo:
    1094.  00:4BD1                      	; in:	[A] contains the paramvalue
    1095.  00:4BD1                      	; 
    1096.  00:4BD1                      	; ! do not change	[BC] this is the data pointer
    1097.  00:4BD1                      	;--------------------------------------------------
    1098.  00:4BD1                      decode_cmd4_vibrato:
    1099.  00:4BD1                      	; in:	[A] contains the paramvalue
    1100.  00:4BD1                      	; 
    1101.  00:4BD1                      	; ! do not change	[BC] this is the data pointer
    1102.  00:4BD1                      	;--------------------------------------------------
    1103.  00:4BD1                      	; Vibrato with speed x and depth y.	This command 
    1104.  00:4BD1                      	; will oscillate the frequency of the current note
    1105.  00:4BD1                      	; with a sine wave. 
    1106.  00:4BD1                      	;
    1107.  00:4BD1                      	; high 3 bits is depth (0-7) (direct offset in sinetable)
    1108.  00:4BD1                      	; low 5 bits is the speed. 1-16
    1109.  00:4BD1                      	;--- Init values
    1110.  00:4BD1  DD 73 F0            	ld	(ix+TRACK_Command),e
    1111.  00:4BD4  5F                  	ld	e,a
    1112.  00:4BD5                      	
    1113.  00:4BD5                      	;--- Set the speed
    1114.  00:4BD5  E6 0F               	and	$0f
    1115.  00:4BD7  CA E2 4B            	jp	z,.depth
    1116.  00:4BDA  DD 77 0C            	ld	(ix+TRACK_cmd_4_step),a	
    1117.  00:4BDD  ED 44               	neg	
    1118.  00:4BDF  DD 77 12            	ld	(ix+TRACK_Step),a	
    1119.  00:4BE2                      	
    1120.  00:4BE2                      .depth:
    1121.  00:4BE2                      	;-- set the depth
    1122.  00:4BE2  7B                  	ld	a,e
    1123.  00:4BE3  E6 F0               	and	$f0
    1124.  00:4BE5  CA FC 4B            	jp	z,.end		; set depth when 0 only when command was not active.
    1125.  00:4BE8                      
    1126.  00:4BE8                      ;	sub	16
    1127.  00:4BE8  21 7C 54            	ld	hl,TRACK_Vibrato_sine-16
    1128.  00:4BEB  87                  	add	a,a
    1129.  00:4BEC  D2 F0 4B            	jp	nc,99f
    1130.  00:4BEF  24                  	inc	h
    1131.  00:4BF0                      99:	
    1132.  00:4BF0  85                  	add	a,l
    1133.  00:4BF1  6F                  	ld 	l,a
    1134.  00:4BF2  D2 F6 4B            	jp	nc,99f
    1135.  00:4BF5  24                  	inc	h
    1136.  00:4BF6                      99:
    1137.  00:4BF6  DD 75 0A            	ld	(ix+TRACK_cmd_4_depth),l
    1138.  00:4BF9  DD 74 0B            	ld	(ix+TRACK_cmd_4_depth+1),h
    1139.  00:4BFC                      	
    1140.  00:4BFC                      .end:	
    1141.  00:4BFC  CB DA               	set	B_TRGCMD,d
    1142.  00:4BFE  C3 57 4A            	jp	_rdc	
    1143.  00:4C01                      
    1144.  00:4C01                      
    1145.  00:4C01                      decode_cmd5_vibrato_port_tone:
    1146.  00:4C01                      	; in:	[A] contains the paramvalue
    1147.  00:4C01                      	; 
    1148.  00:4C01                      	; ! do not change	[BC] this is the data pointer
    1149.  00:4C01                      	;--------------------------------------------------
    1150.  00:4C01                      	; portTone	+ volumeslide
    1151.  00:4C01                      	;--- Init values
    1152.  00:4C01  DD 73 F0            	ld	(ix+TRACK_Command),e
    1153.  00:4C04  DD 77 0E            	ld	(ix+TRACK_cmd_A),a
    1154.  00:4C07  CB DA               	set	B_TRGCMD,d
    1155.  00:4C09                      	
    1156.  00:4C09                      	;-- Check if new note
    1157.  00:4C09  CB 42               	bit	B_TRGNOT,d
    1158.  00:4C0B  CA 57 4A            	jp	z,_rdc
    1159.  00:4C0E                      	
    1160.  00:4C0E                      	;-- Set new port tone value
    1161.  00:4C0E  CB E2               	set	B_KEYON,d
    1162.  00:4C10  CB 82               	res	B_TRGNOT,d
    1163.  00:4C12  DD 7E 09            	ld	a,(ix+TRACK_cmd_3)
    1164.  00:4C15  C3 8D 4B            	jp	decode_cmd3_port_tone_new_note
    1165.  00:4C18                      	
    1166.  00:4C18                      	
    1167.  00:4C18                      	
    1168.  00:4C18                      decode_cmd6_vibrato_vol:
    1169.  00:4C18                      	; in:	[A] contains the paramvalue
    1170.  00:4C18                      	; 
    1171.  00:4C18                      	; ! do not change	[BC] this is the data pointer
    1172.  00:4C18                      	;--------------------------------------------------
    1173.  00:4C18                      decode_cmd7_vol_slide:
    1174.  00:4C18                      	; in:	[A] contains the paramvalue
    1175.  00:4C18                      	; 
    1176.  00:4C18                      	; ! do not change	[BC] this is the data pointer
    1177.  00:4C18                      	;--------------------------------------------------
    1178.  00:4C18  DD 73 F0            	ld	(ix+TRACK_Command),e	
    1179.  00:4C1B  DD 77 0E            	ld	(ix+TRACK_cmd_A),a
    1180.  00:4C1E  E6 7F               	and  	$7f
    1181.  00:4C20  DD 77 11            	ld	(ix+TRACK_Timer),a
    1182.  00:4C23  CB DA               	set	B_TRGCMD,d
    1183.  00:4C25  C3 57 4A            	jp	_rdc
    1184.  00:4C28                      
    1185.  00:4C28                      decode_cmd9_note_cut:
    1186.  00:4C28  CB DA               	set	B_TRGCMD,d
    1187.  00:4C2A  DD 73 F0            	ld	(ix+TRACK_Command),e
    1188.  00:4C2D  DD 77 11            	ld	(ix+TRACK_Timer),a		; set	the timer to param y
    1189.  00:4C30  C3 57 4A            	jp 	_rdc
    1190.  00:4C33                      
    1191.  00:4C33                      
    1192.  00:4C33                      decode_cmd10_note_delay:
    1193.  00:4C33  CB 42               	bit	B_TRGNOT,d		; is there a note	in this eventstep?
    1194.  00:4C35  CA 57 4A            	jp	z,_rdc
    1195.  00:4C38                      
    1196.  00:4C38  CB DA               	set	B_TRGCMD,d					; command active
    1197.  00:4C3A  CB 82               	res	B_TRGNOT,d					; reset any	trigger note
    1198.  00:4C3C  DD 73 F0            	ld	(ix+TRACK_Command),e
    1199.  00:4C3F                      	
    1200.  00:4C3F  DD 77 11            	ld	(ix+TRACK_Timer),a			; set	the timer to param y
    1201.  00:4C42  DD 7E F6            	ld	a,(ix+TRACK_Note)
    1202.  00:4C45  DD 77 10            	ld	(ix+TRACK_cmd_E),a			; store the	new note
    1203.  00:4C48  3A 28 C0            	ld	a,(replay_previous_note)
    1204.  00:4C4B  DD 77 F6            	ld	(ix+TRACK_Note),a				; restore the old	note
    1205.  00:4C4E  C3 57 4A            	jp	_rdc	
    1206.  00:4C51                      
    1207.  00:4C51                      
    1208.  00:4C51                      decode_cmd11_command_end:
    1209.  00:4C51                      	; in:	[A] contains the paramvalue
    1210.  00:4C51                      	; 
    1211.  00:4C51                      	; ! do not change	[BC] this is the data pointer
    1212.  00:4C51                      	;--------------------------------------------------
    1213.  00:4C51  CB 9A               	res	B_TRGCMD,d
    1214.  00:4C53  C3 58 4A            	jp	_rdc_noinc
    1215.  00:4C56                      	
    1216.  00:4C56                      
    1217.  00:4C56                      decode_cmd12_drum:
    1218.  00:4C56  A7                  	and 	a		; drum reset not supported
    1219.  00:4C57  28 1F               	jr 	z,0f
    1220.  00:4C59                      	
    1221.  00:4C59                      	; Get the base addres of the drum list
    1222.  00:4C59  87                  	add 	a 
    1223.  00:4C5A  2A 09 C0            	ld	hl,(replay_drumbase)
    1224.  00:4C5D  85                  	add	a,l 
    1225.  00:4C5E  6F                  	ld	l,a
    1226.  00:4C5F  D2 63 4C            	jp	nc,99f
    1227.  00:4C62  24                  	inc	h 
    1228.  00:4C63                      99:
    1229.  00:4C63  6F                  	ld	l,a
    1230.  00:4C64                      	; Get the start of the drum macro
    1231.  00:4C64  7E                  	ld	a,(hl)
    1232.  00:4C65  23                  	inc	hl
    1233.  00:4C66  66                  	ld	h,(hl)
    1234.  00:4C67  6F                  	ld	l,a
    1235.  00:4C68                      	
    1236.  00:4C68                      	; Store the length
    1237.  00:4C68  7E                  	ld	a,(hl)
    1238.  00:4C69  32 B9 C1            	ld	(FM_DRUM_LEN),a
    1239.  00:4C6C  23                  	inc	hl
    1240.  00:4C6D                      	; Store the address
    1241.  00:4C6D  7D                  	ld	a,l
    1242.  00:4C6E  32 BA C1            	ld 	(FM_DRUM_MACRO),a
    1243.  00:4C71  7C                  	ld	a,h
    1244.  00:4C72  32 BB C1            	ld	(FM_DRUM_MACRO+1),a
    1245.  00:4C75  C3 57 4A            	jp	_rdc		
    1246.  00:4C78                      0:
    1247.  00:4C78  0B                  	dec	bc
    1248.  00:4C79  C3 57 4A            	jp	_rdc		
    1249.  00:4C7C                      	
    1250.  00:4C7C                      
    1251.  00:4C7C                      decode_cmd13_arp_speed:
    1252.  00:4C7C  32 24 C0            	ld	(replay_arp_speed),a		; store the halve not to add
    1253.  00:4C7F  C3 57 4A            	jp	_rdc	
    1254.  00:4C82                      	
    1255.  00:4C82                      	
    1256.  00:4C82                      decode_cmd14_fine_up:
    1257.  00:4C82  DD 77 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),a
    1258.  00:4C85  AF                  	xor	a
    1259.  00:4C86  DD 77 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),a
    1260.  00:4C89  C3 57 4A            	jp	_rdc
    1261.  00:4C8C                      	
    1262.  00:4C8C                      decode_cmd15_fine_down:
    1263.  00:4C8C  DD 77 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),a
    1264.  00:4C8F  3E FF               	ld	a,$ff
    1265.  00:4C91  DD 77 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),a
    1266.  00:4C94  CB 9A               	res	B_TRGCMD,d		; command active
    1267.  00:4C96  C3 57 4A            	jp	_rdc
    1268.  00:4C99                      
    1269.  00:4C99                      
    1270.  00:4C99                      decode_cmd16_notelink:
    1271.  00:4C99  CB 82               	res	B_TRGNOT,d
    1272.  00:4C9B  CB E2               	set 	B_KEYON,d
    1273.  00:4C9D  0B                  	dec 	bc
    1274.  00:4C9E  C3 57 4A            	jp	_rdc	
    1275.  00:4CA1                      
    1276.  00:4CA1                      decode_cmd17_track_detune:
    1277.  00:4CA1                      	; This command sets the	detune of the track.
    1278.  00:4CA1  5F                  	ld	e,a
    1279.  00:4CA2  E6 07               	and	0x07		; low	4 bits is value
    1280.  00:4CA4  CB 5B               	bit	3,e		; Center around 8
    1281.  00:4CA6  CA B6 4C            	jp	z,.pos
    1282.  00:4CA9  3C                  	inc	a
    1283.  00:4CAA  ED 44               	neg			; make correct value
    1284.  00:4CAC  DD 77 04            	ld	(ix+TRACK_cmd_detune),a
    1285.  00:4CAF  DD 36 05 FF         	ld	(ix+TRACK_cmd_detune+1),0xff
    1286.  00:4CB3                      
    1287.  00:4CB3  C3 57 4A            	jp	_rdc	
    1288.  00:4CB6                      
    1289.  00:4CB6                      .pos:
    1290.  00:4CB6  DD 77 04            	ld	(ix+TRACK_cmd_detune),a
    1291.  00:4CB9  DD 36 05 00         	ld	(ix+TRACK_cmd_detune+1),0x00	
    1292.  00:4CBD                      
    1293.  00:4CBD  C3 57 4A            	jp	_rdc	
    1294.  00:4CC0                      
    1295.  00:4CC0                      
    1296.  00:4CC0                      
    1297.  00:4CC0                      decode_cmd18_trigger:
    1298.  00:4CC0  32 02 C0            	ld	(replay_trigger),a
    1299.  00:4CC3  C3 57 4A            	jp	_rdc		
    1300.  00:4CC6                      
    1301.  00:4CC6                      
    1302.  00:4CC6                      decode_cmd19_speed:
    1303.  00:4CC6  32 1F C0            	ld	(replay_speed),a
    1304.  00:4CC9                      	;--- Reset Timer == 0
    1305.  00:4CC9  CB 3F               	srl	a				; divide speed with 2
    1306.  00:4CCB  5F                  	ld	e,a
    1307.  00:4CCC  3E 00               	ld	a,0				
    1308.  00:4CCE  8F                  	adc	a				; store carry of shift as subtimer
    1309.  00:4CCF  32 20 C0            	ld	(replay_speed_subtimer),a
    1310.  00:4CD2  83                  	add	a,e
    1311.  00:4CD3  32 21 C0            	ld	(replay_speed_timer),a
    1312.  00:4CD6                      
    1313.  00:4CD6  C3 57 4A            	jp	_rdc	
    1314.  00:4CD9                      	
    1315.  00:4CD9                      decode_cmd20_tone_panning:
    1316.  00:4CD9  C3 57 4A            	jp	_rdc	
    1317.  00:4CDC                      
    1318.  00:4CDC                      decode_cmd21_noise_panning:
    1319.  00:4CDC  C3 57 4A            	jp	_rdc
    1320.  00:4CDF                      
    1321.  00:4CDF                      decode_cmd22_chan_setup:
    1322.  00:4CDF  C3 57 4A            	jp	_rdc
    1323.  00:4CE2                      
    1324.  00:4CE2                      
    1325.  00:4CE2                      
    1326.  00:4CE2                      ;===========================================================
    1327.  00:4CE2                      ; ---process_data_chan
    1328.  00:4CE2                      ; Process the cmd/instrument/note and vol data 
    1329.  00:4CE2                      ; 
    1330.  00:4CE2                      ; in HL is the current tone freq
    1331.  00:4CE2                      ; in D is TRACK_FLAGS  
    1332.  00:4CE2                      ;===========================================================
    1333.  00:4CE2                      process_data_chan:
    1334.  00:4CE2  E5                  	push	hl
    1335.  00:4CE3                      
    1336.  00:4CE3                      	;-- set the	mixer	right
    1337.  00:4CE3  21 BE C1            	ld	hl,FM_regMIXER   
    1338.  00:4CE6  CB 0E               	rrc	(hl)
    1339.  00:4CE8                      
    1340.  00:4CE8                      	;===== 
    1341.  00:4CE8                      	; Speed equalization check
    1342.  00:4CE8                      	;=====
    1343.  00:4CE8  3A 31 C0            	ld	a,(equalization_flag)			; check for speed equalization
    1344.  00:4CEB  A7                  	and	a
    1345.  00:4CEC  C2 3D 4D            	jp	nz,process_noNoteTrigger		; Only process instruments macro
    1346.  00:4CEF                      	
    1347.  00:4CEF                      	
    1348.  00:4CEF                      	;=====
    1349.  00:4CEF                      	; COMMAND
    1350.  00:4CEF                      	;=====
    1351.  00:4CEF  DD 36 0D 00         	ld	(ix+TRACK_cmd_NoteAdd),0			; Always reset note add
    1352.  00:4CF3                      	
    1353.  00:4CF3  CB 5A               	bit	B_TRGCMD,d	;(ix+TRACK_Flags)
    1354.  00:4CF5  CA 14 4D            	jp	z,process_note
    1355.  00:4CF8                      
    1356.  00:4CF8  21 B3 4E            	ld	hl,PROCESS_CMDLIST
    1357.  00:4CFB  DD 7E F0            	ld	a,(ix+TRACK_Command)
    1358.  00:4CFE                      ;[DEBUG]	
    1359.  00:4CFE  FE 0B               	cp	11
    1360.  00:4D00  DA 08 4D            	jp	c,99f
    1361.  00:4D03  F3                  	di
    1362.  00:4D04  76                  1:	halt
    1363.  00:4D05  C3 04 4D            	jp	1b
    1364.  00:4D08                      
    1365.  00:4D08                      99:
    1366.  00:4D08                      ;[/DEBUG]
    1367.  00:4D08  87                  	add	a
    1368.  00:4D09  85                  	add	a,l
    1369.  00:4D0A  6F                  	ld	l,a
    1370.  00:4D0B  D2 0F 4D            	jp	nc,.skip
    1371.  00:4D0E  24                  	inc	h
    1372.  00:4D0F                      .skip:
    1373.  00:4D0F  7E                  	ld	a,(hl)
    1374.  00:4D10  23                  	inc	hl
    1375.  00:4D11  66                  	ld	h,(hl)
    1376.  00:4D12  6F                  	ld	l,a	
    1377.  00:4D13  E9                  	jp	(hl)
    1378.  00:4D14                      
    1379.  00:4D14                      
    1380.  00:4D14                      process_commandEND:
    1381.  00:4D14                      process_note:
    1382.  00:4D14                      
    1383.  00:4D14                      	;=====
    1384.  00:4D14                      	; NOTE
    1385.  00:4D14                      	;=====
    1386.  00:4D14                      	;--- Check if we need to trigger a new note
    1387.  00:4D14  CB 42               	bit	B_TRGNOT,d	;(ix+TRACK_Flags)
    1388.  00:4D16  CA 3D 4D            	jp	z,process_noNoteTrigger
    1389.  00:4D19                      	
    1390.  00:4D19                      
    1391.  00:4D19                      process_triggerNote:	
    1392.  00:4D19                      	;--- get new Note
    1393.  00:4D19  CB 82               	res	B_TRGNOT,d		;(ix+TRACK_Flags)		; reset trigger note flag
    1394.  00:4D1B  CB CA               	set	B_ACTNOT,d		;(ix+TRACK_Flags)		; set	note active	flag
    1395.  00:4D1D                      
    1396.  00:4D1D  DD 6E F3            	ld	l,(ix+TRACK_MacroStart)
    1397.  00:4D20  DD 66 F4            	ld	h,(ix+TRACK_MacroStart+1)
    1398.  00:4D23                      	;--- Store the macro start	
    1399.  00:4D23  DD 75 F1            	ld	(ix+TRACK_MacroPointer),l
    1400.  00:4D26  DD 74 F2            	ld	(ix+TRACK_MacroPointer+1),h	
    1401.  00:4D29                      
    1402.  00:4D29  21 00 00            	ld	hl,0
    1403.  00:4D2C  ED 73 00 C0         	ld	(_SP_Storage),sp
    1404.  00:4D30  DD F9               	ld	sp,ix
    1405.  00:4D32  F1                  	pop	af
    1406.  00:4D33  F1                  	pop	af
    1407.  00:4D34  E5                  	push	hl
    1408.  00:4D35  E5                  	push	hl		
    1409.  00:4D36  E5                  	push	hl
    1410.  00:4D37  E5                  	push	hl
    1411.  00:4D38  E5                  	push	hl
    1412.  00:4D39  ED 7B 00 C0         	ld	sp,(_SP_Storage)
    1413.  00:4D3D                      
    1414.  00:4D3D                      ;	ld	(ix+TRACK_ToneAdd),0
    1415.  00:4D3D                      ;	ld	(ix+TRACK_ToneAdd+1),0
    1416.  00:4D3D                      ;	ld	(ix+TRACK_VolumeAdd),0	
    1417.  00:4D3D                      ;	ld	(ix+TRACK_cmd_ToneAdd),0
    1418.  00:4D3D                      ;	ld	(ix+TRACK_cmd_ToneAdd+1),0
    1419.  00:4D3D                      ;	ld	(ix+TRACK_cmd_VolumeAdd),0
    1420.  00:4D3D                      ;	ld	(ix+TRACK_Noise),0
    1421.  00:4D3D                      ;	ld	(ix+TRACK_cmd_ToneSlideAdd),0
    1422.  00:4D3D                      ;	ld	(ix+TRACK_cmd_ToneSlideAdd+1),0
    1423.  00:4D3D                      
    1424.  00:4D3D                      process_noNoteTrigger:
    1425.  00:4D3D                      	;Get note freq
    1426.  00:4D3D  DD 7E F6            	ld	a,(ix+TRACK_Note)
    1427.  00:4D40  DD 86 0D            	add	a,(ix+TRACK_cmd_NoteAdd)
    1428.  00:4D43  87                  	add	a
    1429.  00:4D44  08                  	ex	af,af'			;'store the	note offset
    1430.  00:4D45                      
    1431.  00:4D45                      	;==============
    1432.  00:4D45                      	; Macro instrument
    1433.  00:4D45                      	;==============
    1434.  00:4D45  CB 4A               	bit	B_ACTNOT,d			
    1435.  00:4D47  CA A0 4E            	jp	z,process_noNoteActive
    1436.  00:4D4A                      	
    1437.  00:4D4A                      	;--- Get the macro len and loop
    1438.  00:4D4A  DD 6E F1            	ld	l,(ix+TRACK_MacroPointer)
    1439.  00:4D4D  DD 66 F2            	ld	h,(ix+TRACK_MacroPointer+1)
    1440.  00:4D50                      
    1441.  00:4D50  5E                  	ld	e,(hl)				; info byte
    1442.  00:4D51  23                  	inc	hl
    1443.  00:4D52  CB 5B               	bit	3,e					; Volume change
    1444.  00:4D54  C2 5D 4D            	jp	nz,_vol_change
    1445.  00:4D57  DD 7E FD            	ld	a,(ix+TRACK_VolumeAdd)
    1446.  00:4D5A  C3 7A 4D            	jp	_noVolumeChange
    1447.  00:4D5D                      	
    1448.  00:4D5D                      	;--- Volume change
    1449.  00:4D5D                      _vol_change:
    1450.  00:4D5D  7E                  	ld	a,(hl)
    1451.  00:4D5E  23                  	inc	hl
    1452.  00:4D5F                      	
    1453.  00:4D5F  CB 53               	bit	2,e
    1454.  00:4D61  CA 77 4D            	jp	z,_vol_base
    1455.  00:4D64                      _vol_rel:
    1456.  00:4D64  DD 86 FD            	add	 (ix+TRACK_VolumeAdd)
    1457.  00:4D67  FE 10               	cp	16
    1458.  00:4D69  DA 77 4D            	jp	c,_vol_base
    1459.  00:4D6C  FE 80               	cp	128
    1460.  00:4D6E  D2 76 4D            	jp	nc,.skip
    1461.  00:4D71  3E 0F               	ld	a,$0f
    1462.  00:4D73  C3 77 4D            	jp	_vol_base
    1463.  00:4D76                      .skip:	
    1464.  00:4D76  AF                  	xor	a
    1465.  00:4D77                      	
    1466.  00:4D77                      _vol_base:
    1467.  00:4D77  DD 77 FD            	ld	(ix+TRACK_VolumeAdd),a
    1468.  00:4D7A                      
    1469.  00:4D7A                      	;---- envelope check
    1470.  00:4D7A                      	; is done here to be able to continue
    1471.  00:4D7A                      	; macro volume values.
    1472.  00:4D7A                      ;	bit	B_TRGENV,d		;'(IX+TRACK_Flags)
    1473.  00:4D7A                      ;	jp	z,_noEnv		; if not set then normal volume calculation
    1474.  00:4D7A                      ;	ld	a,16			; set volume to 16 == envelope
    1475.  00:4D7A                      ;	ld	(FM_regVOLF),a
    1476.  00:4D7A                      ;	jp	_noVolume	
    1477.  00:4D7A                      	
    1478.  00:4D7A                      _noVolumeChange:
    1479.  00:4D7A  DD B6 F7            	or	(ix+TRACK_Volume)
    1480.  00:4D7D  4F                  	ld	c,a			; store volume add
    1481.  00:4D7E                      
    1482.  00:4D7E  DD 7E FF            	ld 	a,(ix+TRACK_cmd_VolumeAdd)
    1483.  00:4D81                      ;	rla				; shift to detect shift
    1484.  00:4D81                      ;	jp 	c,.sub_Vadd		
    1485.  00:4D81                      ;.add_Vadd:  
    1486.  00:4D81                      ;	add	a,c
    1487.  00:4D81                      ;	jp	nc,_Vadd
    1488.  00:4D81                      ;	ld	a,c
    1489.  00:4D81                      ;	or	0xf0
    1490.  00:4D81                      ;	jp	_Vadd	
    1491.  00:4D81                      ;.sub_Vadd:	
    1492.  00:4D81  47                  	ld	b,a
    1493.  00:4D82                      ;	xor	a
    1494.  00:4D82                      ;	sub 	b
    1495.  00:4D82                      ;	ld	b,a
    1496.  00:4D82  79                  	ld	a,c
    1497.  00:4D83  90                  	sub	a,b
    1498.  00:4D84  D2 8A 4D            	jp 	nc,.skip2
    1499.  00:4D87  79                  	ld	a,c
    1500.  00:4D88  E6 0F                	and	0x0f
    1501.  00:4D8A                      .skip2:
    1502.  00:4D8A                      
    1503.  00:4D8A                      	
    1504.  00:4D8A                      	;-- next is _Vadd
    1505.  00:4D8A                      _Vadd:
    1506.  00:4D8A                      	;--- apply main volume balance
    1507.  00:4D8A  ED 4B 29 C0         	ld	bc,(replay_mainvol)
    1508.  00:4D8E  81                  	add	a,c
    1509.  00:4D8F  4F                  	ld	c,a
    1510.  00:4D90  D2 94 4D            	jp	nc,.skip
    1511.  00:4D93  04                  	inc	b
    1512.  00:4D94                      .skip:
    1513.  00:4D94  0A                  	ld	a,(bc)	
    1514.  00:4D95                      	; Test which CHIP.
    1515.  00:4D95  CB 7A               	bit	B_PSGFM,d		;(ix+TRACK_Flags)
    1516.  00:4D97  C2 9E 4D            	jp	nz,.skip2
    1517.  00:4D9A  1F                  	rra
    1518.  00:4D9B  1F                  	rra
    1519.  00:4D9C  1F                  	rra
    1520.  00:4D9D  1F                  	rra
    1521.  00:4D9E                      .skip2:
    1522.  00:4D9E  E6 0F               	and	0x0f
    1523.  00:4DA0  32 9A C1            	ld	(FM_regVOLF),a
    1524.  00:4DA3                      
    1525.  00:4DA3                      _noVolume:
    1526.  00:4DA3                      	;-------------------------------
    1527.  00:4DA3                      	;
    1528.  00:4DA3                      	; NOISE
    1529.  00:4DA3                      	;
    1530.  00:4DA3                      	;-------------------------------
    1531.  00:4DA3  CB 7B               	bit 	7,e			; test if noise value
    1532.  00:4DA5  CA B2 4D            	jp	z,_noNoise
    1533.  00:4DA8                      
    1534.  00:4DA8                      	;--- prevent FM and noise
    1535.  00:4DA8  7E                  	ld	a,(hl)		; get the value	
    1536.  00:4DA9  23                  	inc	hl	
    1537.  00:4DAA                      	
    1538.  00:4DAA  CB 7A               	bit	B_PSGFM,d		;(ix+TRACK_Flags)
    1539.  00:4DAC  C2 B2 4D            	jp	nz,_noNoise		; Noise and Link not at the same time
    1540.  00:4DAF                      	
    1541.  00:4DAF                      	;--- Set the mixer for noise
    1542.  00:4DAF                      ;	ld	a,(FM_regMIXER)
    1543.  00:4DAF                      ;	or	128
    1544.  00:4DAF                      ;	ld	(FM_regMIXER),a
    1545.  00:4DAF                      
    1546.  00:4DAF                      ;	bit	5,e
    1547.  00:4DAF                      ;	jp	z,_noLink
    1548.  00:4DAF                      ;	ld	a,(hl)	; get the deviation	
    1549.  00:4DAF                      ;	inc	hl
    1550.  00:4DAF                      ;	bit	6,e
    1551.  00:4DAF                      ;	jp	z,.skip
    1552.  00:4DAF                      ;	add	(ix+TRACK_Noise)
    1553.  00:4DAF                      ;.skip:	
    1554.  00:4DAF  32 70 C1            	ld	(PSG_regNOISE),a
    1555.  00:4DB2                      	
    1556.  00:4DB2                      	
    1557.  00:4DB2                      _noNoise:
    1558.  00:4DB2                      	;-------------------------------
    1559.  00:4DB2                      	;
    1560.  00:4DB2                      	; NOISE volume
    1561.  00:4DB2                      	;
    1562.  00:4DB2                      	;-------------------------------
    1563.  00:4DB2  CB 73               	bit 	6,e			; test if noise volume
    1564.  00:4DB4  CA D2 4D            	jp	z,_noNoiseVol
    1565.  00:4DB7                      	
    1566.  00:4DB7                      	;--- prevent FM and noise
    1567.  00:4DB7  7E                  	ld	a,(hl)		; get the volume	
    1568.  00:4DB8  23                  	inc	hl
    1569.  00:4DB9                      	
    1570.  00:4DB9  CB 7A               	bit	B_PSGFM,d		;(ix+TRACK_Flags)
    1571.  00:4DBB  C2 E0 4D            	jp	nz,_noLink		; Noise and Link not at the same time
    1572.  00:4DBE                      	
    1573.  00:4DBE  DD B6 F7            	or	(ix+TRACK_Volume)
    1574.  00:4DC1                      	;--- apply main volume balance
    1575.  00:4DC1  ED 4B 29 C0         	ld	bc,(replay_mainvol)
    1576.  00:4DC5  81                  	add	a,c
    1577.  00:4DC6  4F                  	ld	c,a
    1578.  00:4DC7  D2 CB 4D            	jp	nc,.skip
    1579.  00:4DCA  04                  	inc	b
    1580.  00:4DCB                      .skip:
    1581.  00:4DCB  0A                  	ld	a,(bc)
    1582.  00:4DCC  32 75 C1            	ld	(PSG_regVOLN),a
    1583.  00:4DCF  C3 E0 4D            	jp	_noLink
    1584.  00:4DD2                      
    1585.  00:4DD2                      
    1586.  00:4DD2                      _noNoiseVol
    1587.  00:4DD2                      	;-------------------------------
    1588.  00:4DD2                      	;
    1589.  00:4DD2                      	; VoiceLink
    1590.  00:4DD2                      	;
    1591.  00:4DD2                      	;-------------------------------
    1592.  00:4DD2  CB 4B               	bit 	1,e
    1593.  00:4DD4  CA E0 4D            	jp	z,_noLink
    1594.  00:4DD7                      
    1595.  00:4DD7  7E                  	ld	a,(hl)					; get the new hw voice	
    1596.  00:4DD8  23                  	inc	hl
    1597.  00:4DD9                      	
    1598.  00:4DD9  DD CB F9 F6         	set 	B_TRGVOI,(ix+TRACK_Flags)
    1599.  00:4DDD  DD 77 F8            	ld	(ix+TRACK_Voice),a			; set new voice to be loaded
    1600.  00:4DE0                      
    1601.  00:4DE0                      
    1602.  00:4DE0                      
    1603.  00:4DE0                      _noLink
    1604.  00:4DE0                      	;-------------------------------
    1605.  00:4DE0                      	;
    1606.  00:4DE0                      	; TONE 
    1607.  00:4DE0                      	;
    1608.  00:4DE0                      	;-------------------------------
    1609.  00:4DE0                      
    1610.  00:4DE0                      
    1611.  00:4DE0  DD 46 FB            	ld	b,(ix+TRACK_ToneAdd)	; get	the current	deviation	
    1612.  00:4DE3  DD 4E FC            	ld	c,(ix+TRACK_ToneAdd+1)
    1613.  00:4DE6                      
    1614.  00:4DE6  CB 63               	bit 	4,e
    1615.  00:4DE8  CA FD 4D            	jp	z,process_noToneAdd
    1616.  00:4DEB                      	
    1617.  00:4DEB  7E                  	ld	a,(hl)
    1618.  00:4DEC  23                  	inc	hl
    1619.  00:4DED  81                  	add	c
    1620.  00:4DEE  4F                  	ld	c,a
    1621.  00:4DEF  DD 71 FC            	ld	(ix+TRACK_ToneAdd+1),c
    1622.  00:4DF2  D2 F6 4D            	jp	nc,.skip
    1623.  00:4DF5  04                  	inc	b
    1624.  00:4DF6                      .skip:
    1625.  00:4DF6  7E                  	ld	a,(hl)
    1626.  00:4DF7  23                  	inc	hl
    1627.  00:4DF8  80                  	add	b
    1628.  00:4DF9  47                  	ld	b,a
    1629.  00:4DFA  DD 70 FB            	ld	(ix+TRACK_ToneAdd),b
    1630.  00:4DFD                      	
    1631.  00:4DFD                      	
    1632.  00:4DFD                      process_noToneAdd:	
    1633.  00:4DFD                      	;---- check for macro end
    1634.  00:4DFD  CB 43               	bit	0,e		
    1635.  00:4DFF  CA 06 4E            	jp	z,.noend
    1636.  00:4E02                      	
    1637.  00:4E02  7E                  	ld	a,(hl)
    1638.  00:4E03  23                  	inc	hl
    1639.  00:4E04  66                  	ld	h,(hl)
    1640.  00:4E05  6F                  	ld	l,a
    1641.  00:4E06                      
    1642.  00:4E06                      .noend:
    1643.  00:4E06                      	;--- Set the mixer bit (T)
    1644.  00:4E06  CB 6B               	bit	5,e		; do we have tone?
    1645.  00:4E08  CA 13 4E            	jp	z,process_noToneBit
    1646.  00:4E0B                      
    1647.  00:4E0B                      	;-- enable tone output
    1648.  00:4E0B  3A BE C1            	ld	a,(FM_regMIXER)
    1649.  00:4E0E  F6 10               	or	16
    1650.  00:4E10  32 BE C1            	ld	(FM_regMIXER),a
    1651.  00:4E13                      	
    1652.  00:4E13                      process_noToneBit:	
    1653.  00:4E13  DD 75 F1            	ld	(ix+TRACK_MacroPointer),l	;--- store pointer for next time
    1654.  00:4E16  DD 74 F2            	ld	(ix+TRACK_MacroPointer+1),h	
    1655.  00:4E19                      
    1656.  00:4E19  08                  	ex	af,af'			;';restore note offset
    1657.  00:4E1A  2A 2D C0            	ld	hl,(replay_tonetable)
    1658.  00:4E1D  85                  	add	a,l
    1659.  00:4E1E  6F                  	ld	l,a
    1660.  00:4E1F  D2 23 4E            	jp	nc,.skip
    1661.  00:4E22  24                  	inc	h
    1662.  00:4E23                      .skip:
    1663.  00:4E23  7E                  	ld	a,(hl)	;--- Store the note tone value in hl
    1664.  00:4E24  23                  	inc	hl
    1665.  00:4E25  66                  	ld	h,(hl)
    1666.  00:4E26  6F                  	ld	l,a
    1667.  00:4E27                      		
    1668.  00:4E27  09                  	add	hl,bc		;--- Store tone deviation		
    1669.  00:4E28                      
    1670.  00:4E28  7A                  	ld	a,d
    1671.  00:4E29  DD 72 F9            	ld	(ix+TRACK_Flags),d
    1672.  00:4E2C                      	; set	the detune.
    1673.  00:4E2C  ED 73 00 C0         	ld	(_SP_Storage),sp
    1674.  00:4E30  DD F9               	ld	sp,ix
    1675.  00:4E32  D1                  	pop	de		; cmd detune
    1676.  00:4E33  19                  	add	hl,de
    1677.  00:4E34  C1                  	pop	bc		; cmd toneadd
    1678.  00:4E35  09                  	add	hl,bc
    1679.  00:4E36  C1                  	pop	bc		; cmd tone slide add
    1680.  00:4E37  09                  	add	hl,bc
    1681.  00:4E38  ED 7B 00 C0         	ld	sp,(_SP_Storage)
    1682.  00:4E3C                      
    1683.  00:4E3C                      	;-----------------
    1684.  00:4E3C                      	; FM Octave wrapper
    1685.  00:4E3C                      	; enable slides over multiple octaves.
    1686.  00:4E3C                      	; [DE] still contains tone slide add.
    1687.  00:4E3C                      	;-----------------
    1688.  00:4E3C  CB 7F               	bit	B_PSGFM,a			;(ix+TRACK_Flags)
    1689.  00:4E3E  CA 90 4E            	jp	z,_wrap_skip		; skip wrapper for PSG
    1690.  00:4E41                      
    1691.  00:4E41  CB 44               	bit	0,h
    1692.  00:4E43  CA 6D 4E            	jp	z,_wrap_lowcheck
    1693.  00:4E46                      _wrap_highcheck:
    1694.  00:4E46  7D                  	ld	a,l
    1695.  00:4E47  FE 5A               	cp	$5a				; $5a is the strict limit
    1696.  00:4E49  DA 90 4E            	jp	c,_wrap_skip		; stop if smaller	
    1697.  00:4E4C                      	
    1698.  00:4E4C  E5                  	push	hl
    1699.  00:4E4D  D5                  	push	de
    1700.  00:4E4E                      	
    1701.  00:4E4E                      	;--- Set new tone value for same note 1 octave lower
    1702.  00:4E4E  CB 3F               	srl	a
    1703.  00:4E50  CB 44               	bit 	0,h		; test 9th bit
    1704.  00:4E52  CA 57 4E            	jp	z,99f
    1705.  00:4E55  C6 80               	add	128
    1706.  00:4E57                      99:
    1707.  00:4E57  5F                  	ld	e,a
    1708.  00:4E58                      ;	ld	d,0
    1709.  00:4E58                      	;--- set octave higher
    1710.  00:4E58  7C                  	ld	a,h
    1711.  00:4E59  E6 FE               	and	$fe
    1712.  00:4E5B  C6 02               	add	$02
    1713.  00:4E5D                      ;	add	d		; merge with tone value
    1714.  00:4E5D  57                  	ld	d,a
    1715.  00:4E5E                      	;--- get difference between now and new
    1716.  00:4E5E  EB                  	ex	de,hl
    1717.  00:4E5F  AF                  	xor	a		; reset carry flag
    1718.  00:4E60  ED 52               	sbc	hl,de
    1719.  00:4E62                      	;--- add difference to current slide
    1720.  00:4E62  D1                  	pop	de		; restore slide
    1721.  00:4E63  19                  	add	hl,de
    1722.  00:4E64  DD 75 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),l
    1723.  00:4E67  DD 74 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),h	
    1724.  00:4E6A  E1                  	pop	hl	
    1725.  00:4E6B  18 23               	jr.	_wrap_skip
    1726.  00:4E6D                      	
    1727.  00:4E6D                      _wrap_lowcheck:
    1728.  00:4E6D  7D                  	ld	a,l
    1729.  00:4E6E  FE 3B               	cp	$3b		; $ad is the strict limit
    1730.  00:4E70  30 1E               	jr.	nc,_wrap_skip		; stop if smaller
    1731.  00:4E72                      
    1732.  00:4E72                      
    1733.  00:4E72  E5                  	push 	hl		; store freq
    1734.  00:4E73  D5                  	push	de		; store slide
    1735.  00:4E74                      	;--- set new tone value for same note (but octave lower)
    1736.  00:4E74  87                  	add	a,a		; multiply by 2 in de 
    1737.  00:4E75  5F                  	ld	e,a
    1738.  00:4E76  16 00               	ld	d,0
    1739.  00:4E78  D2 7C 4E            	jp	nc,99f
    1740.  00:4E7B  14                  	inc	d	
    1741.  00:4E7C                      99:
    1742.  00:4E7C                      	;--- set octave higher
    1743.  00:4E7C  7C                  	ld	a,h
    1744.  00:4E7D  E6 FE               	and	$fe
    1745.  00:4E7F  D6 02               	sub	$02
    1746.  00:4E81  82                  	add	d		; merge with tone value
    1747.  00:4E82  57                  	ld	d,a
    1748.  00:4E83                      	;--- get difference between now and new
    1749.  00:4E83  EB                  	ex	de,hl
    1750.  00:4E84  AF                  	xor	a		; reset carry flag
    1751.  00:4E85  ED 52               	sbc	hl,de
    1752.  00:4E87                      	;--- add difference to current slide
    1753.  00:4E87  D1                  	pop	de		; restore slide
    1754.  00:4E88  19                  	add	hl,de	
    1755.  00:4E89                      	
    1756.  00:4E89  DD 75 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),l
    1757.  00:4E8C  DD 74 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),h	
    1758.  00:4E8F  E1                  	pop	hl	
    1759.  00:4E90                      	
    1760.  00:4E90                      _wrap_skip:
    1761.  00:4E90                      	; replace the last pushed value on stack
    1762.  00:4E90  D1                  	pop	de
    1763.  00:4E91  EB                  	ex	de,hl
    1764.  00:4E92  73                  	ld	(hl),e
    1765.  00:4E93  23                  	inc	hl
    1766.  00:4E94  7A                  	ld	a,d	; reset key on and sustain
    1767.  00:4E95  E6 0F               	and	$0f
    1768.  00:4E97  57                  	ld	d,a
    1769.  00:4E98  DD 7E F9            	ld	a,(ix+TRACK_Flags)	; Add the sustain and key bits.
    1770.  00:4E9B  E6 30               	and	16+32	
    1771.  00:4E9D  B2                  	or	d
    1772.  00:4E9E  77                  	ld	(hl),a
    1773.  00:4E9F  C9                  	ret
    1774.  00:4EA0                      
    1775.  00:4EA0                      	
    1776.  00:4EA0                      process_noNoteActive:
    1777.  00:4EA0  E1                  	pop	hl
    1778.  00:4EA1                      	
    1779.  00:4EA1                      	;-- for FM add key and sustain bits to tone
    1780.  00:4EA1  23                  	inc	hl
    1781.  00:4EA2  7A                  	ld	a,d
    1782.  00:4EA3  E6 30               	and	16+32	; keep key and sustain flags
    1783.  00:4EA5  47                  	ld	b,a
    1784.  00:4EA6  7E                  	ld	a,(hl)
    1785.  00:4EA7  E6 0F               	and 	$0f
    1786.  00:4EA9  B0                  	or 	b
    1787.  00:4EAA  77                  	ld	(hl),a
    1788.  00:4EAB                      	
    1789.  00:4EAB                      	;-- Silence
    1790.  00:4EAB  AF                  	xor	a
    1791.  00:4EAC  32 9A C1            	ld	(FM_regVOLF),a
    1792.  00:4EAF  DD 72 F9            	ld	(ix+TRACK_Flags),d
    1793.  00:4EB2  C9                  	ret	
    1794.  00:4EB3                      
    1795.  00:4EB3                      
    1796.  00:4EB3                      PROCESS_CMDLIST:
    1797.  00:4EB3                      	; This list only contains the primary commands.
    1798.  00:4EB3  62 4F               	dw	process_cmd3_port_tone
    1799.  00:4EB5  08 50               	dw	process_cmd5_vibrato_port_tone
    1800.  00:4EB7  4E 4F               	dw	process_cmd2_port_down		
    1801.  00:4EB9  C9 4E               	dw	process_cmd0_arpeggio			
    1802.  00:4EBB  C9 4F               	dw	process_cmd4_vibrato		
    1803.  00:4EBD  3A 4F               	dw	process_cmd1_port_up	
    1804.  00:4EBF  0E 50               	dw	process_cmd6_vibrato_vol		
    1805.  00:4EC1  14 50               	dw	process_cmd7_vol_slide
    1806.  00:4EC3  A3 4F               	dw	process_cmd8_tremelo
    1807.  00:4EC5  40 50               	dw	process_cmd9_note_cut		
    1808.  00:4EC7  4D 50               	dw	process_cmd10_note_delay		
    1809.  00:4EC9                      
    1810.  00:4EC9                      			
    1811.  00:4EC9                      process_cmd0_arpeggio:
    1812.  00:4EC9  DD 7E 11            	ld	a,(ix+TRACK_Timer)
    1813.  00:4ECC  A7                  	and	a
    1814.  00:4ECD  CA ED 4E            	jp	z,.nextNote
    1815.  00:4ED0                      	
    1816.  00:4ED0  3D                  	dec	a
    1817.  00:4ED1  DD 77 11            	ld	(IX+TRACK_Timer),a
    1818.  00:4ED4  DD 7E 12            	ld	a,(ix+TRACK_Step)
    1819.  00:4ED7  A7                  	and	a
    1820.  00:4ED8  CA E6 4E            	jp	z,99f
    1821.  00:4EDB  DD 7E 06            	ld	a,(IX+TRACK_cmd_0)
    1822.  00:4EDE  E6 0F               	and	$0f
    1823.  00:4EE0  DD 77 0D            	ld	(ix+TRACK_cmd_NoteAdd),a	
    1824.  00:4EE3  C3 14 4D            	jr.	process_commandEND
    1825.  00:4EE6                      99:
    1826.  00:4EE6  DD 36 0D 00         	ld	(ix+TRACK_cmd_NoteAdd),0	
    1827.  00:4EEA  C3 14 4D            	jr.	process_commandEND
    1828.  00:4EED                      	
    1829.  00:4EED                      
    1830.  00:4EED                      .nextNote:
    1831.  00:4EED                      	; re-init the speed.
    1832.  00:4EED  3A 24 C0            	ld	a,(replay_arp_speed)
    1833.  00:4EF0  DD 77 11            	ld	(IX+TRACK_Timer),a
    1834.  00:4EF3                      	
    1835.  00:4EF3  DD 7E 12            	ld	a,(ix+TRACK_Step)
    1836.  00:4EF6  A7                  	and	a
    1837.  00:4EF7  20 16               	jr.	nz,99f
    1838.  00:4EF9                      
    1839.  00:4EF9                      	;--- set x
    1840.  00:4EF9  DD 36 12 01         		ld	(ix+TRACK_Step),1
    1841.  00:4EFD  DD 7E 06            		ld	a,(ix+TRACK_cmd_0)
    1842.  00:4F00  07                  		rlca
    1843.  00:4F01  07                  		rlca
    1844.  00:4F02  07                  		rlca
    1845.  00:4F03  07                  		rlca		
    1846.  00:4F04  DD 77 06            		ld	(ix+TRACK_cmd_0),a	
    1847.  00:4F07  E6 0F               		and	$0f
    1848.  00:4F09  DD 77 0D            		ld	(ix+TRACK_cmd_NoteAdd),a
    1849.  00:4F0C  C3 14 4D            		jr.	process_commandEND
    1850.  00:4F0F                      	
    1851.  00:4F0F                      99:
    1852.  00:4F0F  3D                  	dec	a
    1853.  00:4F10  20 1D               	jr.	nz,99f
    1854.  00:4F12                      
    1855.  00:4F12                      	;--- set y
    1856.  00:4F12  DD 36 12 02         		ld	(ix+TRACK_Step),2
    1857.  00:4F16  DD 7E 06            		ld	a,(ix+TRACK_cmd_0)
    1858.  00:4F19  07                  		rlca
    1859.  00:4F1A  07                  		rlca
    1860.  00:4F1B  07                  		rlca
    1861.  00:4F1C  07                  		rlca		
    1862.  00:4F1D  DD 77 06            		ld	(ix+TRACK_cmd_0),a			
    1863.  00:4F20  E6 0F               		and	0x0f
    1864.  00:4F22  C2 29 4F            		jp	nz,0f
    1865.  00:4F25                      		;--- if zero then skip this note and set step to start
    1866.  00:4F25  DD 36 12 00         		ld	(ix+TRACK_Step),0
    1867.  00:4F29                      0:		
    1868.  00:4F29  DD 77 0D            		ld	(ix+TRACK_cmd_NoteAdd),a	
    1869.  00:4F2C  C3 14 4D            		jr.	process_commandEND
    1870.  00:4F2F                      	
    1871.  00:4F2F                      99:
    1872.  00:4F2F                      	;--- set none
    1873.  00:4F2F  DD 36 12 00         	ld	(ix+TRACK_Step),0
    1874.  00:4F33  DD 36 0D 00         	ld	(ix+TRACK_cmd_NoteAdd),0		
    1875.  00:4F37  C3 14 4D            	jr.	process_commandEND
    1876.  00:4F3A                      		
    1877.  00:4F3A                      
    1878.  00:4F3A                      	
    1879.  00:4F3A                      
    1880.  00:4F3A                      	
    1881.  00:4F3A                      process_cmd1_port_up:
    1882.  00:4F3A  DD 7E 07            	ld	a,(ix+TRACK_cmd_1)	
    1883.  00:4F3D                      
    1884.  00:4F3D  47                  	ld	b,a
    1885.  00:4F3E  DD 7E 00            	ld	a,(ix+TRACK_cmd_ToneSlideAdd)
    1886.  00:4F41  90                  	sub	b
    1887.  00:4F42  DD 77 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),a
    1888.  00:4F45  D2 14 4D            	jp	nc,process_commandEND
    1889.  00:4F48  DD 34 01            	inc	(ix+TRACK_cmd_ToneSlideAdd+1)
    1890.  00:4F4B  C3 14 4D            	jp	process_commandEND
    1891.  00:4F4E                      
    1892.  00:4F4E                      	
    1893.  00:4F4E                      process_cmd2_port_down:	
    1894.  00:4F4E  DD 7E 08            	ld	a,(ix+TRACK_cmd_2)
    1895.  00:4F51  47                  	ld	b,a
    1896.  00:4F52  DD 7E 00            	ld	a,(ix+TRACK_cmd_ToneSlideAdd)
    1897.  00:4F55  80                  	add	b
    1898.  00:4F56  DD 77 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),a
    1899.  00:4F59  D2 14 4D            	jp	nc,process_commandEND
    1900.  00:4F5C  DD 35 01            	dec	(ix+TRACK_cmd_ToneSlideAdd+1)
    1901.  00:4F5F  C3 14 4D            	jp	process_commandEND
    1902.  00:4F62                      	
    1903.  00:4F62                      
    1904.  00:4F62                      process_cmd3_port_tone:
    1905.  00:4F62  DD 7E 09            	ld	a,(ix+TRACK_cmd_3)
    1906.  00:4F65  DD 6E 00            	ld	l,(ix+TRACK_cmd_ToneSlideAdd)
    1907.  00:4F68  DD 66 01            	ld	h,(ix+TRACK_cmd_ToneSlideAdd+1)
    1908.  00:4F6B  CB 7C               	bit	7,h
    1909.  00:4F6D  CA 83 4F            	jp	z,process_cmd3_sub
    1910.  00:4F70                      process_cmd3_add:
    1911.  00:4F70                      	;pos slide
    1912.  00:4F70  85                  	add	a,l
    1913.  00:4F71  DD 77 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),a
    1914.  00:4F74  D2 78 4F            	jp	nc,.skip
    1915.  00:4F77  24                  	inc	h					
    1916.  00:4F78                      .skip:
    1917.  00:4F78  CB 7C               	bit	7,h
    1918.  00:4F7A  CA 98 4F            	jp	z,process_cmd3_stop			; delta turned pos ?
    1919.  00:4F7D  DD 74 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),h
    1920.  00:4F80  C3 14 4D            	jp	process_commandEND
    1921.  00:4F83                      process_cmd3_sub:
    1922.  00:4F83                      	;negative slide	
    1923.  00:4F83  E6 7F               	and	$7f
    1924.  00:4F85  4F                  	ld	c,a
    1925.  00:4F86  AF                  	xor	a
    1926.  00:4F87  47                  	ld	b,a
    1927.  00:4F88  ED 42               	sbc	hl,bc
    1928.  00:4F8A  CB 7C               	bit	7,h
    1929.  00:4F8C  C2 98 4F            	jp	nz,process_cmd3_stop			; delta turned neg ?
    1930.  00:4F8F  DD 75 00            	ld	(ix+TRACK_cmd_ToneSlideAdd),l
    1931.  00:4F92  DD 74 01            	ld	(ix+TRACK_cmd_ToneSlideAdd+1),h
    1932.  00:4F95  C3 14 4D            	jp	process_commandEND
    1933.  00:4F98                      process_cmd3_stop:	
    1934.  00:4F98                      ;	res	B_TRGCMD,d		;(ix+TRACK_Flags)
    1935.  00:4F98  DD 36 00 00         	ld	(ix+TRACK_cmd_ToneSlideAdd),0
    1936.  00:4F9C  DD 36 01 00         	ld	(ix+TRACK_cmd_ToneSlideAdd+1),0	
    1937.  00:4FA0  C3 14 4D            	jp	process_commandEND
    1938.  00:4FA3                      
    1939.  00:4FA3                      
    1940.  00:4FA3                      process_cmd8_tremelo:
    1941.  00:4FA3                      	;=================================
    1942.  00:4FA3                      	;
    1943.  00:4FA3                      	; Tremelo	
    1944.  00:4FA3                      	;
    1945.  00:4FA3                      	;=================================	
    1946.  00:4FA3  DD 6E 0A            	ld	l,(ix+TRACK_cmd_4_depth)
    1947.  00:4FA6  DD 66 0B            	ld	h,(ix+TRACK_cmd_4_depth+1)
    1948.  00:4FA9                      
    1949.  00:4FA9                      	;--- Get next step
    1950.  00:4FA9  DD 7E 12            	ld	a,(IX+TRACK_Step)
    1951.  00:4FAC  DD 86 0C            	add	(ix+TRACK_cmd_4_step)
    1952.  00:4FAF  E6 1F               	and	$1F			; max	32
    1953.  00:4FB1  DD 77 12            	ld	(ix+TRACK_Step),a
    1954.  00:4FB4                      
    1955.  00:4FB4  85                  	add	a,l
    1956.  00:4FB5  6F                  	ld	l,a
    1957.  00:4FB6  D2 BA 4F            	jp	nc,99f
    1958.  00:4FB9  24                  	inc	h
    1959.  00:4FBA                      99:
    1960.  00:4FBA  7E                  	ld	a,(hl)
    1961.  00:4FBB  CB 27               	sla	a
    1962.  00:4FBD  CB 27               	sla	a	
    1963.  00:4FBF  CB 27               	sla	a	
    1964.  00:4FC1  CB 27               	sla	a
    1965.  00:4FC3  DD 77 FF            	ld	(ix+TRACK_cmd_VolumeAdd),a
    1966.  00:4FC6  C3 14 4D            	jp	process_commandEND	
    1967.  00:4FC9                      
    1968.  00:4FC9                      
    1969.  00:4FC9                      	;=================================
    1970.  00:4FC9                      	;
    1971.  00:4FC9                      	; Vibrato	
    1972.  00:4FC9                      	;
    1973.  00:4FC9                      	;=================================
    1974.  00:4FC9                      process_cmd4_vibrato:
    1975.  00:4FC9  DD 6E 0A            	ld	l,(ix+TRACK_cmd_4_depth)
    1976.  00:4FCC  DD 66 0B            	ld	h,(ix+TRACK_cmd_4_depth+1)
    1977.  00:4FCF                      
    1978.  00:4FCF                      	;--- Get next step
    1979.  00:4FCF  DD 7E 12            	ld	a,(IX+TRACK_Step)
    1980.  00:4FD2  DD 86 0C            	add	(ix+TRACK_cmd_4_step)
    1981.  00:4FD5  E6 3F               	and	$3F			; max	64
    1982.  00:4FD7  DD 77 12            	ld	(ix+TRACK_Step),a
    1983.  00:4FDA                      	
    1984.  00:4FDA  CB 6F               	bit	5,a			; step 32-63 the neg	
    1985.  00:4FDC  CA F7 4F            	jp	z,.pos	
    1986.  00:4FDF                      	
    1987.  00:4FDF                      .neg:
    1988.  00:4FDF  E6 1F               	and	$1f	; make it 32 steps again
    1989.  00:4FE1  85                  	add	a,l
    1990.  00:4FE2  6F                  	ld	l,a
    1991.  00:4FE3  D2 E7 4F            	jp	nc,99f
    1992.  00:4FE6  24                  	inc	h
    1993.  00:4FE7                      99:
    1994.  00:4FE7  7E                  	ld	a,(hl)
    1995.  00:4FE8  ED 44               	neg
    1996.  00:4FEA  CA FE 4F            	jp	z,.zero			; $ff00 gives strange result ;)	
    1997.  00:4FED  DD 77 02            	ld	(ix+TRACK_cmd_ToneAdd),a
    1998.  00:4FF0  DD 36 03 FF         	ld	(ix+TRACK_cmd_ToneAdd+1),0xff
    1999.  00:4FF4  C3 14 4D            	jp	process_commandEND	
    2000.  00:4FF7                      
    2001.  00:4FF7                      .pos:
    2002.  00:4FF7  85                  	add	a,l
    2003.  00:4FF8  6F                  	ld	l,a
    2004.  00:4FF9  D2 FD 4F            	jp	nc,99f
    2005.  00:4FFC  24                  	inc	h
    2006.  00:4FFD                      99:
    2007.  00:4FFD  7E                  	ld	a,(hl)
    2008.  00:4FFE                      .zero:	
    2009.  00:4FFE  DD 77 02            	ld	(ix+TRACK_cmd_ToneAdd),a
    2010.  00:5001  DD 36 03 00         	ld	(ix+TRACK_cmd_ToneAdd+1),0
    2011.  00:5005  C3 14 4D            	jp	process_commandEND	
    2012.  00:5008                      
    2013.  00:5008                      
    2014.  00:5008                      ;	ld	hl,(replay_vib_table)
    2015.  00:5008                      ;	;--- Get next step
    2016.  00:5008                      ;	ld	a,(IX+TRACK_Step)
    2017.  00:5008                      ;	add	(ix+TRACK_cmd_4_step)
    2018.  00:5008                      ;	and	$3F			; max	64
    2019.  00:5008                      ;	ld	(ix+TRACK_Step),a
    2020.  00:5008                      ;	
    2021.  00:5008                      ;	bit	5,a			; step 32-63 the neg	
    2022.  00:5008                      ;	jp	z,process_cmd4pos
    2023.  00:5008                      ;
    2024.  00:5008                      ;; neg	
    2025.  00:5008                      ;	and	$1f
    2026.  00:5008                      ;	add	a,l
    2027.  00:5008                      ;	ld	l,a
    2028.  00:5008                      ;	jp	nc,.skip
    2029.  00:5008                      ;	inc	h
    2030.  00:5008                      ;.skip:
    2031.  00:5008                      ;	ld	a,(hl)
    2032.  00:5008                      ;	;apply depth
    2033.  00:5008                      ;	ld	b,(ix+TRACK_cmd_4_depth)
    2034.  00:5008                      ;.loop:
    2035.  00:5008                      ;	srl	a
    2036.  00:5008                      ;	djnz	.loop
    2037.  00:5008                      ;;	and	$0f
    2038.  00:5008                      ;
    2039.  00:5008                      ;	neg
    2040.  00:5008                      ;	jp	z,process_cmd4_zero			; $ff00 gives strange result ;)	
    2041.  00:5008                      ;	ld	(ix+TRACK_cmd_ToneAdd),a
    2042.  00:5008                      ;	ld	(ix+TRACK_cmd_ToneAdd+1),0xff
    2043.  00:5008                      ;	jp	process_commandEND
    2044.  00:5008                      ;
    2045.  00:5008                      ;process_cmd4pos:	
    2046.  00:5008                      ;;	and	$1f
    2047.  00:5008                      ;	add	a,l
    2048.  00:5008                      ;	ld	l,a
    2049.  00:5008                      ;	jp	nc,.skip
    2050.  00:5008                      ;	inc	h
    2051.  00:5008                      ;.skip:
    2052.  00:5008                      ;	ld	a,(hl)
    2053.  00:5008                      ;	;apply depth
    2054.  00:5008                      ;	ld	b,(ix+TRACK_cmd_4_depth)
    2055.  00:5008                      ;.loop:
    2056.  00:5008                      ;	srl	a
    2057.  00:5008                      ;	djnz	.loop
    2058.  00:5008                      ;process_cmd4_zero:
    2059.  00:5008                      ;	ld	(ix+TRACK_cmd_ToneAdd),a
    2060.  00:5008                      ;	ld	(ix+TRACK_cmd_ToneAdd+1),0
    2061.  00:5008                      ;	jp	process_commandEND
    2062.  00:5008                      		
    2063.  00:5008                      	
    2064.  00:5008                      
    2065.  00:5008                      process_cmd5_vibrato_port_tone:
    2066.  00:5008  CD 1A 50            	call	process_cmdasub
    2067.  00:500B  C3 62 4F            	jp	process_cmd3_port_tone
    2068.  00:500E                      	
    2069.  00:500E                      process_cmd6_vibrato_vol:
    2070.  00:500E  CD 1A 50            	call	process_cmdasub
    2071.  00:5011  C3 C9 4F            	jp	process_cmd4_vibrato	
    2072.  00:5014                      
    2073.  00:5014                      process_cmd7_vol_slide:
    2074.  00:5014  CD 1A 50            	call	process_cmdasub
    2075.  00:5017  C3 14 4D            	jp	process_commandEND
    2076.  00:501A                      
    2077.  00:501A                      
    2078.  00:501A                      process_cmdasub:
    2079.  00:501A  DD 35 11            	dec	(ix+TRACK_Timer)
    2080.  00:501D  C0                  	ret	nz
    2081.  00:501E                      		
    2082.  00:501E                      	; vol	slide
    2083.  00:501E  DD 7E 0E            	ld	a,(ix+TRACK_cmd_A)
    2084.  00:5021  4F                  	ld	c,a
    2085.  00:5022  E6 7F               	and	$7f
    2086.  00:5024  DD 77 11            	ld	(ix+TRACK_Timer),a
    2087.  00:5027                      
    2088.  00:5027  DD 7E F7            	ld	a,(ix+TRACK_Volume)
    2089.  00:502A  CB 79               	bit	7,c
    2090.  00:502C  CA 37 50            	jp	z,process_cmda_inc
    2091.  00:502F                      process_cmda_dec:
    2092.  00:502F  A7                  	and	a
    2093.  00:5030  C8                  	ret	z
    2094.  00:5031  D6 10               	sub	$10
    2095.  00:5033  DD 77 F7            	ld	(ix+TRACK_Volume),a
    2096.  00:5036  C9                  	ret
    2097.  00:5037                      	
    2098.  00:5037                      process_cmda_inc:
    2099.  00:5037  FE F0               	cp	$f0
    2100.  00:5039  D0                  	ret	nc
    2101.  00:503A  C6 10               	add	$10	
    2102.  00:503C  DD 77 F7            	ld	(ix+TRACK_Volume),a
    2103.  00:503F  C9                  	ret
    2104.  00:5040                      
    2105.  00:5040                      
    2106.  00:5040                      process_cmd9_note_cut:
    2107.  00:5040  DD 35 11            	dec	(ix+TRACK_Timer)
    2108.  00:5043  C2 14 4D            	jp	nz,process_commandEND
    2109.  00:5046                      	
    2110.  00:5046                      	; stop note
    2111.  00:5046  CB 9A               	res	B_TRGCMD,d	; set	note bit to	0
    2112.  00:5048  CB 8A               	res	B_ACTNOT,d
    2113.  00:504A  C3 14 4D            	jp	process_commandEND		
    2114.  00:504D                      	
    2115.  00:504D                      process_cmd10_note_delay:
    2116.  00:504D                      	; note delay
    2117.  00:504D  DD 35 11            	dec	(ix+TRACK_Timer)
    2118.  00:5050  C2 14 4D            	jp	nz,process_commandEND	; no delay yet
    2119.  00:5053                      
    2120.  00:5053                      	; trigger note
    2121.  00:5053  DD 7E 10            	ld	a,(ix+TRACK_cmd_E)		
    2122.  00:5056  DD 77 F6            	ld	(ix+TRACK_Note),a		; set	the note val
    2123.  00:5059  CB C2               	set	B_TRGNOT,d	;(ix+TRACK_Flags)		; set	trigger note flag
    2124.  00:505B  CB 9A               	res	B_TRGCMD,d	;(ix+TRACK_Flags)		; reset trigger cmd flag
    2125.  00:505D                      	
    2126.  00:505D  C3 14 4D            	jp	process_commandEND	
    2127.  00:5060                      
    2128.  00:5060                      
    2129.  00:5060                      
    2130.  00:5060                      ;===========================================================
    2131.  00:5060                      ; ---replay_route
    2132.  00:5060                      ; Output the data	to the CHIP	registers
    2133.  00:5060                      ; 
    2134.  00:5060                      ; 
    2135.  00:5060                      ;===========================================================
    2136.  00:5060                      replay_route:
    2137.  00:5060                      ;---------------
    2138.  00:5060                      ; P S	G 
    2139.  00:5060                      ;---------------
    2140.  00:5060                      route_SN:
    2141.  00:5060                      ;	ld	a,(_CONFIG_PSGPORT)
    2142.  00:5060  0E 3F               	ld	c,$3f
    2143.  00:5062                      99:	
    2144.  00:5062                      	; vol chan 1
    2145.  00:5062  3A 72 C1            	ld	a,(PSG_regVOLA)
    2146.  00:5065  3C                  	inc	a
    2147.  00:5066  ED 44               	neg
    2148.  00:5068  E6 0F               	and	$0f
    2149.  00:506A  F6 90               	or	10010000b
    2150.  00:506C  ED 79               	out	(c),a	
    2151.  00:506E                      	
    2152.  00:506E                      	; vol chan 2
    2153.  00:506E  3A 73 C1            	ld	a,(PSG_regVOLB)
    2154.  00:5071  3C                  	inc	a
    2155.  00:5072  ED 44               	neg
    2156.  00:5074  E6 0F               	and	$0f
    2157.  00:5076  F6 B0               	or	10110000b
    2158.  00:5078  ED 79               	out	(c),a		
    2159.  00:507A                      		
    2160.  00:507A                      ;	;-- check if we need 3rd psg
    2161.  00:507A                      ;	ld	a,10110000b
    2162.  00:507A                      ;	cp	b
    2163.  00:507A                      ;	jp	z,99f
    2164.  00:507A                      		
    2165.  00:507A                      	; vol chan 3
    2166.  00:507A  3A 74 C1            	ld	a,(PSG_regVOLC)
    2167.  00:507D  3C                  	inc	a
    2168.  00:507E  ED 44               	neg
    2169.  00:5080  E6 0F               	and	$0f
    2170.  00:5082  F6 D0               	or	11010000b 
    2171.  00:5084  ED 79               	out	(c),a			
    2172.  00:5086                      
    2173.  00:5086                      ;99:	
    2174.  00:5086                      	;--- next reg
    2175.  00:5086                      	; vol noise
    2176.  00:5086  3A 75 C1            	ld	a,(PSG_regVOLN)
    2177.  00:5089  3C                  	inc	a
    2178.  00:508A  ED 44               	neg
    2179.  00:508C  E6 0F               	and	$0f
    2180.  00:508E  F6 F0               	or	11110000b
    2181.  00:5090                      
    2182.  00:5090  ED 79               	out	(c),a	
    2183.  00:5092                      
    2184.  00:5092                      	; noise chan 
    2185.  00:5092  21 76 C1            	ld	hl,PSG_regNOISEold
    2186.  00:5095  3A 70 C1            	ld	a,(PSG_regNOISE)
    2187.  00:5098  BE                  	cp	(hl)
    2188.  00:5099  CA A1 50            	jp	z,0f
    2189.  00:509C  77                  	ld	(hl),a
    2190.  00:509D  3E E0               	ld	a,11100000b
    2191.  00:509F                      	;or	11100000b
    2192.  00:509F  D3 3F               	out	($3f),a
    2193.  00:50A1                      0:
    2194.  00:50A1                      	; tone chan a
    2195.  00:50A1  ED 4B 6A C1         	ld	bc,(PSG_regToneA)
    2196.  00:50A5  79                  	ld	a,c
    2197.  00:50A6  E6 0F               	and	$0f
    2198.  00:50A8  F6 80               	or	10000000b
    2199.  00:50AA  D3 3F               	out	($3f),a	
    2200.  00:50AC  CB 11               	rl	c
    2201.  00:50AE  CB 10               	rl	b
    2202.  00:50B0  CB 11               	rl	c
    2203.  00:50B2  CB 10               	rl	b
    2204.  00:50B4  CB 11               	rl	c
    2205.  00:50B6  CB 10               	rl	b
    2206.  00:50B8  CB 11               	rl	c
    2207.  00:50BA  CB 10               	rl	b
    2208.  00:50BC  3E 3F               	ld	a,00111111b
    2209.  00:50BE  A0                  	and	b
    2210.  00:50BF  D3 3F               	out	($3f),a		
    2211.  00:50C1                      	
    2212.  00:50C1                      	
    2213.  00:50C1                      	; tone chan b
    2214.  00:50C1  ED 4B 6C C1         	ld	bc,(PSG_regToneB)
    2215.  00:50C5  79                  	ld	a,c
    2216.  00:50C6  E6 0F               	and	$0f
    2217.  00:50C8  F6 A0               	or	10100000b
    2218.  00:50CA  D3 3F               	out	($3f),a	
    2219.  00:50CC  CB 11               	rl	c
    2220.  00:50CE  CB 10               	rl	b
    2221.  00:50D0  CB 11               	rl	c
    2222.  00:50D2  CB 10               	rl	b
    2223.  00:50D4  CB 11               	rl	c
    2224.  00:50D6  CB 10               	rl	b
    2225.  00:50D8  CB 11               	rl	c
    2226.  00:50DA  CB 10               	rl	b
    2227.  00:50DC  3E 3F               	ld	a,00111111b
    2228.  00:50DE  A0                  	and	b
    2229.  00:50DF  D3 3F               	out	($3f),a	
    2230.  00:50E1                      	
    2231.  00:50E1                      	; tone chan c
    2232.  00:50E1  ED 4B 6E C1         	ld	bc,(PSG_regToneC)
    2233.  00:50E5  79                  	ld	a,c
    2234.  00:50E6  E6 0F               	and	$0f
    2235.  00:50E8  F6 C0               	or	11000000b
    2236.  00:50EA  D3 3F               	out	($3f),a	
    2237.  00:50EC  CB 11               	rl	c
    2238.  00:50EE  CB 10               	rl	b
    2239.  00:50F0  CB 11               	rl	c
    2240.  00:50F2  CB 10               	rl	b
    2241.  00:50F4  CB 11               	rl	c
    2242.  00:50F6  CB 10               	rl	b
    2243.  00:50F8  CB 11               	rl	c
    2244.  00:50FA  CB 10               	rl	b
    2245.  00:50FC  3E 3F               	ld	a,00111111b
    2246.  00:50FE  A0                  	and	b
    2247.  00:50FF  D3 3F               	out	($3f),a	
    2248.  00:5101                      
    2249.  00:5101                      route_gg:
    2250.  00:5101                      	;==== output the GG stereo panning
    2251.  00:5101  3A 77 C1            	ld	a,(GG_panning)
    2252.  00:5104                      ;	out	($06),a
    2253.  00:5104                      
    2254.  00:5104                      
    2255.  00:5104                      
    2256.  00:5104                      
    2257.  00:5104                      
    2258.  00:5104                      
    2259.  00:5104                      ;	;--- Push values to AY HW
    2260.  00:5104                      ;	ld	b,0
    2261.  00:5104                      ;	ld	c,0xa0
    2262.  00:5104                      ;	ld	hl,PSG_registers
    2263.  00:5104                      ;_comp_loop:	
    2264.  00:5104                      ;	out	(c),b
    2265.  00:5104                      ;	ld	a,(hl)
    2266.  00:5104                      ;	add	1
    2267.  00:5104                      ;	out	(0xa1),a
    2268.  00:5104                      ;	inc	hl
    2269.  00:5104                      ;	ld	a,(hl)
    2270.  00:5104                      ;	adc	a,0
    2271.  00:5104                      ;	inc	b
    2272.  00:5104                      ;	out	(c),b	
    2273.  00:5104                      ;	inc	hl
    2274.  00:5104                      ;	out	(0xa1),a	
    2275.  00:5104                      ;	inc	b
    2276.  00:5104                      ;	ld	a,6
    2277.  00:5104                      ;	cp	b
    2278.  00:5104                      ;	jp	nz,_comp_loop
    2279.  00:5104                      ;	
    2280.  00:5104                      ;	ld	a,b	
    2281.  00:5104                      ;	
    2282.  00:5104                      ;	
    2283.  00:5104                      ;_ptPSG_loop:
    2284.  00:5104                      ;	out	(c),a
    2285.  00:5104                      ;	inc	c
    2286.  00:5104                      ;	outi
    2287.  00:5104                      ;	dec	c
    2288.  00:5104                      ;	inc	a
    2289.  00:5104                      ;	cp	13
    2290.  00:5104                      ;	jr	nz,_ptPSG_loop
    2291.  00:5104                      ;
    2292.  00:5104                      ;	ld	b,a
    2293.  00:5104                      ;	ld	a,(hl)
    2294.  00:5104                      ;	and	a
    2295.  00:5104                      ;	jp	z,_ptPSG_noEnv
    2296.  00:5104                      ;	out	(c),b
    2297.  00:5104                      ;	inc	c
    2298.  00:5104                      ;	out 	(c),a
    2299.  00:5104                      ;	ld	(hl),0	;reset the envwrite
    2300.  00:5104                      ;	
    2301.  00:5104                      ;	
    2302.  00:5104                      ;_ptPSG_noEnv:
    2303.  00:5104                      
    2304.  00:5104                      
    2305.  00:5104                      
    2306.  00:5104                      
    2307.  00:5104                      ;---------------
    2308.  00:5104                      ; F M
    2309.  00:5104                      ;---------------
    2310.  00:5104                      route_FM:
    2311.  00:5104                      	; Check if we need to load a software voice
    2312.  00:5104  21 BC C1            	ld	hl,FM_softvoice_req
    2313.  00:5107  7E                  	ld	a,(hl)
    2314.  00:5108  23                  	inc	hl
    2315.  00:5109  BE                  	cp	(hl)
    2316.  00:510A  CA 0E 51            	jp	z,.noVoice
    2317.  00:510D                      	
    2318.  00:510D  77                  	ld	(hl),a
    2319.  00:510E                      
    2320.  00:510E                      	;call	load_softwarevoice
    2321.  00:510E                      	
    2322.  00:510E                      .noVoice:
    2323.  00:510E                      	;------------------------------------------
    2324.  00:510E                      	;---- Process Drum macro
    2325.  00:510E                      	;------------------------------------------
    2326.  00:510E                      	;call	_route_FM_drum_update
    2327.  00:510E                      	
    2328.  00:510E                      
    2329.  00:510E                      	;------------------------------------------
    2330.  00:510E                      	;---- Update the tone and drum registers
    2331.  00:510E                      	;------------------------------------------
    2332.  00:510E  21 78 C1            	ld 	hl,FM_Registers
    2333.  00:5111  11 79 C0            	ld	de,TRACK_Chan3+TRACK_Flags
    2334.  00:5114  3E 10               	ld	a,$10		; Register $10
    2335.  00:5116  06 09               	ld	b,9		; 6(tone)+3(drum) channels to update
    2336.  00:5118                      
    2337.  00:5118                      .channel_loop:	
    2338.  00:5118                      	; Tone low
    2339.  00:5118  CD 6C 51            	call	_route_FM_reg16_update
    2340.  00:511B  2B                  	dec	hl
    2341.  00:511C  C6 10               	add	a,$10	; Register# $20
    2342.  00:511E                      
    2343.  00:511E  08                  	ex	af,af'
    2344.  00:511F                      
    2345.  00:511F  78                  	ld	a,b	;-- Only do this check for first 6 chans. Other are drum
    2346.  00:5120  FE 04               	cp	4
    2347.  00:5122  DA 3B 51            	jp	c,0f
    2348.  00:5125                      
    2349.  00:5125                      	;-- Check if we need to toggle key to start a new note
    2350.  00:5125  1A                  	ld	a,(de)
    2351.  00:5126  CB 47               	bit	0,a
    2352.  00:5128  CA 33 51            	jp	z,99f	; no notetrigger
    2353.  00:512B                      	
    2354.  00:512B  CB 87               	res	0,a		; reset trigger
    2355.  00:512D  12                  	ld	(de),a
    2356.  00:512E  CB 67               	bit	4,a
    2357.  00:5130  C4 7D 51            	call	nz,_route_FM_keyOff_update
    2358.  00:5133                      99:
    2359.  00:5133  3E 27               	ld	a,TRACK_REC_SIZE
    2360.  00:5135  83                  	add	a,e
    2361.  00:5136  5F                  	ld	e,a
    2362.  00:5137  D2 3B 51            	jp	nc,99f
    2363.  00:513A  14                  	inc	d
    2364.  00:513B                      99:	
    2365.  00:513B                      0:
    2366.  00:513B  08                  	ex	af,af'
    2367.  00:513C                      	
    2368.  00:513C                      	; Tone High + key & sustain
    2369.  00:513C  CD 6C 51            	call	_route_FM_reg16_update
    2370.  00:513F  23                  	inc	hl
    2371.  00:5140  C6 10               	add	a,$10	; Register# $30
    2372.  00:5142                      	
    2373.  00:5142                      	; Volume + voice
    2374.  00:5142  CD 67 51            	call	_route_FM_reg8_update
    2375.  00:5145  23                  	inc	hl
    2376.  00:5146  C6 E1               	add	a,-$1F	; Register# = channel + $10
    2377.  00:5148  10 CE               	djnz	.channel_loop
    2378.  00:514A  C9                  	ret
    2379.  00:514B                      
    2380.  00:514B                      _route_FM_drum_update:
    2381.  00:514B  3A AE C1            	ld	a,(FM_DRUM)
    2382.  00:514E  E6 1F               	and	00011111b		; erase bit 5
    2383.  00:5150  C8                  	ret	z			; no drums to play
    2384.  00:5151                      	
    2385.  00:5151  47                  	ld	b,a
    2386.  00:5152  3E 0E               	ld	a,0x0e
    2387.  00:5154                      	;-- load the new values
    2388.  00:5154  D3 7C               	out	(FM_WRITE),a	; Select rythm register
    2389.  00:5156                      	
    2390.  00:5156  78                  	ld	a,b			; 5 cycles
    2391.  00:5157  78                  	ld	a,b			; 5 cycles	; dummy code for delay
    2392.  00:5158  D3 7D               	out	(FM_DATA),a		
    2393.  00:515A                      
    2394.  00:515A  DD E5               	push	ix			; 17 cycles	dummy code to implement delay
    2395.  00:515C  DD E1               	pop	ix			; 17 cycles
    2396.  00:515E  ED 6F               	rld				; 20 cycles
    2397.  00:5160  ED 67               	rrd				; 20 cycles
    2398.  00:5162                      
    2399.  00:5162  F6 20               	or	100000b		; set the percussion bit
    2400.  00:5164  D3 7D               	out	(FM_DATA),a
    2401.  00:5166                      	
    2402.  00:5166  C9                  	ret
    2403.  00:5167                      	
    2404.  00:5167                      
    2405.  00:5167                      ;------- Writes safe to the FM chip
    2406.  00:5167                      ; in :
    2407.  00:5167                      ;	[a]	Register# to write
    2408.  00:5167                      ;	[HL]	point to register (previous value is next in RAM)
    2409.  00:5167                      ;
    2410.  00:5167                      ; out:
    2411.  00:5167                      ;	[HL] points to previous value
    2412.  00:5167                      ;	[A]	contains register# written
    2413.  00:5167                      ;-----------
    2414.  00:5167                      _route_FM_reg8_update:
    2415.  00:5167  08                  	ex	af,af'
    2416.  00:5168  7E                  	ld	a,(hl)
    2417.  00:5169  C3 6F 51            	jp	_rfr_cont
    2418.  00:516C                      	
    2419.  00:516C                      	
    2420.  00:516C                      ;------- Writes safe to the FM chip
    2421.  00:516C                      ; in :
    2422.  00:516C                      ;	[a]	Register# to write
    2423.  00:516C                      ;	[HL]	point to register (previous value is next in RAM)
    2424.  00:516C                      ;
    2425.  00:516C                      ; out:
    2426.  00:516C                      ;	[HL] points to previous value
    2427.  00:516C                      ;	[A]	contains register# written
    2428.  00:516C                      ;-----------
    2429.  00:516C                      _route_FM_reg16_update:
    2430.  00:516C  08                  	ex	af,af'
    2431.  00:516D  7E                  	ld	a,(hl)
    2432.  00:516E  23                  	inc	hl
    2433.  00:516F                      _rfr_cont:
    2434.  00:516F  23                  	inc	hl
    2435.  00:5170  BE                  	cp	(hl)	
    2436.  00:5171  CA 7B 51            	jp	z,99f		; no change in tone low value
    2437.  00:5174  08                  	ex	af,af'	
    2438.  00:5175  D3 7C               	out	(FM_WRITE),a
    2439.  00:5177  08                  	ex	af,af'
    2440.  00:5178  77                  	ld	(hl),a
    2441.  00:5179  D3 7D               	out	(FM_DATA),a	
    2442.  00:517B  08                  99:	ex	af,af'
    2443.  00:517C                      ;	dec	hl	
    2444.  00:517C  C9                  	ret
    2445.  00:517D                      	
    2446.  00:517D                      ;------- Writes a keyoff to the existing tone high register 
    2447.  00:517D                      ; in :
    2448.  00:517D                      ;	[A']	register# to write
    2449.  00:517D                      ;	[HL]	point to register (previous value is next in RAM)
    2450.  00:517D                      ;
    2451.  00:517D                      ; out:
    2452.  00:517D                      ;	[HL] points to same location
    2453.  00:517D                      ;	[A']	contains register# written
    2454.  00:517D                      ;-----------
    2455.  00:517D                      _route_FM_keyOff_update:
    2456.  00:517D  08                  	ex	af,af'
    2457.  00:517E  D3 7C               	out	(FM_WRITE),a
    2458.  00:5180  08                  	ex	af,af'		; 4 cycles	 '
    2459.  00:5181  7E                  	ld	a,(hl)
    2460.  00:5182  E6 EF               	and	11101111b	; erase keyON bit.
    2461.  00:5184  D3 7D               	out	(FM_DATA),a	
    2462.  00:5186  23                  	inc	hl
    2463.  00:5187  23                  	inc	hl
    2464.  00:5188  77                  	ld	(hl),a		; make sure to change old value to trigger update
    2465.  00:5189  2B                  	dec	hl
    2466.  00:518A  2B                  	dec	hl
    2467.  00:518B  C9                  	ret
    2468.  00:518C                      
    2469.  00:518C                      
    2470.  00:518C                      
    2471.  00:518C                      	
    2472.  00:518C                      	
    2473.  00:518C                      
    2474.  00:518C                      	
    2475.  00:518C                      
    2476.  00:518C                      	
    2477.  00:518C                      
    2478.  00:518C                      
     560   00:518C                      	include	"..\code\ttreplaySMSDAT.asm"
       1.  00:518C                      
       2.  00:518C                      
       3.  00:518C                      	; Balance setting space volume max - 8
       4.  00:518C  0F (128)            	ds 8*16, $0F
       5.  00:520C                      _VOLUME_TABLE
       6.  00:520C                      	; Combined volume table PSG/FM
       7.  00:520C                      	db	 $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F, $0F
       7.  00:520C  0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 
       8.  00:521C                      	db	 $0F, $0F, $0F, $0F, $0F, $0F, $0F, $1F, $1F, $1F, $1F, $1F, $1F, $1F, $1F, $1E
       8.  00:521C  0F 0F 0F 0F 0F 0F 0F 1F 1F 1F 1F 1F 1F 1F 1F 1E 
       9.  00:522C                      	db	 $0F, $0F, $0F, $0F, $1F, $1F, $1F, $1F, $1F, $1F, $1F, $1F, $2F, $2F, $2E, $2D
       9.  00:522C  0F 0F 0F 0F 1F 1F 1F 1F 1F 1F 1F 1F 2F 2F 2E 2D 
      10.  00:523C                      	db	 $0F, $0F, $0F, $1F, $1F, $1F, $1F, $1F, $2F, $2F, $2F, $2F, $2F, $3E, $3D, $3C
      10.  00:523C  0F 0F 0F 1F 1F 1F 1F 1F 2F 2F 2F 2F 2F 3E 3D 3C 
      11.  00:524C                      	db	 $0F, $0F, $1F, $1F, $1F, $1F, $2F, $2F, $2F, $2F, $3F, $3F, $3E, $3D, $4C, $4B
      11.  00:524C  0F 0F 1F 1F 1F 1F 2F 2F 2F 2F 3F 3F 3E 3D 4C 4B 
      12.  00:525C                      	db	 $0F, $0F, $1F, $1F, $1F, $2F, $2F, $2F, $3F, $3F, $3F, $4E, $4D, $4C, $5B, $5A
      12.  00:525C  0F 0F 1F 1F 1F 2F 2F 2F 3F 3F 3F 4E 4D 4C 5B 5A 
      13.  00:526C                      	db	 $0F, $0F, $1F, $1F, $2F, $2F, $2F, $3F, $3F, $4F, $4E, $4D, $5C, $5B, $6A, $69
      13.  00:526C  0F 0F 1F 1F 2F 2F 2F 3F 3F 4F 4E 4D 5C 5B 6A 69 
      14.  00:527C                      	db	 $0F, $0F, $1F, $1F, $2F, $2F, $3F, $3F, $4F, $4E, $5D, $5C, $6B, $6A, $79, $78
      14.  00:527C  0F 0F 1F 1F 2F 2F 3F 3F 4F 4E 5D 5C 6B 6A 79 78 
      15.  00:528C                      	db	 $0F, $1F, $1F, $2F, $2F, $3F, $3F, $4F, $4E, $5D, $5C, $6B, $6A, $79, $78, $87
      15.  00:528C  0F 1F 1F 2F 2F 3F 3F 4F 4E 5D 5C 6B 6A 79 78 87 
      16.  00:529C                      	db	 $0F, $1F, $1F, $2F, $2F, $3F, $4F, $4E, $5D, $5C, $6B, $7A, $79, $88, $87, $96
      16.  00:529C  0F 1F 1F 2F 2F 3F 4F 4E 5D 5C 6B 7A 79 88 87 96 
      17.  00:52AC                      	db	 $0F, $1F, $1F, $2F, $3F, $3F, $4E, $5D, $5C, $6B, $7A, $79, $88, $97, $96, $A5
      17.  00:52AC  0F 1F 1F 2F 3F 3F 4E 5D 5C 6B 7A 79 88 97 96 A5 
      18.  00:52BC                      	db	 $0F, $1F, $1F, $2F, $3F, $4E, $4D, $5C, $6B, $7A, $79, $88, $97, $A6, $A5, $B4
      18.  00:52BC  0F 1F 1F 2F 3F 4E 4D 5C 6B 7A 79 88 97 A6 A5 B4 
      19.  00:52CC                      	db	 $0F, $1F, $2F, $2F, $3E, $4D, $5C, $6B, $6A, $79, $88, $97, $A6, $A5, $B4, $C3
      19.  00:52CC  0F 1F 2F 2F 3E 4D 5C 6B 6A 79 88 97 A6 A5 B4 C3 
      20.  00:52DC                      	db	 $0F, $1F, $2F, $3E, $3D, $4C, $5B, $6A, $79, $88, $97, $A6, $A5, $B4, $C3, $D2
      20.  00:52DC  0F 1F 2F 3E 3D 4C 5B 6A 79 88 97 A6 A5 B4 C3 D2 
      21.  00:52EC                      	db	 $0F, $1F, $2E, $3D, $4C, $5B, $6A, $79, $78, $87, $96, $A5, $B4, $C3, $D2, $E1
      21.  00:52EC  0F 1F 2E 3D 4C 5B 6A 79 78 87 96 A5 B4 C3 D2 E1 
      22.  00:52FC                      	db	 $0F, $1E, $2D, $3C, $4B, $5A, $69, $78, $87, $96, $A5, $B4, $C3, $D2, $E1, $F0
      22.  00:52FC  0F 1E 2D 3C 4B 5A 69 78 87 96 A5 B4 C3 D2 E1 F0 
      23.  00:530C                      	
      24.  00:530C                      
      25.  00:530C                      TRACK_ToneTable_PSG:	
      26.  00:530C  01 00               	dw $0001	     ; C1			
      27.  00:530E  01 00               	dw $0001	     ; C#1			
      28.  00:5310  01 00               	dw $0001	     ; D1			
      29.  00:5312  01 00               	dw $0001	     ; D#1			
      30.  00:5314  01 00               	dw $0001	     ; E1			
      31.  00:5316  01 00               	dw $0001	     ; F1			
      32.  00:5318  01 00               	dw $0001	     ; F#1			
      33.  00:531A  01 00               	dw $0001	     ; G1
      34.  00:531C  01 00               	dw $0001	     ; G#1	
      35.  00:531E  01 00               	dw $0001         ; A1
      36.  00:5320  01 00               	dw $0001         ; A#1/Bb1 
      37.  00:5322  01 00               	dw $0001         ; B1	
      38.  00:5324  01 00               	dw $0001	     ; C2			
      39.  00:5326  01 00               	dw $0001	     ; C#2			
      40.  00:5328  01 00               	dw $0001	     ; D2			
      41.  00:532A  01 00               	dw $0001	     ; D#2			
      42.  00:532C  01 00               	dw $0001	     ; E2			
      43.  00:532E  01 00               	dw $0001	     ; F2			
      44.  00:5330  01 00               	dw $0001	     ; F#2			
      45.  00:5332  01 00               	dw $0001	     ; G2
      46.  00:5334  01 00               	dw $0001	     ; G#2			
      47.  00:5336                         
      48.  00:5336  F9 03               	dw $03F9      ;A2
      49.  00:5338  C0 03               	dw $03C0      ; A#2/Bb2 
      50.  00:533A  8A 03               	dw $038A      ;B2
      51.  00:533C  57 03               	dw $0357      ;C3
      52.  00:533E  27 03               	dw $0327      ; C#3/Db3 
      53.  00:5340  FA 02               	dw $02FA      ;D3
      54.  00:5342  CF 02               	dw $02CF      ; D#3/Eb3 
      55.  00:5344  A7 02               	dw $02A7      ;E3
      56.  00:5346  81 02               	dw $0281      ;F3
      57.  00:5348  5D 02               	dw $025D      ; F#3/Gb3 
      58.  00:534A  3B 02               	dw $023B      ;G3
      59.  00:534C  1B 02               	dw $021B      ; G#3/Ab3 
      60.  00:534E  FC 01               	dw $01FC      ;A3
      61.  00:5350  E0 01               	dw $01E0      ; A#3/Bb3 
      62.  00:5352  C5 01               	dw $01C5      ;B3
      63.  00:5354  AC 01               	dw $01AC      ;C4
      64.  00:5356  94 01               	dw $0194      ; C#4/Db4 
      65.  00:5358  7D 01               	dw $017D      ;D4
      66.  00:535A  68 01               	dw $0168      ; D#4/Eb4 
      67.  00:535C  53 01               	dw $0153      ;E4
      68.  00:535E  40 01               	dw $0140      ;F4
      69.  00:5360  2E 01               	dw $012E      ; F#4/Gb4 
      70.  00:5362  1D 01               	dw $011D      ;G4
      71.  00:5364  0D 01               	dw $010D      ; G#4/Ab4 
      72.  00:5366  FE 00               	dw $00FE      ;A4
      73.  00:5368  F0 00               	dw $00F0      ; A#4/Bb4 
      74.  00:536A  E2 00               	dw $00E2      ;B4
      75.  00:536C  D6 00               	dw $00D6      ;C5
      76.  00:536E  CA 00               	dw $00CA      ; C#5/Db5 
      77.  00:5370  BE 00               	dw $00BE      ;D5
      78.  00:5372  B4 00               	dw $00B4      ; D#5/Eb5 
      79.  00:5374  AA 00               	dw $00AA      ;E5
      80.  00:5376  A0 00               	dw $00A0      ;F5
      81.  00:5378  97 00               	dw $0097      ; F#5/Gb5 
      82.  00:537A  8F 00               	dw $008F      ;G5
      83.  00:537C  87 00               	dw $0087      ; G#5/Ab5 
      84.  00:537E  7F 00               	dw $007F      ;A5
      85.  00:5380  78 00               	dw $0078      ; A#5/Bb5 
      86.  00:5382  71 00               	dw $0071      ;B5
      87.  00:5384  6B 00               	dw $006B      ;C6
      88.  00:5386  65 00               	dw $0065      ; C#6/Db6 
      89.  00:5388  5F 00               	dw $005F      ;D6
      90.  00:538A  5A 00               	dw $005A      ; D#6/Eb6 
      91.  00:538C  55 00               	dw $0055      ;E6
      92.  00:538E  50 00               	dw $0050      ;F6
      93.  00:5390  4C 00               	dw $004C      ; F#6/Gb6 
      94.  00:5392  47 00               	dw $0047      ;G6
      95.  00:5394  43 00               	dw $0043      ; G#6/Ab6 
      96.  00:5396  40 00               	dw $0040      ;A6
      97.  00:5398  3C 00               	dw $003C      ; A#6/Bb6 
      98.  00:539A  39 00               	dw $0039      ;B6
      99.  00:539C  35 00               	dw $0035      ;C7
     100.  00:539E  32 00               	dw $0032      ; C#7/Db7 
     101.  00:53A0  30 00               	dw $0030      ;D7
     102.  00:53A2  2D 00               	dw $002D      ; D#7/Eb7 
     103.  00:53A4  2A 00               	dw $002A      ;E7
     104.  00:53A6  28 00               	dw $0028      ;F7
     105.  00:53A8  26 00               	dw $0026      ; F#7/Gb7 
     106.  00:53AA  24 00               	dw $0024      ;G7
     107.  00:53AC  22 00               	dw $0022      ; G#7/Ab7 
     108.  00:53AE  20 00               	dw $0020      ;A7
     109.  00:53B0  1E 00               	dw $001E      ; A#7/Bb7 
     110.  00:53B2  1C 00               	dw $001C      ;B7
     111.  00:53B4  1B 00               	dw $001B      ;C8
     112.  00:53B6  19 00               	dw $0019      ; C#8/Db8 
     113.  00:53B8  18 00               	dw $0018      ;D8
     114.  00:53BA  16 00               	dw $0016      ; D#8/Eb8 
     115.  00:53BC  15 00               	dw $0015      ;E8
     116.  00:53BE  14 00               	dw $0014      ;F8
     117.  00:53C0  13 00               	dw $0013      ; F#8/Gb8 
     118.  00:53C2  12 00               	dw $0012      ;G8
     119.  00:53C4  11 00               	dw $0011      ; G#8/Ab8 
     120.  00:53C6  10 00               	dw $0010      ;A8
     121.  00:53C8  0F 00               	dw $000F      ; A#8/Bb8 
     122.  00:53CA  0E 00               	dw $000E      ;B8
     123.  00:53CC                      TRACK_ToneTable_FM:
     124.  00:53CC                      ;	db   	0,0
     125.  00:53CC                      	db	0adh,000h,0b7h,000h,0c2h,000h,0cdh,000h,0d9h,000h,0e6h,000h
     125.  00:53CC  AD 00 B7 00 C2 00 CD 00 D9 00 E6 00 
     126.  00:53D8                            db	0f4h,000h,003h,001h,012h,001h,022h,001h,034h,001h,046h,001h
     126.  00:53D8  F4 00 03 01 12 01 22 01 34 01 46 01 
     127.  00:53E4                            db    0adh,002h,0b7h,002h,0c2h,002h,0cdh,002h,0d9h,002h,0e6h,002h
     127.  00:53E4  AD 02 B7 02 C2 02 CD 02 D9 02 E6 02 
     128.  00:53F0                            db    0f4h,002h,003h,003h,012h,003h,022h,003h,034h,003h,046h,003h
     128.  00:53F0  F4 02 03 03 12 03 22 03 34 03 46 03 
     129.  00:53FC                            db    0adh,004h,0b7h,004h,0c2h,004h,0cdh,004h,0d9h,004h,0e6h,004h
     129.  00:53FC  AD 04 B7 04 C2 04 CD 04 D9 04 E6 04 
     130.  00:5408                            db    0f4h,004h,003h,005h,012h,005h,022h,005h,034h,005h,046h,005h
     130.  00:5408  F4 04 03 05 12 05 22 05 34 05 46 05 
     131.  00:5414                            db    0adh,006h,0b7h,006h,0c2h,006h,0cdh,006h,0d9h,006h,0e6h,006h
     131.  00:5414  AD 06 B7 06 C2 06 CD 06 D9 06 E6 06 
     132.  00:5420                            db    0f4h,006h,003h,007h,012h,007h,022h,007h,034h,007h,046h,007h
     132.  00:5420  F4 06 03 07 12 07 22 07 34 07 46 07 
     133.  00:542C                            db    0adh,008h,0b7h,008h,0c2h,008h,0cdh,008h,0d9h,008h,0e6h,008h
     133.  00:542C  AD 08 B7 08 C2 08 CD 08 D9 08 E6 08 
     134.  00:5438                            db    0f4h,008h,003h,009h,012h,009h,022h,009h,034h,009h,046h,009h
     134.  00:5438  F4 08 03 09 12 09 22 09 34 09 46 09 
     135.  00:5444                            db    0adh,00ah,0b7h,00ah,0c2h,00ah,0cdh,00ah,0d9h,00ah,0e6h,00ah
     135.  00:5444  AD 0A B7 0A C2 0A CD 0A D9 0A E6 0A 
     136.  00:5450                            db    0f4h,00ah,003h,00bh,012h,00bh,022h,00bh,034h,00bh,046h,00bh
     136.  00:5450  F4 0A 03 0B 12 0B 22 0B 34 0B 46 0B 
     137.  00:545C                            db    0adh,00ch,0b7h,00ch,0c2h,00ch,0cdh,00ch,0d9h,00ch,0e6h,00ch
     137.  00:545C  AD 0C B7 0C C2 0C CD 0C D9 0C E6 0C 
     138.  00:5468                            db    0f4h,00ch,003h,00dh,012h,00dh,022h,00dh,034h,00dh,046h,00dh
     138.  00:5468  F4 0C 03 0D 12 0D 22 0D 34 0D 46 0D 
     139.  00:5474                            db    0adh,00eh,0b7h,00eh,0c2h,00eh,0cdh,00eh,0d9h,00eh,0e6h,00eh
     139.  00:5474  AD 0E B7 0E C2 0E CD 0E D9 0E E6 0E 
     140.  00:5480                            db    0f4h,00eh,003h,00fh,012h,00fh,022h,00fh,034h,00fh,046h,00fh
     140.  00:5480  F4 0E 03 0F 12 0F 22 0F 34 0F 46 0F 
     141.  00:548C                      
     142.  00:548C                      
     143.  00:548C                      TRACK_Vibrato_sine:	; Sine table used for tremelo and vibrato
     144.  00:548C                            db 	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00		      ; depth 	1
     144.  00:548C  00 00 00 00 00 00 00 00 00 00 01 01 01 01 01 01 
     144.  00:549C  01 01 01 01 01 01 00 00 00 00 00 00 00 00 00 00 
     145.  00:54AC                            db 	$00,$00,$00,$00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$02,$02,$02,$02,$02,$02,$01,$01,$01,$01,$01,$01,$00,$00,$00,$00,$00,$00,$00		      ; depth 	2
     145.  00:54AC  00 00 00 00 00 00 00 01 01 01 01 01 01 02 02 02 
     145.  00:54BC  02 02 02 01 01 01 01 01 01 00 00 00 00 00 00 00 
     146.  00:54CC                            db 	$00,$00,$00,$00,$00,$01,$01,$01,$01,$01,$02,$02,$02,$02,$03,$03,$03,$03,$02,$02,$02,$02,$01,$01,$01,$01,$01,$00,$00,$00,$00,$00		      ; depth 	3
     146.  00:54CC  00 00 00 00 00 01 01 01 01 01 02 02 02 02 03 03 
     146.  00:54DC  03 03 02 02 02 02 01 01 01 01 01 00 00 00 00 00 
     147.  00:54EC                            db 	$00,$00,$00,$00,$00,$01,$01,$01,$01,$02,$02,$02,$03,$03,$04,$04,$04,$04,$03,$03,$02,$02,$02,$01,$01,$01,$01,$00,$00,$00,$00,$00		      ; depth 	4
     147.  00:54EC  00 00 00 00 00 01 01 01 01 02 02 02 03 03 04 04 
     147.  00:54FC  04 04 03 03 02 02 02 01 01 01 01 00 00 00 00 00 
     148.  00:550C                            db 	$00,$00,$00,$00,$01,$01,$01,$01,$02,$02,$03,$03,$04,$04,$05,$05,$05,$05,$04,$04,$03,$03,$02,$02,$01,$01,$01,$01,$00,$00,$00,$00		      ; depth 	5
     148.  00:550C  00 00 00 00 01 01 01 01 02 02 03 03 04 04 05 05 
     148.  00:551C  05 05 04 04 03 03 02 02 01 01 01 01 00 00 00 00 
     149.  00:552C                            db 	$00,$00,$00,$00,$01,$01,$01,$02,$02,$03,$03,$04,$04,$05,$05,$06,$06,$05,$05,$04,$04,$03,$03,$02,$02,$01,$01,$01,$00,$00,$00,$00		      ; depth 	6
     149.  00:552C  00 00 00 00 01 01 01 02 02 03 03 04 04 05 05 06 
     149.  00:553C  06 05 05 04 04 03 03 02 02 01 01 01 00 00 00 00 
     150.  00:554C                            db 	$00,$00,$00,$01,$01,$01,$02,$02,$03,$04,$04,$05,$06,$06,$07,$08,$08,$07,$06,$06,$05,$04,$04,$03,$02,$02,$01,$01,$01,$00,$00,$00		      ; depth 	7
     150.  00:554C  00 00 00 01 01 01 02 02 03 04 04 05 06 06 07 08 
     150.  00:555C  08 07 06 06 05 04 04 03 02 02 01 01 01 00 00 00 
     151.  00:556C                            db 	$00,$00,$01,$01,$01,$02,$03,$04,$05,$06,$07,$08,$09,$0A,$0C,$0D,$0D,$0C,$0A,$09,$08,$07,$06,$05,$04,$03,$02,$01,$01,$01,$00,$00		      ; depth 	8
     151.  00:556C  00 00 01 01 01 02 03 04 05 06 07 08 09 0A 0C 0D 
     151.  00:557C  0D 0C 0A 09 08 07 06 05 04 03 02 01 01 01 00 00 
     152.  00:558C                            db 	$00,$00,$01,$02,$02,$04,$05,$06,$08,$09,$0B,$0D,$0F,$11,$13,$15,$15,$13,$11,$0F,$0D,$0B,$09,$08,$06,$05,$04,$02,$02,$01,$00,$00		      ; depth 	9
     152.  00:558C  00 00 01 02 02 04 05 06 08 09 0B 0D 0F 11 13 15 
     152.  00:559C  15 13 11 0F 0D 0B 09 08 06 05 04 02 02 01 00 00 
     153.  00:55AC                            db 	$00,$01,$01,$02,$04,$05,$07,$09,$0B,$0E,$10,$13,$16,$19,$1C,$1F,$1F,$1C,$19,$16,$13,$10,$0E,$0B,$09,$07,$05,$04,$02,$01,$01,$00		      ; depth 	A
     153.  00:55AC  00 01 01 02 04 05 07 09 0B 0E 10 13 16 19 1C 1F 
     153.  00:55BC  1F 1C 19 16 13 10 0E 0B 09 07 05 04 02 01 01 00 
     154.  00:55CC                            db 	$00,$01,$02,$03,$05,$08,$0B,$0E,$11,$15,$19,$1D,$21,$26,$2B,$2F,$2F,$2B,$26,$21,$1D,$19,$15,$11,$0E,$0B,$08,$05,$03,$02,$01,$00		      ; depth 	B
     154.  00:55CC  00 01 02 03 05 08 0B 0E 11 15 19 1D 21 26 2B 2F 
     154.  00:55DC  2F 2B 26 21 1D 19 15 11 0E 0B 08 05 03 02 01 00 
     155.  00:55EC                            db 	$01,$01,$03,$05,$07,$0B,$0E,$12,$17,$1C,$21,$27,$2D,$33,$39,$3F,$3F,$39,$33,$2D,$27,$21,$1C,$17,$12,$0E,$0B,$07,$05,$03,$01,$01		      ; depth 	C
     155.  00:55EC  01 01 03 05 07 0B 0E 12 17 1C 21 27 2D 33 39 3F 
     155.  00:55FC  3F 39 33 2D 27 21 1C 17 12 0E 0B 07 05 03 01 01 
     561   00:560C                      ;	include	"..\ttsfxplay\ttsfxplay.asm"
     562   00:560C                      
     563   00:560C                      	
     564   00:560C                      demo_song:
     565   00:560C                      	include	".\test.asm"
       1.  00:560C                      ; Song: TriloTracker v0.10.B1 SMS PSG+FM
       2.  00:560C                      ; By:   Richard Cornelisse      (c) 2020
       3.  00:560C                      
       4.  00:560C                      ; [ Song start data ]
       5.  00:560C  0C                  	db $0c					; Initial song speed.
       6.  00:560D  27 56               	dw .customvoice_start			; Start of the custom voices data.
       7.  00:560F  27 56               	dw .drummacro_start			; Start of the drum macro data.
       8.  00:5611  27 56               	dw .instrument_start			; Start of the instrument data.
       9.  00:5613                      
      10.  00:5613                      ; [ Song order pointer list ]
      11.  00:5613                      .restart:
      12.  00:5613                      	dw .track_168, .track_169, .track_170, .track_171, .track_172, .track_168, .track_168, .track_168	; Step:001 Pattern:021
      12.  00:5613  35 56 37 56 4D 56 6D 56 82 56 35 56 35 56 35 56 
      13.  00:5623  00 00 13 56         	dw 0x0000, .restart			; End of sequence delimiter + restart address.
      14.  00:5627                      
      15.  00:5627                      ; [ Custom FM voices ]
      16.  00:5627                      .customvoice_start:
      17.  00:5627                      
      18.  00:5627                      ; [ SCC Waveforms ]
      19.  00:5627                      .waveform_start:
      20.  00:5627                      
      21.  00:5627                      ; [ FM Drum macros]
      22.  00:5627                      .drummacro_start:
      23.  00:5627                      
      24.  00:5627                      ; [ Instruments]
      25.  00:5627                      .instrument_start:
      26.  00:5627  2B 56               	dw .instrument_00				;                 
      27.  00:5629  30 56               	dw .instrument_01				;                 
      28.  00:562B                      
      29.  00:562B                      .instrument_00:					;                 
      30.  00:562B  10                  	db $10					; FM Hardware Voice 1
      31.  00:562C                      .rst_i00:
      32.  00:562C  29                  	db $29			; Info byte: 00101001
      33.  00:562D  0F                  	db $0f			; Volume _
      34.  00:562E  2C 56               	dw .rst_i00			; Loop address
      35.  00:5630                      .instrument_01:					;                 
      36.  00:5630  30                  	db $30					; FM Hardware Voice 3
      37.  00:5631                      .rst_i01:
      38.  00:5631  29                  	db $29			; Info byte: 00101001
      39.  00:5632  0F                  	db $0f			; Volume _
      40.  00:5633  31 56               	dw .rst_i01			; Loop address
      41.  00:5635                      
      42.  00:5635                      ; [ Song track data ]
      43.  00:5635                      .track_168:
      44.  00:5635  DB                  	db $db			;Wait 28
      45.  00:5636  BF                  	db $bf			;[End-Of-Track]
      46.  00:5637                      .track_169:
      47.  00:5637  24                  	db $24			;Note C-4
      48.  00:5638  6E                  	db $6e			;Volume 13
      49.  00:5639  71                  	db $71			;Instrument 0
      50.  00:563A  C1                  	db $c1			;Wait 2
      51.  00:563B  60                  	db $60			;Release 96
      52.  00:563C  C0                  	db $c0			;Wait 1
      53.  00:563D  24                  	db $24			;Note C-4
      54.  00:563E  6E                  	db $6e			;Volume 13
      55.  00:563F  C1                  	db $c1			;Wait 2
      56.  00:5640  60                  	db $60			;Release 96
      57.  00:5641  C0                  	db $c0			;Wait 1
      58.  00:5642  24                  	db $24			;Note C-4
      59.  00:5643  6E                  	db $6e			;Volume 13
      60.  00:5644  C1                  	db $c1			;Wait 2
      61.  00:5645  60                  	db $60			;Release 96
      62.  00:5646  C0                  	db $c0			;Wait 1
      63.  00:5647  24                  	db $24			;Note C-4
      64.  00:5648  6E                  	db $6e			;Volume 13
      65.  00:5649  C1                  	db $c1			;Wait 2
      66.  00:564A  60                  	db $60			;Release 96
      67.  00:564B  D0                  	db $d0			;Wait 17
      68.  00:564C  BF                  	db $bf			;[End-Of-Track]
      69.  00:564D                      .track_170:
      70.  00:564D  24                  	db $24			;Note C-4
      71.  00:564E  6E                  	db $6e			;Volume 13
      72.  00:564F  71                  	db $71			;Instrument 0
      73.  00:5650  9A 10               	db $9a,$10			;CMD Note delay
      74.  00:5652  C1                  	db $c1			;Wait 2
      75.  00:5653  60                  	db $60			;Release 96
      76.  00:5654  C0                  	db $c0			;Wait 1
      77.  00:5655  24                  	db $24			;Note C-4
      78.  00:5656  6E                  	db $6e			;Volume 13
      79.  00:5657  9A 10               	db $9a,$10			;CMD Note delay
      80.  00:5659  C1                  	db $c1			;Wait 2
      81.  00:565A  60                  	db $60			;Release 96
      82.  00:565B  C0                  	db $c0			;Wait 1
      83.  00:565C  24                  	db $24			;Note C-4
      84.  00:565D  6E                  	db $6e			;Volume 13
      85.  00:565E  9A 10               	db $9a,$10			;CMD Note delay
      86.  00:5660  C1                  	db $c1			;Wait 2
      87.  00:5661  60                  	db $60			;Release 96
      88.  00:5662  C0                  	db $c0			;Wait 1
      89.  00:5663  24                  	db $24			;Note C-4
      90.  00:5664  6E                  	db $6e			;Volume 13
      91.  00:5665  9A 10               	db $9a,$10			;CMD Note delay
      92.  00:5667  C1                  	db $c1			;Wait 2
      93.  00:5668  60                  	db $60			;Release 96
      94.  00:5669  C0                  	db $c0			;Wait 1
      95.  00:566A  60                  	db $60			;Release 96
      96.  00:566B  CF                  	db $cf			;Wait 16
      97.  00:566C  BF                  	db $bf			;[End-Of-Track]
      98.  00:566D                      .track_171:
      99.  00:566D  CC                  	db $cc			;Wait 13
     100.  00:566E  24                  	db $24			;Note C-4
     101.  00:566F  72                  	db $72			;Instrument 2
     102.  00:5670  C0                  	db $c0			;Wait 1
     103.  00:5671  60                  	db $60			;Release 96
     104.  00:5672  C1                  	db $c1			;Wait 2
     105.  00:5673  24                  	db $24			;Note C-4
     106.  00:5674  C0                  	db $c0			;Wait 1
     107.  00:5675  60                  	db $60			;Release 96
     108.  00:5676  C1                  	db $c1			;Wait 2
     109.  00:5677  24                  	db $24			;Note C-4
     110.  00:5678  C0                  	db $c0			;Wait 1
     111.  00:5679  60                  	db $60			;Release 96
     112.  00:567A  C1                  	db $c1			;Wait 2
     113.  00:567B  24                  	db $24			;Note C-4
     114.  00:567C  9A 03               	db $9a,$03			;CMD Note delay
     115.  00:567E  C0                  	db $c0			;Wait 1
     116.  00:567F  60                  	db $60			;Release 96
     117.  00:5680  C4                  	db $c4			;Wait 5
     118.  00:5681  BF                  	db $bf			;[End-Of-Track]
     119.  00:5682                      .track_172:
     120.  00:5682  CC                  	db $cc			;Wait 13
     121.  00:5683  24                  	db $24			;Note C-4
     122.  00:5684  72                  	db $72			;Instrument 2
     123.  00:5685  9A 03               	db $9a,$03			;CMD Note delay
     124.  00:5687  C0                  	db $c0			;Wait 1
     125.  00:5688  60                  	db $60			;Release 96
     126.  00:5689  C1                  	db $c1			;Wait 2
     127.  00:568A  24                  	db $24			;Note C-4
     128.  00:568B  9A 05               	db $9a,$05			;CMD Note delay
     129.  00:568D  C0                  	db $c0			;Wait 1
     130.  00:568E  60                  	db $60			;Release 96
     131.  00:568F  C1                  	db $c1			;Wait 2
     132.  00:5690  24                  	db $24			;Note C-4
     133.  00:5691  9A 0F               	db $9a,$0f			;CMD Note delay
     134.  00:5693  C0                  	db $c0			;Wait 1
     135.  00:5694  60                  	db $60			;Release 96
     136.  00:5695  C1                  	db $c1			;Wait 2
     137.  00:5696  24                  	db $24			;Note C-4
     138.  00:5697  9A 10               	db $9a,$10			;CMD Note delay
     139.  00:5699  C0                  	db $c0			;Wait 1
     140.  00:569A  60                  	db $60			;Release 96
     141.  00:569B  C4                  	db $c4			;Wait 5
     142.  00:569C  BF                  	db $bf			;[End-Of-Track]
     143.  00:569D                      
     566   00:569D                      	
     567   00:569D                      TEXT_Title:
     568   00:569D                      	db	"TriloTracker FM Re-player Debug info",0	
     568   00:569D  54 72 69 6C 6F 54 72 61 63 6B 65 72 20 46 4D 20 
     568   00:56AD  52 65 2D 70 6C 61 79 65 72 20 44 65 62 75 67 20 
     568   00:56BD  69 6E 66 6F 00 
     569   00:56C2                      TEXT_Step:
     570   00:56C2  53 74 65 70 3A 00   	db	"Step:",0	
     571   00:56C8                      TEXT_Header_Data:
     572   00:56C8                      	db	"C# Nt In FM Vl Cm Flags",0
     572   00:56C8  43 23 20 4E 74 20 49 6E 20 46 4D 20 56 6C 20 43 
     572   00:56D8  6D 20 46 6C 61 67 73 00 
     573   00:56E0                      TEXT_Register_Header:
     574   00:56E0                      	db 	"Tone Vl  Tone Vl  Nois Mx  Env  Sh",0
     574   00:56E0  54 6F 6E 65 20 56 6C 20 20 54 6F 6E 65 20 56 6C 
     574   00:56F0  20 20 4E 6F 69 73 20 4D 78 20 20 45 6E 76 20 20 
     574   00:5700  53 68 00 
     575   00:5703                      TEXT_Register_Drum:
     576   00:5703                      	db 	"Macr Drm Tone Vl",0	
     576   00:5703  4D 61 63 72 20 44 72 6D 20 54 6F 6E 65 20 56 6C 
     576   00:5713  00 
     577   00:5714                      TEXT_Legend_Data:
     578   00:5714                      	db	"Legend: Psg, Fm, Voice, Env, Keyon, Command, Active(note)",0
     578   00:5714  4C 65 67 65 6E 64 3A 20 50 73 67 2C 20 46 6D 2C 
     578   00:5724  20 56 6F 69 63 65 2C 20 45 6E 76 2C 20 4B 65 79 
     578   00:5734  6F 6E 2C 20 43 6F 6D 6D 61 6E 64 2C 20 41 63 74 
     578   00:5744  69 76 65 28 6E 6F 74 65 29 00 
     579   00:574E                      
     580   00:574E                      	
     581   00:574E                      	
     582   00:574E                      font_data:
     583   00:574E  (0800)              	incbin	".\fontpat.bin"
     584   00:5F4E                      
     585   00:5F4E                      ;	include ".\sfx.asm"
     586   00:5F4E                      	
     587   00:5F4E                      ;sfx_PSG_STREAMS:
     588   00:5F4E                      ;sfx_SCC_STREAMS:
     589   00:5F4E                      ;	dw	sfx1
     590   00:5F4E                      ;	dw	sfx2
     591   00:5F4E                      ;	dw	sfx3
     592   00:5F4E                      ;	dw	sfx4
     593   00:5F4E                      ;	dw	sfx5
     594   00:5F4E                      ;
     595   00:5F4E                      ;
     596   00:5F4E                      ;
     597   00:5F4E                      ;sfx1:
     598   00:5F4E                      ;	db	1,4*8
     599   00:5F4E                      ;	incbin	"..\ttsfxplay\sfx\menu1.afx"
     600   00:5F4E                      ;sfx2:
     601   00:5F4E                      ;	db	1,2*8
     602   00:5F4E                      ;	incbin	"..\ttsfxplay\sfx\menu2.afx"	
     603   00:5F4E                      ;sfx3:
     604   00:5F4E                      ;	db	1,3*8
     605   00:5F4E                      ;	incbin	"..\ttsfxplay\sfx\menu3.afx"
     606   00:5F4E                      ;sfx4:
     607   00:5F4E                      ;	db	1,5*8
     608   00:5F4E                      ;	incbin	"..\ttsfxplay\sfx\menu4.afx"
     609   00:5F4E                      ;sfx5:
     610   00:5F4E                      ;	db	1,6*8
     611   00:5F4E                      ;	incbin	"..\ttsfxplay\sfx\menu5.afx"
     612   00:5F4E                      ;
     613   00:5F4E                      	
     614   00:5F4E                      	
     615   00:5F4E  (C000)              	map	0xc000
     616   00:5F4E                      	include	"..\code\ttreplaySMSRAM.asm"
       1.  00:5F4E                      ;================================
       2.  00:5F4E                      ; The new replayer.
       3.  00:5F4E                      ;
       4.  00:5F4E                      ; Persistent RAM unswappable
       5.  00:5F4E                      ;
       6.  00:5F4E                      ;================================
       7.  00:5F4E                      
       8.  00:5F4E  (00:FFFFFFEF)       TRACK_Instrument		equ 0-17
       9.  00:5F4E  (00:FFFFFFF0)       TRACK_Command		equ 1-17
      10.  00:5F4E  (00:FFFFFFF1)       TRACK_MacroPointer	equ 2-17
      11.  00:5F4E  (00:FFFFFFF3)       TRACK_MacroStart		equ 4-17
      12.  00:5F4E  (00:FFFFFFF5)       TRACK_MacroRestart 	equ 6-17		; no longer needed
      13.  00:5F4E  (00:FFFFFFF6)       TRACK_Note			equ 7-17
      14.  00:5F4E  (00:FFFFFFF7)       TRACK_Volume		equ 8-17
      15.  00:5F4E  (00:FFFFFFF8)       TRACK_Voice			equ 9-17
      16.  00:5F4E  (00:FFFFFFF9)       TRACK_Flags			equ 10-17
      17.  00:5F4E                      	; 0 = note trigger
      18.  00:5F4E                      	; 1 = note active
      19.  00:5F4E                      	; 4 = morph active		;-< for SCC when 1 then waveform is following morph buffer
      20.  00:5F4E                      	; 3 = command trigger
      21.  00:5F4E                      	; 2 = envelope trigger
      22.  00:5F4E                      	; 5 = instrument trigger
      23.  00:5F4E                      	; 6 = waveform trigger
      24.  00:5F4E                      	; 7 = PSG/SCC
      25.  00:5F4E  (00:FFFFFFFA)       TRACK_empty			equ 11-17		; needed for pushing 0 at note start
      26.  00:5F4E  (00:FFFFFFFB)       TRACK_ToneAdd		equ 12-17		; reset after note set
      27.  00:5F4E  (00:FFFFFFFD)       TRACK_VolumeAdd		equ 14-17		; reset after note set
      28.  00:5F4E  (00:FFFFFFFE)       TRACK_Noise			equ 15-17	;[OBSOLETE]	; reset after note set
      29.  00:5F4E  (00:FFFFFFFF)       TRACK_cmd_VolumeAdd	equ 16-17		; reset after note set
      30.  00:5F4E  (00:0000)           TRACK_cmd_ToneSlideAdd	equ 17-17		; reset after note set
      31.  00:5F4E  (00:0002)           TRACK_cmd_ToneAdd		equ 19-17		; reset after note set
      32.  00:5F4E  (00:0004)           TRACK_cmd_detune		equ 21-17
      33.  00:5F4E  (00:0006)           TRACK_cmd_0			equ 23-17
      34.  00:5F4E  (00:0007)           TRACK_cmd_1			equ 24-17
      35.  00:5F4E  (00:0008)           TRACK_cmd_2			equ 25-17
      36.  00:5F4E  (00:0009)           TRACK_cmd_3			equ 26-17
      37.  00:5F4E  (00:000A)           TRACK_cmd_4_depth		equ 27-17
      38.  00:5F4E  (00:000C)           TRACK_cmd_4_step		equ 29-17
      39.  00:5F4E  (00:000D)           TRACK_cmd_NoteAdd		equ 30-17		;x reset after note set
      40.  00:5F4E  (00:000E)           TRACK_cmd_A			equ 31-17		
      41.  00:5F4E  (00:000F)           TRACK_cmd_B			equ 32-17		
      42.  00:5F4E  (00:0010)           TRACK_cmd_E			equ 33-17
      43.  00:5F4E  (00:0011)           TRACK_Timer			equ 34-17		; used for timing by all cmd's
      44.  00:5F4E  (00:0012)           TRACK_Step			equ 35-17		; only for VIBRATO???
      45.  00:5F4E  (00:0013)           TRACK_Delay			equ 36-17		; rows to wait till next data
      46.  00:5F4E                      ;TRACK_Retrig		equ 35-17		; rows to retrigger command
      47.  00:5F4E  (00:0014)           TRACK_prevDelay		equ 37-17
      48.  00:5F4E  (00:0015)           TRACK_cmd_A_add		equ 38-17		;<< Still in use???
      49.  00:5F4E                      
      50.  00:5F4E  (00:0027)           TRACK_REC_SIZE		equ 39
      51.  00:5F4E                      
      52.  00:5F4E                      
      53.  00:5F4E  (00:0000)           B_TRGNOT			equ 0			; note trigger
      54.  00:5F4E  (00:0001)           B_ACTNOT			equ 1			; note active
      55.  00:5F4E  (00:0002)           B_TRGENV			equ 2			; envelope trigger
      56.  00:5F4E  (00:0003)           B_TRGCMD			equ 3			; command active
      57.  00:5F4E  (00:0004)           B_KEYON			equ 4			; for fm note trigger
      58.  00:5F4E  (00:0005)           B_SUST			equ 5			; for fm note sustain
      59.  00:5F4E  (00:0006)           B_TRGVOI			equ 6			; custom voice trigger	
      60.  00:5F4E  (00:0007)           B_PSGFM			equ 7			; chip type (PSG or FM)	
      61.  00:5F4E                      
      62.  00:5F4E                      ;B_ACTMOR			equ 4			; morph active
      63.  00:5F4E                      ;B_TRGINS			equ 5			; instrument trigger
      64.  00:5F4E                      ;B_TRGWAV			equ 6			; waveform trigger
      65.  00:5F4E                      
      66.  00:5F4E                      
      67.  00:5F4E  (00:C000)           _SP_Storage			#2			; to store the SP
      68.  00:5F4E                      
      69.  00:5F4E  (00:C002)           replay_trigger		#1			; trigger byte.
      70.  00:5F4E  (00:C003)           replay_mainPSGvol		#2			; volume mixer for PSG SCC balance
      71.  00:5F4E  (00:C005)           replay_mainSCCvol		#2			; volume mixer for PSG SCC balance
      72.  00:5F4E                      ;replay_songbase:		#2			; pointer to song data
      73.  00:5F4E                      
      74.  00:5F4E                      ; Do not move these
      75.  00:5F4E  (00:C007)           replay_voicebase:		#2			; pointer to custom voice data
      76.  00:5F4E  (00:C009)           replay_drumbase:		#2			; pointer to drum macro data
      77.  00:5F4E  (00:C00B)           replay_insbase:		#2			; pointer to instrument data
      78.  00:5F4E  (00:C00D)           TRACK_pointer1		#2
      79.  00:5F4E  (00:C00F)           TRACK_pointer2		#2
      80.  00:5F4E  (00:C011)           TRACK_pointer3		#2
      81.  00:5F4E  (00:C013)           TRACK_pointer4		#2
      82.  00:5F4E  (00:C015)           TRACK_pointer5		#2
      83.  00:5F4E  (00:C017)           TRACK_pointer6		#2
      84.  00:5F4E  (00:C019)           TRACK_pointer7		#2
      85.  00:5F4E  (00:C01B)           TRACK_pointer8		#2
      86.  00:5F4E                      ; / Do not move above
      87.  00:5F4E                      
      88.  00:5F4E                      
      89.  00:5F4E                      
      90.  00:5F4E  (00:C01D)           replay_orderpointer:	#2			; pointer to the order track list pointers
      91.  00:5F4E                      
      92.  00:5F4E  (00:C01F)           replay_speed 		#1			; speed to replay (get from song)
      93.  00:5F4E  (00:C020)           replay_speed_subtimer 	#1			; counter for finer speed
      94.  00:5F4E  (00:C021)           replay_speed_timer 	#1 			; counter for speed
      95.  00:5F4E  (00:C022)           replay_mode 		#1			; Replayer status
      96.  00:5F4E                      ; mode 0  = no sound output
      97.  00:5F4E                      ; mode 1  = replay song 
      98.  00:5F4E  (00:C023)           replay_chan_setup		#1			; 0 = 2 psg+ 6 fm, 1 = 3psg + 5 fm
      99.  00:5F4E  (00:C024)           replay_arp_speed		#1			; arpeggio speed ( 0 = fast, $f = slowest)
     100.  00:5F4E  (00:C025)           replay_fade			#1			; Fade active (value = fade speed)
     101.  00:5F4E  (00:C026)           replay_fade_timer		#1			; Timer for fade
     102.  00:5F4E  (00:C027)           replay_fade_vol		#1			; fade volume to lower the channel volume.
     103.  00:5F4E                      
     104.  00:5F4E  (00:C028)           replay_previous_note	#1			; previous note played
     105.  00:5F4E  (00:C029)           replay_mainvol		#2			; the volume correction.
     106.  00:5F4E                      
     107.  00:5F4E  (00:C02B)           replay_vib_table		#2			; pointer to the vibrato table
     108.  00:5F4E                      ;replay_tonetable_PSG	#2			; ToneTable (affected by transpose);
     109.  00:5F4E                      ;replay_tonetable_FM	#2			; ToneTable (affected by transpose);
     110.  00:5F4E  (00:C02D)           replay_tonetable		#2			; Current tonetable to read from
     111.  00:5F4E                      
     112.  00:5F4E  (00:C02F)           equalization_freq:	#1	; vdp type for correct playback on 60hz 0=50Hx, >0=60Hz
     113.  00:5F4E  (00:C030)           equalization_cnt:		#1	; counter for correct playback on 60hz
     114.  00:5F4E  (00:C031)           equalization_flag:	#1	; flag indicating if only instruments need to be processed.
     115.  00:5F4E                      
     116.  00:5F4E                      
     117.  00:5F4E                      
     118.  00:5F4E  (00:C032)           TRACK_Chan1			#TRACK_REC_SIZE
     119.  00:5F4E  (00:C059)           TRACK_Chan2			#TRACK_REC_SIZE
     120.  00:5F4E  (00:C080)           TRACK_Chan3			#TRACK_REC_SIZE
     121.  00:5F4E  (00:C0A7)           TRACK_Chan4			#TRACK_REC_SIZE
     122.  00:5F4E  (00:C0CE)           TRACK_Chan5			#TRACK_REC_SIZE
     123.  00:5F4E  (00:C0F5)           TRACK_Chan6			#TRACK_REC_SIZE
     124.  00:5F4E  (00:C11C)           TRACK_Chan7			#TRACK_REC_SIZE
     125.  00:5F4E  (00:C143)           TRACK_Chan8			#TRACK_REC_SIZE
     126.  00:5F4E                      
     127.  00:5F4E                      
     128.  00:5F4E                      
     129.  00:5F4E                      ;--- AY SPECIFIC
     130.  00:5F4E  (00:C16A)           PSG_registers		#0 
     131.  00:5F4E  (00:C16A)           PSG_regToneA 		#2	; Tone A freq low (8bit)
     132.  00:5F4E                      					; Tone A freq high (4bit)
     133.  00:5F4E  (00:C16C)           PSG_regToneB 		#2	; Tone B freq low
     134.  00:5F4E                      					; Tone B freq high
     135.  00:5F4E  (00:C16E)           PSG_regToneC 		#2	; Tone C freq low
     136.  00:5F4E                      					; Tone C freq high
     137.  00:5F4E  (00:C170)           PSG_regNOISE 		#1	; Noise freq (5bit)
     138.  00:5F4E  (00:C171)           PSG_regMIXER 		#1	;0x38	;x3f	; Mixer control (1 = off, 0 = on)
     139.  00:5F4E  (00:C172)           PSG_regVOLA 			#1	; Chan A volume
     140.  00:5F4E  (00:C173)           PSG_regVOLB 			#1	; Chan B volume
     141.  00:5F4E  (00:C174)           PSG_regVOLC  		#1	; Chan C volume
     142.  00:5F4E  (00:C175)           PSG_regVOLN			#1
     143.  00:5F4E  (00:C176)           PSG_regNOISEold		#1
     144.  00:5F4E  (00:C177)           GG_panning			#1
     145.  00:5F4E                      ;PSG_regEnvL 			#1	; Volume Env Freq low (8bit)	
     146.  00:5F4E                      ;PSG_regEnvH 			#1	; Volume Env Freq high (4bit)
     147.  00:5F4E                      ;PSG_regEnvShape 		#1	; Volume Env Shape (4bit)
     148.  00:5F4E                      
     149.  00:5F4E                      ;--- SCC SPECIFIC
     150.  00:5F4E                      ;
     151.  00:5F4E                      ;_0x9800:	#32			; Waveform data
     152.  00:5F4E                      ;_0x9820:	#32
     153.  00:5F4E                      ;_0x9840:	#32
     154.  00:5F4E                      ;_0x9860:	#32
     155.  00:5F4E                      
     156.  00:5F4E  (00:C178)           FM_Registers: 	#0	; contains the registers values to write and value previously written
     157.  00:5F4E  (00:C178)           FM_regToneA 	#2	; Tone A freq low (8bit)			; Tone A freq high (1bit)
     158.  00:5F4E  (00:C17A)           FM_regToneAb 	#2	; Tone A freq low (8bit)			; Tone A freq high (1bit)
     159.  00:5F4E  (00:C17C)           FM_regVOLA		#1	; Chan A volume
     160.  00:5F4E  (00:C17D)           FM_regVOLAb		#1	; Chan A volume
     161.  00:5F4E  (00:C17E)           FM_regToneB 	#2	; Tone B freq low					; Tone B freq high
     162.  00:5F4E  (00:C180)           FM_regToneBb 	#2	; Tone B freq low					; Tone B freq high
     163.  00:5F4E  (00:C182)           FM_regVOLB		#1	; Chan B volume
     164.  00:5F4E  (00:C183)           FM_regVOLBb		#1	; Chan B volume
     165.  00:5F4E  (00:C184)           FM_regToneC 	#2	; Tone C freq low					; Tone C freq high
     166.  00:5F4E  (00:C186)           FM_regToneCb 	#2	; Tone C freq low					; Tone C freq high
     167.  00:5F4E  (00:C188)           FM_regVOLC	 	#1	; Chan C volume
     168.  00:5F4E  (00:C189)           FM_regVOLCb	 	#1	; Chan C volume
     169.  00:5F4E  (00:C18A)           FM_regToneD 	#2	; Tone D freq low					; Tone D freq high
     170.  00:5F4E  (00:C18C)           FM_regToneDb 	#2	; Tone D freq low					; Tone D freq high
     171.  00:5F4E  (00:C18E)           FM_regVOLD		#1	; Chan D volume
     172.  00:5F4E  (00:C18F)           FM_regVOLDb		#1	; Chan D volume
     173.  00:5F4E  (00:C190)           FM_regToneE 	#2	; Tone E freq low					; Tone E freq high
     174.  00:5F4E  (00:C192)           FM_regToneEb 	#2	; Tone E freq low					; Tone E freq high
     175.  00:5F4E  (00:C194)           FM_regVOLE	  	#1	; Chan E volume
     176.  00:5F4E  (00:C195)           FM_regVOLEb	  	#1	; Chan E volume
     177.  00:5F4E  (00:C196)           FM_regToneF 	#2	; Tone E freq low					; Tone F freq high
     178.  00:5F4E  (00:C198)           FM_regToneFb 	#2	; Tone E freq low					; Tone F freq high
     179.  00:5F4E  (00:C19A)           FM_regVOLF	  	#1	; Chan F volume
     180.  00:5F4E  (00:C19B)           FM_regVOLFb	  	#1	; Chan F volume
     181.  00:5F4E                      
     182.  00:5F4E  (00:C19C)           DRUM_regToneBD	#2
     183.  00:5F4E  (00:C19E)           DRUM_regToneBDb	#2
     184.  00:5F4E  (00:C1A0)           DRUM_regVolBD	#1
     185.  00:5F4E  (00:C1A1)           DRUM_regVolBDb	#1
     186.  00:5F4E  (00:C1A2)           DRUM_regToneSH	#2
     187.  00:5F4E  (00:C1A4)           DRUM_regToneSHb	#2
     188.  00:5F4E  (00:C1A6)           DRUM_regVolSH	#1
     189.  00:5F4E  (00:C1A7)           DRUM_regVolSHb	#1
     190.  00:5F4E  (00:C1A8)           DRUM_regToneCT	#2
     191.  00:5F4E  (00:C1AA)           DRUM_regToneCTb	#2
     192.  00:5F4E  (00:C1AC)           DRUM_regVolCT	#1
     193.  00:5F4E  (00:C1AD)           DRUM_regVolCTb	#1
     194.  00:5F4E  (00:C1AE)           FM_DRUM		#1	; Percussion bits
     195.  00:5F4E  (00:C1AF)           FM_DRUM_Flags		#1	; 7, percusion, 6,4,2 = tone update, 5,3,1 = vol update
     196.  00:5F4E  (00:C1B0)           FM_freqreg1			#2	; Base drum
     197.  00:5F4E  (00:C1B2)           FM_volreg1			#1	; Drum (low)
     198.  00:5F4E  (00:C1B3)           FM_freqreg2			#2	; Snare + HiHat
     199.  00:5F4E  (00:C1B5)           FM_volreg2			#1	; Snare(low) Hihat(High)
     200.  00:5F4E  (00:C1B6)           FM_freqreg3			#2	; Cymbal + TomTom
     201.  00:5F4E  (00:C1B8)           FM_volreg3			#1	; Cymbal(low) TomTom (High)
     202.  00:5F4E                      
     203.  00:5F4E  (00:C1B9)           FM_DRUM_LEN			#1	; Length of drum macro
     204.  00:5F4E  (00:C1BA)           FM_DRUM_MACRO		#2	; Pointer to drum macro data
     205.  00:5F4E                      
     206.  00:5F4E  (00:C1BC)           FM_softvoice_req		#1	; Software voice requested
     207.  00:5F4E  (00:C1BD)           FM_softvoice_set 		#1	; Software voice currently loaded
     208.  00:5F4E                      
     209.  00:5F4E                      
     210.  00:5F4E                      ; DEze lijkt niet meer nodig
     211.  00:5F4E  (00:C1BE)           FM_regMIXER 		#1	; x3f	; Mixer control (1 = off, 0 = on)
     212.  00:5F4E                      
     213.  00:5F4E                      
     214.  00:5F4E                      
     215.  00:5F4E                      
     216.  00:5F4E                      ;/// see to remove this.
     217.  00:5F4E                      ;-- SCC registers
     218.  00:5F4E  (00:C1BF)           oldregs:	#(32*4)+(3*5)+1		; a way to int the SCC
     219.  00:5F4E                      
     220.  00:5F4E                      
     617   00:5F4E                      	
     618   00:5F4E                      
     619   00:5F4E  (00:C24F)           debug_pointer1:	#2
     620   00:5F4E  (00:C251)           debug_pointer2:	#2	
     621   00:5F4E  (00:C253)           debug_pnt:		#8*80
     622   00:5F4E  (00:C4D3)           TEXT_Chan		#40
     623   00:5F4E                      
     624   00:5F4E                      	
     625   00:5F4E                      ;	include	"..\ttsfxplay\ttsfxplay_RAM.asm"
     626   00:5F4E  (00:C4FB)           pattern	#1

    LABELS
-------------------------------------------------
00:00004010   initmain
00:000040B2   infinite
00:000040D2   isr
00:000040F6   write_debug
00:00004103   _wd_loop
00:0000410C   clear_debug
00:0000411A   debuginfo
00:00004123   debuginfo.loop
00:00004165   step_debug
00:00004190   register_debug
00:000041CA   register_debug_loop
00:000041F1   REG_list
00:0000422D   clear_TEXT
00:00004239   debug_flags
00:000042A4   init_vdp
00:00000082   _UPLEFT
00:00000081   _HORIZONTAL
00:00000083   _UPRIGHT
00:00000080   _VERTICAL
00:00000087 X _VERTICAL_SMALL
00:00000086 X _VERTICAL_DOUBLE
00:0000008B X _VERTICAL_STEP
00:000000B0 X _ARROWLEFT
00:000000B1 X _ARROWRIGHT
00:000000AE X _LOOPSIGN
00:000000F1 X _TONE_OFF_SIGN
00:000000F2 X _TONE_ON_SIGN
00:000000F3 X _NOISE_OFF_SIGN
00:000000F4 X _NOISE_ON_SIGN
00:000000F5 X _ENV_OFF_SIGN
00:000000F6 X _ENV_ON_SIGN
00:000000BF X _CMD_SIGN
00:000000FE X _CURSOR
00:000000FC X MOUSE_CHR
00:00002000   _PNT
00:00002A00   _CNT
00:000042F0   clear_screen
00:00004305 X clear_cnt
00:0000431C X clear_files
00:00004337   draw_label
00:0000433F   draw_label_loop
00:00004349   draw_label_end
00:0000434B   draw_label_fast
00:0000435C X draw_fake_hex_sp
00:00004372 X draw_fake_hex_sp_small
00:0000437D X draw_hex_sp_small
00:00004385   draw_hex
00:00004387 X draw_fakehex
00:00004390   draw_hex_small
00:00004395   draw_hex2
00:000043A4 X conv_decimal
00:000043A5   draw_decimal
00:000043B2   _dd_Num1
00:000043B4   _dd_Num2
00:000043BC   draw_decimal3
00:000043C4 X draw_box
00:000043CE   draw_box_loop1
00:000043CF   draw_box_loop0
00:00004408   draw_box_end
00:0000440A X draw_colorbox
00:00004417   _dc_maskleft_loop
00:00004432   _dc_maskright_loop
00:00004455   _dc_start_loop
00:00004474   _cb_copyloop_main
00:00004499   _cb_copyloop
00:000044BA   _cp_clip_copy
00:000044DC X erase_colorbox
00:000044E9   _ecb_maskleft_loop
00:00004506   _ecb_maskright_loop
00:0000452B   _ecb_start_loop
00:0000454A   _ecb_copyloop_main
00:0000456F   _ecb_copyloop
00:00004590   _ecb_clip_copy
00:000045B2   set_vdpwrite
00:000045CF   set_vdpread
00:00000000   cb_maskleft
00:00000001   cb_maskright
00:00000002   cb_fullbytes
00:00000003 X cb_status
00:000045EA   init_font
00:000045F9   _fontloop
00:0000007C   FM_WRITE
00:0000007D   FM_DATA
00:00000060   _REL
00:00000061   _SUS
00:00000062   _VOL
00:00000071   _INS
00:00000090   _CMD
00:000000B8 X _SPC
00:000000BF   _EOT
00:000000C0   _WAIT
00:00004602   replay_init
00:0000461E   replay_pause
00:00004625 X _r_pause_enable
00:0000462B   _r_pause_disable
00:00004647   _r_pause_loop
00:0000464C X replay_fade_out
00:00004657   replay_set_FM_balance
00:0000465E   replay_set_PSG_balance
00:00004665   _getnewbalancebase
00:00004673   replay_loadsong
00:00004721   replay_play
00:0000472C X replay_play.NTSC
00:00004740   replay_play.PAL
00:00004757 X decode_data
00:0000475D X decode_data.decode1
00:0000477E   decode_data.decode2
00:000047A5   decode_data.decode3
00:000047C6   decode_data.decode4
00:000047E7   decode_data.decode5
00:00004808   decode_data.decode6
00:00004829   decode_data.decode7
00:0000484A   decode_data.decode8
00:0000486B   decode_data.decode_end
00:0000486B   process_data
00:000048BE X _rdd_3psg_5fm
00:000048ED   _rdd_2psg_6fm
00:00004922   _rdd_cont
00:000049C2   _rdd_cont.cont_fadeing
00:000049C8   _rdd_cont.no_new_step
00:000049DC   _rdd_cont.calc_vol
00:000049E2   _rdd_cont.no_carry
00:000049E7   _replay_check_patternend
00:00004A0B   _replay_check_patternend.no_restart
00:00004A19   decode_data_chan
00:00004A2D   _rdn2
00:00004A32   _rdv2
00:00004A37   _rdi2
00:00004A3F   _rdn
00:00004A47   _rdi
00:00004A4F   _rdv
00:00004A57   _rdc
00:00004A58   _rdc_noinc
00:00004A61   _rd_delay
00:00004A6A   _replay_decode_delay
00:00004A76   _replay_decode_trigger_porttone_check
00:00004A8E   _replay_decode_note
00:00004A9A   _replay_decode_release
00:00004AA5   _replay_decode_sustain
00:00004AB0   _replay_decode_ins
00:00004AC5   _replay_decode_ins.skip
00:00004AD5   _replay_decode_ins.skip_soft
00:00004AE4   _replay_decode_ins.skip_ins
00:00004AE9   _replay_decode_vol
00:00004AFE   _replaydecode_cmd
00:00004B12   _replaydecode_cmd.skip
00:00004B19   DECODE_CMDLIST
00:00004B47   decode_cmd0_arpeggio
00:00004B5A   decode_cmd1_port_up
00:00004B65   decode_cmd2_port_down
00:00004B70   decode_cmd3_port_tone
00:00004B8D   decode_cmd3_port_tone_new_note
00:00004B9E   decode_cmd3_port_tone_new_note.skip
00:00004BB6   decode_cmd3_port_tone_new_note.skip2
00:00004BD1   decode_cmd8_tremelo
00:00004BD1   decode_cmd4_vibrato
00:00004BE2   decode_cmd4_vibrato.depth
00:00004BFC   decode_cmd4_vibrato.end
00:00004C01   decode_cmd5_vibrato_port_tone
00:00004C18   decode_cmd6_vibrato_vol
00:00004C18   decode_cmd7_vol_slide
00:00004C28   decode_cmd9_note_cut
00:00004C33   decode_cmd10_note_delay
00:00004C51   decode_cmd11_command_end
00:00004C56   decode_cmd12_drum
00:00004C7C   decode_cmd13_arp_speed
00:00004C82   decode_cmd14_fine_up
00:00004C8C   decode_cmd15_fine_down
00:00004C99   decode_cmd16_notelink
00:00004CA1   decode_cmd17_track_detune
00:00004CB6   decode_cmd17_track_detune.pos
00:00004CC0   decode_cmd18_trigger
00:00004CC6   decode_cmd19_speed
00:00004CD9   decode_cmd20_tone_panning
00:00004CDC   decode_cmd21_noise_panning
00:00004CDF   decode_cmd22_chan_setup
00:00004CE2   process_data_chan
00:00004D0F   process_data_chan.skip
00:00004D14   process_commandEND
00:00004D14   process_note
00:00004D19 X process_triggerNote
00:00004D3D   process_noNoteTrigger
00:00004D5D   _vol_change
00:00004D64 X _vol_rel
00:00004D76   _vol_rel.skip
00:00004D77   _vol_base
00:00004D7A   _noVolumeChange
00:00004D8A   _noVolumeChange.skip2
00:00004D8A X _Vadd
00:00004D94   _Vadd.skip
00:00004D9E   _Vadd.skip2
00:00004DA3 X _noVolume
00:00004DB2   _noNoise
00:00004DCB   _noNoise.skip
00:00004DD2   _noNoiseVol
00:00004DE0   _noLink
00:00004DF6   _noLink.skip
00:00004DFD   process_noToneAdd
00:00004E06   process_noToneAdd.noend
00:00004E13   process_noToneBit
00:00004E23   process_noToneBit.skip
00:00004E46 X _wrap_highcheck
00:00004E6D   _wrap_lowcheck
00:00004E90   _wrap_skip
00:00004EA0   process_noNoteActive
00:00004EB3   PROCESS_CMDLIST
00:00004EC9   process_cmd0_arpeggio
00:00004EED   process_cmd0_arpeggio.nextNote
00:00004F3A   process_cmd1_port_up
00:00004F4E   process_cmd2_port_down
00:00004F62   process_cmd3_port_tone
00:00004F70 X process_cmd3_add
00:00004F78   process_cmd3_add.skip
00:00004F83   process_cmd3_sub
00:00004F98   process_cmd3_stop
00:00004FA3   process_cmd8_tremelo
00:00004FC9   process_cmd4_vibrato
00:00004FDF X process_cmd4_vibrato.neg
00:00004FF7   process_cmd4_vibrato.pos
00:00004FFE   process_cmd4_vibrato.zero
00:00005008   process_cmd5_vibrato_port_tone
00:0000500E   process_cmd6_vibrato_vol
00:00005014   process_cmd7_vol_slide
00:0000501A   process_cmdasub
00:0000502F X process_cmda_dec
00:00005037   process_cmda_inc
00:00005040   process_cmd9_note_cut
00:0000504D   process_cmd10_note_delay
00:00005060   replay_route
00:00005060 X route_SN
00:00005101 X route_gg
00:00005104 X route_FM
00:0000510E   route_FM.noVoice
00:00005118   route_FM.channel_loop
00:0000514B X _route_FM_drum_update
00:00005167   _route_FM_reg8_update
00:0000516C   _route_FM_reg16_update
00:0000516F   _rfr_cont
00:0000517D   _route_FM_keyOff_update
00:0000520C   _VOLUME_TABLE
00:0000530C   TRACK_ToneTable_PSG
00:000053CC   TRACK_ToneTable_FM
00:0000548C   TRACK_Vibrato_sine
00:0000560C   demo_song
00:00005613   demo_song.restart
00:00005627   demo_song.customvoice_start
00:00005627 X demo_song.waveform_start
00:00005627   demo_song.drummacro_start
00:00005627   demo_song.instrument_start
00:0000562B   demo_song.instrument_00
00:0000562C   demo_song.rst_i00
00:00005630   demo_song.instrument_01
00:00005631   demo_song.rst_i01
00:00005635   demo_song.track_168
00:00005637   demo_song.track_169
00:0000564D   demo_song.track_170
00:0000566D   demo_song.track_171
00:00005682   demo_song.track_172
00:0000569D   TEXT_Title
00:000056C2   TEXT_Step
00:000056C8   TEXT_Header_Data
00:000056E0   TEXT_Register_Header
00:00005703   TEXT_Register_Drum
00:00005714   TEXT_Legend_Data
00:0000574E   font_data
00:FFFFFFEF   TRACK_Instrument
00:FFFFFFF0   TRACK_Command
00:FFFFFFF1   TRACK_MacroPointer
00:FFFFFFF3   TRACK_MacroStart
00:FFFFFFF5 X TRACK_MacroRestart
00:FFFFFFF6   TRACK_Note
00:FFFFFFF7   TRACK_Volume
00:FFFFFFF8   TRACK_Voice
00:FFFFFFF9   TRACK_Flags
00:FFFFFFFA X TRACK_empty
00:FFFFFFFB   TRACK_ToneAdd
00:FFFFFFFD   TRACK_VolumeAdd
00:FFFFFFFE X TRACK_Noise
00:FFFFFFFF   TRACK_cmd_VolumeAdd
00:00000000   TRACK_cmd_ToneSlideAdd
00:00000002   TRACK_cmd_ToneAdd
00:00000004   TRACK_cmd_detune
00:00000006   TRACK_cmd_0
00:00000007   TRACK_cmd_1
00:00000008   TRACK_cmd_2
00:00000009   TRACK_cmd_3
00:0000000A   TRACK_cmd_4_depth
00:0000000C   TRACK_cmd_4_step
00:0000000D   TRACK_cmd_NoteAdd
00:0000000E   TRACK_cmd_A
00:0000000F X TRACK_cmd_B
00:00000010   TRACK_cmd_E
00:00000011   TRACK_Timer
00:00000012   TRACK_Step
00:00000013   TRACK_Delay
00:00000014   TRACK_prevDelay
00:00000015 X TRACK_cmd_A_add
00:00000027   TRACK_REC_SIZE
00:00000000   B_TRGNOT
00:00000001   B_ACTNOT
00:00000002 X B_TRGENV
00:00000003   B_TRGCMD
00:00000004   B_KEYON
00:00000005   B_SUST
00:00000006   B_TRGVOI
00:00000007   B_PSGFM
00:0000C000   _SP_Storage
00:0000C002   replay_trigger
00:0000C003   replay_mainPSGvol
00:0000C005   replay_mainSCCvol
00:0000C007   replay_voicebase
00:0000C009   replay_drumbase
00:0000C00B   replay_insbase
00:0000C00D   TRACK_pointer1
00:0000C00F   TRACK_pointer2
00:0000C011   TRACK_pointer3
00:0000C013   TRACK_pointer4
00:0000C015   TRACK_pointer5
00:0000C017   TRACK_pointer6
00:0000C019   TRACK_pointer7
00:0000C01B   TRACK_pointer8
00:0000C01D   replay_orderpointer
00:0000C01F   replay_speed
00:0000C020   replay_speed_subtimer
00:0000C021   replay_speed_timer
00:0000C022   replay_mode
00:0000C023   replay_chan_setup
00:0000C024   replay_arp_speed
00:0000C025   replay_fade
00:0000C026   replay_fade_timer
00:0000C027   replay_fade_vol
00:0000C028   replay_previous_note
00:0000C029   replay_mainvol
00:0000C02B X replay_vib_table
00:0000C02D   replay_tonetable
00:0000C02F   equalization_freq
00:0000C030   equalization_cnt
00:0000C031   equalization_flag
00:0000C032   TRACK_Chan1
00:0000C059   TRACK_Chan2
00:0000C080   TRACK_Chan3
00:0000C0A7   TRACK_Chan4
00:0000C0CE   TRACK_Chan5
00:0000C0F5   TRACK_Chan6
00:0000C11C   TRACK_Chan7
00:0000C143   TRACK_Chan8
00:0000C16A X PSG_registers
00:0000C16A   PSG_regToneA
00:0000C16C   PSG_regToneB
00:0000C16E   PSG_regToneC
00:0000C170   PSG_regNOISE
00:0000C171   PSG_regMIXER
00:0000C172   PSG_regVOLA
00:0000C173   PSG_regVOLB
00:0000C174   PSG_regVOLC
00:0000C175   PSG_regVOLN
00:0000C176   PSG_regNOISEold
00:0000C177   GG_panning
00:0000C178   FM_Registers
00:0000C178   FM_regToneA
00:0000C17A X FM_regToneAb
00:0000C17C   FM_regVOLA
00:0000C17D X FM_regVOLAb
00:0000C17E   FM_regToneB
00:0000C180 X FM_regToneBb
00:0000C182   FM_regVOLB
00:0000C183 X FM_regVOLBb
00:0000C184   FM_regToneC
00:0000C186 X FM_regToneCb
00:0000C188   FM_regVOLC
00:0000C189 X FM_regVOLCb
00:0000C18A   FM_regToneD
00:0000C18C X FM_regToneDb
00:0000C18E   FM_regVOLD
00:0000C18F X FM_regVOLDb
00:0000C190   FM_regToneE
00:0000C192 X FM_regToneEb
00:0000C194   FM_regVOLE
00:0000C195 X FM_regVOLEb
00:0000C196   FM_regToneF
00:0000C198 X FM_regToneFb
00:0000C19A   FM_regVOLF
00:0000C19B X FM_regVOLFb
00:0000C19C X DRUM_regToneBD
00:0000C19E X DRUM_regToneBDb
00:0000C1A0 X DRUM_regVolBD
00:0000C1A1 X DRUM_regVolBDb
00:0000C1A2 X DRUM_regToneSH
00:0000C1A4 X DRUM_regToneSHb
00:0000C1A6 X DRUM_regVolSH
00:0000C1A7 X DRUM_regVolSHb
00:0000C1A8 X DRUM_regToneCT
00:0000C1AA X DRUM_regToneCTb
00:0000C1AC X DRUM_regVolCT
00:0000C1AD X DRUM_regVolCTb
00:0000C1AE   FM_DRUM
00:0000C1AF X FM_DRUM_Flags
00:0000C1B0   FM_freqreg1
00:0000C1B2   FM_volreg1
00:0000C1B3   FM_freqreg2
00:0000C1B5   FM_volreg2
00:0000C1B6   FM_freqreg3
00:0000C1B8   FM_volreg3
00:0000C1B9   FM_DRUM_LEN
00:0000C1BA   FM_DRUM_MACRO
00:0000C1BC   FM_softvoice_req
00:0000C1BD   FM_softvoice_set
00:0000C1BE   FM_regMIXER
00:0000C1BF X oldregs
00:0000C24F   debug_pointer1
00:0000C251 X debug_pointer2
00:0000C253   debug_pnt
00:0000C4D3   TEXT_Chan
00:0000C4FB   pattern


 Output: main.rom
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: 00008000  Used: 00001F4E

   Address   Length Align   Label
   00004000    8014         initmain
   00005F4E   24754       <empty>
